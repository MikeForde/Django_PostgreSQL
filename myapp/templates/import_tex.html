{# templates/import_tex.html #}
{% extends "base.html" %}

{% block title %}Templates | TT-Mick-P{% endblock %}
{% block content %}

<form method="post" enctype="multipart/form-data" style="display:flex; align-items:center;">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Render</button>
</form>

{% if controls %}
<form method="post" action="{% url 'submit_tex_form' %}">
  {% csrf_token %}
  <div style="display:flex; align-items:flex-start; gap:16px;">

  {# Canvas (left) #}
  <div
    style="position:relative; flex:0 0 auto; border:1px solid #ccc; width:{{ canvas.width }}px; height:{{ canvas.height }}px; font-family:sans-serif, 'MS Sans Serif', Tahoma, Arial; font-size:10.5px; line-height:1.2; background:#fff;">

    {% for c in controls %}
    {% if c.props.Visible != 'False' %}
    <div class="ctrl readcode-host"
         data-readcodes="{{ c.hover_codes|default:''|escapejs }}"
         style="position:absolute; left:{{ c.x }}px; top:{{ c.y }}px; width:{{ c.width|add:6 }}px; height:{{ c.height }}px; overflow:visible;">

      {# Labels #}
      {% if 'Label' in c.type %}
        <label style="display:block; width:{{ c.width|add:10 }}px;
                      {% if c.font_name %}font-family:{% if ' ' in c.font_name %}'{{ c.font_name }}'{% else %}{{ c.font_name }}{% endif %}, sans-serif;{% endif %}
                      {% if c.font_size_pt %}font-size:{{ c.font_size_pt }}pt;{% endif %}
                      {% if c.font_color %}color:{{ c.font_color }};{% endif %}
                      font-weight:{% if c.is_bold %}700{% else %}400{% endif %};">
          {{ c.caption|default:c.name }}
        </label>

      {# Buttons #}
      {% elif 'Button' in c.type %}
        <button type="button" name="{{ c.name }}" tabindex="{{ c.props.TabOrder|default:'0' }}" style="font-size: 9px;">
          {{ c.caption|default:c.name }}
        </button>

      {# Read lists (your existing branches) #}
      {% elif 'ReadList' in c.type %}
        <div class="rl-wrap" style="white-space:normal;">
          {% if c.caption and not c.rl_minimised %}
            <div style="font-weight:600; margin-bottom:-1px;">{{ c.caption }}</div>
          {% endif %}
          {% if c.rl_minimised and c.rl_multi %}
            <div class="ms" id="ms_{{ c.name }}" style="position:relative; display:inline-block; min-width:140px;">
              <button type="button" class="ms-btn" aria-haspopup="listbox" aria-expanded="false"
                      style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%; min-width:140px; padding:0px 6px; border:1px solid #888; background:#fff; cursor:pointer; font-size: 10.5px;">
                <span class="ms-label">{{ c.caption|default:"Selettct…" }}</span><span aria-hidden="true">▾</span>
              </button>
              <div class="ms-panel"
                   style="position:absolute; top:100%; left:0; z-index:1000; display:none; border:1px solid #888; background:#fff; max-height:180px; overflow:auto; min-width:220px; padding:6px; box-shadow:0 2px 6px rgba(0,0,0,.15);">
                {% for opt in c.options %}
                  <label style="display:block; white-space:nowrap;">
                    <input type="checkbox" name="{{ c.name }}[]"
                           value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                    {{ opt.label }}
                  </label>
                {% endfor %}
              </div>
            </div>
          {% elif c.rl_minimised %}
            <select name="{{ c.name }}" id="{{ c.name }}" size="1" tabindex="{{ c.props.TabOrder|default:'0' }}" style="min-width:140px; font-size: 10.5px;">
              <option value="" selected disabled hidden>{{ c.caption|default:"Select…" }}</option>
              {% for opt in c.options %}
                <option value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                  {{ opt.label }}
                </option>
              {% endfor %}
            </select>
          {% else %}
            <select name="{{ c.name }}{% if c.rl_multi %}[]{% endif %}" id="{{ c.name }}" {% if c.rl_multi %}multiple{% endif %}
                    size="{{ c.rl_size|default:5 }}" tabindex="{{ c.props.TabOrder|default:'0' }}" style="min-width:120px; font-size: 10.5px;">
              {% for opt in c.options %}
                <option value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                  {{ opt.label }}
                </option>
              {% endfor %}
            </select>
          {% endif %}

          {% if c.rl_date_prompt %}
            <div style="margin-top:6px;">
              <label for="{{ c.name }}_date" style="margin-right:6px;">Date:</label>
              <input id="{{ c.name }}_date" name="{{ c.name }}_date" type="date" tabindex="{{ c.props.TabOrder|default:'0' }}">
            </div>
          {% endif %}
        </div>

      {# ReadCode: for TEmisReadCode and TEmisQuestionReadCode #}
      {% elif 'ReadCode' in c.type %}
      <div class="rc-row readcode-host"
        data-readcodes="{{ c.rc_code|default:'' }} — {{ c.rc_term|default:'' }}{% if c.rc_is_question and c.rc_has_negation %}\nNegation-{{ c.rc_code }} — Not - {{c.rc_term}}{% endif %}"
        style="white-space:nowrap;">


        {# Full prompt label #}
        <label for="{{ c.name }}_yes" style="display:inline; margin-right:4px;">
          {{ c.rc_prompt }}
        </label>

        {% if c.rc_is_question and c.rc_has_negation %}
          {# Yes checkbox (records original readcode) #}
          <label style="margin-left:0px; margin-right:0px;">
            <input id="{{ c.name }}_yes"
                  class="rc-yesno"
                  data-pair="{{ c.name }}_no"
                  name="{{ c.name }}_checked_yes"
                  type="checkbox"
                  value="{{ c.rc_code|default:'' }}"
                  tabindex="{{ c.props.TabOrder|default:'0' }}"
                  style="vertical-align:middle; margin-right:0px;">
          </label>

          {# No checkbox (records Negation-<readcode>) #}
          <label style="margin-right:0px;">
            no
            <input id="{{ c.name }}_no"
                  class="rc-yesno"
                  data-pair="{{ c.name }}_yes"
                  name="{{ c.name }}_checked_no"
                  type="checkbox"
                  value="{% if c.rc_code %}{{ c.rc_neg_prefix }}{{ c.rc_code }}{% endif %}"
                  tabindex="{{ c.props.TabOrder|default:'0' }}"
                  style="vertical-align:middle; margin-right:0px;">
          </label>

          {% if c.rc_has_text %}
            <input id="{{ c.name }}_text"
                  name="{{ c.name }}_text"
                  type="text"
                  {% if c.rc_required %}required{% endif %}
                  disabled
                  style="width:100px; vertical-align:middle;">
          {% endif %}

        {% else %}
          {# Simple ReadCode: single checkbox (unchanged) #}
          <input id="{{ c.name }}_chk"
            class="rc-chk"
            data-targets="{% if c.rc_has_text %}{{ c.name }}_text{% endif %}{% if c.rc_has_value %}{% if c.rc_has_text %},{% endif %}{{ c.name }}_val{% endif %}{% if c.rc_has_datepicker %}{% if c.rc_has_text or c.rc_has_value %},{% endif %}{{ c.name }}_date{% endif %}"
            name="{{ c.name }}_checked"
            type="checkbox"
            tabindex="{{ c.props.TabOrder|default:'0' }}"
            style="margin-right:8px; vertical-align:middle;">

          {% if c.rc_has_text %}
            <input id="{{ c.name }}_text"
                  name="{{ c.name }}_text"
                  type="text"
                  {% if c.rc_required %}required{% endif %}
                  disabled
                  style="width:100px; vertical-align:middle;">
          {% endif %}
        {% endif %}

        {% if c.rc_has_value %}
        <input id="{{ c.name }}_val"
              name="{{ c.name }}_val"
              type="text"
              inputmode="decimal"
              disabled
              style="width:20px; vertical-align:middle; margin-left:{% if c.rc_has_text %}4{% else %}0{% endif %}px;">
        {% if c.rc_value_unit %}<span style="margin-left:4px;">{{ c.rc_value_unit }}</span>{% endif %}
        {% endif %}

        {# Date picker (if applicable) #}
        {% if c.rc_has_datepicker %}
        <input id="{{ c.name }}_date"
              name="{{ c.name }}_date"
              type="date"
              disabled
              tabindex="{{ c.props.TabOrder|default:'0' }}"
              style="vertical-align:middle; margin-left:0px; width: 2px; font-size: 10.5px;">
        {% endif %}

        {# Hidden input to carry the readcode itself #}

        {% if c.rc_code %}
          <input type="hidden" name="{{ c.name }}_readcode" value="{{ c.rc_code }}">
        {% endif %}
      </div>



      {# DiaryEntry (unchanged) #}
      {% elif 'DiaryEntry' in c.type %}
        {# ... your existing DiaryEntry branch exactly as-is ... #}
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:nowrap; white-space:nowrap; width:100%;">
          <label for="{{ c.name }}_date" style="font-weight:600; margin-right:6px; white-space:nowrap;">
            {{ c.diary_prompt }}
          </label>
          <input id="{{ c.name }}_date" name="{{ c.name }}_date" type="date" tabindex="{{ c.props.TabOrder|default:'0' }}" style="vertical-align:middle; font-size: 10.5px;">
          {% if c.diary_editbox and not c.diary_prompt_below %}
            <input id="{{ c.name }}_text" name="{{ c.name }}_text" type="text" tabindex="{{ c.props.TabOrder|default:'0' }}"
                   {% if c.diary_editbox_chars %} style="width: {{ c.diary_editbox_chars }}ch;" {% else %} style="width: 24ch;" {% endif %}>
          {% endif %}
        </div>
        {% if c.diary_editbox and c.diary_prompt_below %}
          <div style="margin-top:4px;">
            <input id="{{ c.name }}_text" name="{{ c.name }}_text" type="text" tabindex="{{ c.props.TabOrder|default:'0' }}"
                   {% if c.diary_editbox_chars %} style="width: {{ c.diary_editbox_chars }}ch;" {% else %} style="width: 24ch;" {% endif %}>
          </div>
        {% endif %}
        {% if c.diary_readcode %}
          <input type="hidden" name="{{ c.name }}_readcode" value="{{ c.diary_readcode }}">
        {% endif %}

      {# TTplLastEntry: read-only date, no label, optional tooltip of its read code #}
      {% elif 'LastEntry' in c.type or c.is_lastentry %}
      <input
        type="date"
        class="tpl-lastentry readcode-host"
        {% if c.le_code or c.le_term %}
          data-readcodes="Last Entry for {{ c.le_code|default:'' }}{% if c.le_term %} — {{ c.le_term }}{% endif %}"
          title="{{ c.le_code|default:'' }}{% if c.le_term %} — {{ c.le_term }}{% endif %}"
        {% endif %}
        disabled
        style="width: 150px; font-size: 10.5px;">
      
      {% elif 'Panel' in c.type %}

      {% elif 'Bevel' in c.type %}

      {% elif 'FORM' in c.type %}

      {% elif 'Group' in c.type %}

      {% elif 'Btn' in c.type %}
        <button type="button" name="{{ c.name }}" tabindex="{{ c.props.TabOrder|default:'0' }}" style="font-size: 9px;">
          Prev Data
        </button>

      {# TTplAvgBP: fixed read-only average blood pressure #}
      {% elif 'AvgBP' in c.type %}
      <span class="tpl-avgbp" style="font-size: 10.5px;">
        125/85
      </span>

      {# --- TTplIdealWeight ---------------------------------------------------- #}
      {% elif 'IdealWeight' in c.type %}
      <div class="rc-row readcode-host" style="white-space:nowrap;" data-readcodes="??? — Ideal Weight">
        <label for="{{ c.name }}_chk" style="margin-right:4px;">Ideal Weight</label>
        <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
              tabindex="{{ c.props.TabOrder|default:'0' }}"
              style="margin-right:0px; vertical-align:middle;">
        <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
              readonly style="width:20px; vertical-align:middle;">
        <span style="margin-left:2px;">kg</span>
      </div>

      {# --- TTplBMI ------------------------------------------------------------ #}
      {% elif 'BMI' in c.type %}
      <div class="rc-row readcode-host" style="white-space:nowrap;" data-readcodes="?? — Body Mass Index">
        <label for="{{ c.name }}_chk" style="margin-right:4px;">BMI</label>
        <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
              tabindex="{{ c.props.TabOrder|default:'0' }}"
              style="margin-right:0px; vertical-align:middle;">
        <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
              readonly style="width:25px; vertical-align:middle;">
        <span style="margin-left:2px;">kg/m²</span>
      </div>

      {# --- TTplExpPeakFlow ---------------------------------------------------- #}
      {% elif 'ExpPeakFlow' in c.type %}
      <div class="rc-row readcode-host" style="white-space:nowrap;" data-readcodes="??? — Expected PEFR">
        <label for="{{ c.name }}_chk" style="margin-right:6px;">Predicted PEFR</label>
        <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
              tabindex="{{ c.props.TabOrder|default:'0' }}"
              style="margin-right:8px; vertical-align:middle;">
        <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
              readonly style="width:25px; vertical-align:middle;">
        <span style="margin-left:2px;">L/min</span>
      </div>

      {# import_tex.html #}
      {% elif 'PULHHEEMS' in c.type %}
        <div class="pulhheems-widget"
            style="position:relative; left:0; top:0; width:100%; height:100%; box-sizing:border-box; padding:10px;margin-top:5px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; height:100%;">
            {# LEFT SIDE #}
            <div class="pul-left" style="display:grid; grid-auto-rows:min-content; row-gap:8px;">

              <div class="row readcode-host" style="display:grid; grid-template-columns: 80px 40px 20px auto; align-items:center; gap:6px;margin-top:7px;" 
                  data-readcodes="RAFPUP01 — P0\u000ARAFPUP02 — P0R\u000ARAFPUP21 — P2\u000ARAFPUP22 — P2R\u000ARAFPUP31 — P3\u000ARAFPUP32 — P3R\u000ARAFPUP41 — P4\u000ARAFPUP42 — P4R\u000ARAFPUP71 — P7\u000ARAFPUP72 — P7R\u000ARAFPUP81 — P8\u000ARAFPUP82 — P8R">
                <label>Physical</label>
                <select name="{{ c.name }}_physical" style="width:40px;">
                  <option>2</option><option>3</option>
                  <option>4</option><option>7</option><option>8</option><option>0</option>
                </select>
                <input type="checkbox" name="{{ c.name }}_physical_remedial">
                <label>Remedial</label>
              </div>

              <div class="row readcode-host"
                style="display:grid; grid-template-columns: 80px 40px 20px auto; align-items:center; gap:6px; margin-top:7px;"
                data-readcodes="RAFPUU01 — U0\u000ARAFPUU02 — U0R\u000ARAFPUU21 — U2\u000ARAFPUU22 — U2R\u000ARAFPUU31 — U3\u000ARAFPUU32 — U3R\u000ARAFPUU71 — U7\u000ARAFPUU72 — U7R\u000ARAFPUU81 — U8\u000ARAFPUU82 — U8R">
                <label>Upper Limbs</label>
                <select name="{{ c.name }}_upper" style="width:40px;">
                  <option>2</option><option>3</option>
                  <option>7</option><option>8</option><option>0</option>
                </select>
                <input type="checkbox" name="{{ c.name }}_upper_remedial">
                <label>Remedial</label>
              </div>

              <div class="row readcode-host"
                  style="display:grid; grid-template-columns: 80px 40px 20px auto; align-items:center; gap:6px; margin-top:7px;"
                  data-readcodes="RAFPUL01 — L0\u000ARAFPUL02 — L0R\u000ARAFPUL21 — L2\u000ARAFPUL22 — L2R\u000ARAFPUL31 — L3\u000ARAFPUL32 — L3R\u000ARAFPUL71 — L7\u000ARAFPUL72 — L7R\u000ARAFPUL81 — L8\u000ARAFPUL82 — L8R">
                <label>Lower Limbs</label>
                <select name="{{ c.name }}_lower">
                  <option>2</option><option>3</option>
                  <option>7</option><option>8</option><option>0</option>
                </select>
                <input type="checkbox" name="{{ c.name }}_lower_remedial">
                <label>Remedial</label>
              </div>      

              <div class="row" style="display:grid; grid-template-columns: 70px 85px 80px; align-items:center; margin-top:14px;">
                <span></span>
                <strong style="text-align:center;">Right</strong>
                <strong style="text-align:center;">Left</strong>
              </div>

              <div class="row" style="display:grid; grid-template-columns: 80px 80px 80px; align-items:center; gap:6px;margin-top:14px;">
                <label>Hearing</label>
                <input type="text" value="2" readonly style="width:40px; text-align:center;">
                <input type="text" value="2" readonly style="width:40px; text-align:center;">
              </div>

              <div class="row" style="display:grid; grid-template-columns: 70px 80px 80px; align-items:center; gap:6px;margin-top:14px;">
                <span></span>
                <div style="display:flex; justify-content:space-around; width:100%;">
                  <label>U</label><label>C</label>
                </div>
                <div style="display:flex; justify-content:space-around; width:100%;">
                  <label>U</label><label>C</label>
                </div>
              </div>

              <div class="row" style="display:grid; grid-template-columns: 70px 80px 80px; align-items:center; gap:7px;margin-top:5px;">
                <label>Eyes</label>
                <div style="display:flex; justify-content:space-around; width:100%; gap:6px;">
                  <input type="text" value="2" readonly style="width:24px; text-align:center;">
                  <input type="text" value="" readonly style="width:24px; text-align:center;">
                </div>
                <div style="display:flex; justify-content:space-around; width:100%; gap:6px;">
                  <input type="text" value="2" readonly style="width:24px; text-align:center;">
                  <input type="text" value="" readonly style="width:24px; text-align:center;">
                </div>
              </div>

              <div class="row readcode-host"
                  style="display:grid; grid-template-columns: 80px 40px; align-items:center; gap:6px; margin-top:14px;"
                  data-readcodes="RAFPUM21 — M2\u000ARAFPUM31 — M3\u000ARAFPUM71 — M7\u000ARAFPUM81 — M8">
                <label>Mental</label>
                <select name="{{ c.name }}_mental" style="width:40px;">
                  <option>2</option><option>3</option><option>7</option><option>8</option>
                </select>
              </div>

              <div class="row readcode-host"
                  style="display:grid; grid-template-columns: 80px 40px 20px auto; align-items:center; gap:6px; margin-top:7px;"
                  data-readcodes="RAFPUS01 — S0\u000ARAFPUS02 — S0R\u000ARAFPUS21 — S2\u000ARAFPUS22 — S2R\u000ARAFPUS31 — S3\u000ARAFPUS32 — S3R\u000ARAFPUS71 — S7\u000ARAFPUS72 — S7R\u000ARAFPUS81 — S8\u000ARAFPUS82 — S8R">
                <label>Stability</label>
                <select name="{{ c.name }}_stability" style="width:40px;">
                  <option>2</option><option>3</option><option>7</option><option>8</option><option>0</option>
                </select>
                <input type="checkbox" name="{{ c.name }}_stability_remedial">
                <label>Remedial</label>
              </div>
            </div>


          {# RIGHT SIDE #}
          <div class="pul-right" style="display:grid; grid-auto-rows:min-content; row-gap:10px;">
            <fieldset class="readcode-host"
                      style="padding:6px 8px;"
                      data-readcodes="TRIQQNMF1 — MFD - Medically Fully Deployable\u000ATRIQQNML1 — MLD - Medically Limited Deployable\u000ATRIQQNMN1 — MND - Medically Not Deployable">
              <legend>Medical Deployability</legend>
              <label><input type="radio" name="{{ c.name }}_deploy" value="Full"> Full</label>
              <label style="margin-left:12px;"><input type="radio" name="{{ c.name }}_deploy" value="Limited"> Limited</label>
              <label style="margin-left:12px;"><input type="radio" name="{{ c.name }}_deploy" value="Not"> Not</label>
            </fieldset>

            <label>JMES</label>
            <div class="jmes-row" style="display:grid; grid-template-columns:auto auto auto auto auto auto auto auto; align-items:center; gap:6px;margin-top:3px;">
              <label>A</label>
              <select name="{{ c.name }}_jmes_A" class="readcode-host"
                      data-readcodes="TRIQQNA11 — A1 - Fit for flying duties without restriction\u000ATRIQQNA21 — A2 - Fit for flying duties but has reduced hearing or eyesight\u000ATRIQQNA31 — A3 - Fit for duties in the air within the stated employment or MedLims\u000ATRIQQNA41 — A4 - Fit to be flown in a passenger aircraft\u000ATRIQQNA51 — A5 - Unfit to be taken in the air\u000ATRIQQNA61 — A6 - Unfit for any duties in the aviation environment">
                {% for i in "123456"|make_list %}
                  <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>
              <label>L</label>
              <select name="{{ c.name }}_jmes_L" class="readcode-host"
                      data-readcodes="TRIQQNL11 — L1 - Fit for unrestricted duty\u000ATRIQQNL21 — L2 - Fit for high readiness roles with minor limitations\u000ATRIQQNL31 — L3 - Fit for limited duties but with some restriction subject to MRA\u000ATRIQQNL41 — L4 - Fit for certain deployed roles into well-established MOB locations subject to Consultant Occupational Physician MRA\u000ATRIQQNL51 — L5 - Unfit deployment. Fit for branch/trade and limited UK operations\u000ATRIQQNL61 — L6 - Unfit for service in the land environment">
                {% for i in "123456"|make_list %}
                  <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>

              <label>M</label>
              <select name="{{ c.name }}_jmes_M" class="readcode-host"
                      data-readcodes="TRIQQNM11 — M1 - Fit for unrestricted duties\u000ATRIQQNM21 — M2 - Fit for restricted duties afloat within the limitations as stated\u000ATRIQQNM31 — M3 - Fit for restricted duties in a vessel in harbour or alongside with the limitations as stated\u000ATRIQQNM41 — M4 - Fit to be carried as embarked forces in transit\u000ATRIQQNM51 — M5 - Fit for restricted duties ashore within the limitations as stated\u000ATRIQQNM61 — M6 - Unfit for any duties in the maritime environment">
                {% for i in "123456"|make_list %}
                  <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>

              <label>E</label>
              <select name="{{ c.name }}_jmes_E" class="readcode-host"
                      data-readcodes="TRIQQNE11 — E1 - Fit for worldwide service in all environments\u000ATRIQQNE21 — E2 - Fit for unrestricted duties but with a medical risk marker\u000ATRIQQNE31 — E3 - Restricted employment outside UK due to medical support or environmental requirements\u000ATRIQQNE41 — E4 - Only to be employed out of the UK with access to established, 'NHS equivalent or better' Primary and Secondary Healthcare\u000ATRIQQNE51 — E5 - May be employed within the UK only\u000ATRIQQNE61 — E6 - Pregnancy/Maternity">
                {% for i in "123456"|make_list %}
                  <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
              </select>

            </div>
            <div style="display:flex; align-items:center; gap:8px;margin-top:5px;">
              <label>JMES Status</label>
              <select name="{{ c.name }}_jmes_status" class="readcode-host"
                      data-readcodes="RAFMETE5 — Temporary MES\u000ARAFMEPE1 — Permanent MES\u000ARAFMENO3 — Not Applicable">
                <option>Temporary</option>
                <option>Permanent</option>
                <option>Not Applicable</option>
              </select>
            </div>


            <div style="display:flex; align-items:center; gap:8px;margin-top:5px;">
              <label>Review Date</label>
              <input type="date" name="{{ c.name }}_review_date" class="readcode-host"
                    data-diary="1"
                    data-readcodes="RAFPUPU1 — Diary entry for PULHHEEMS Profile">
            </div>

            <div style="margin-top:5px;">
              <label>Notes</label>
              <textarea name="{{ c.name }}_notes" rows="1" style="width:100%; box-sizing:border-box;margin-top:10px;"></textarea>
            </div>
          </div>
        </div>
      </div>

      {% elif 'VisualAcuity' in c.type %}
      <div class="visual-acuity-widget"
          style="position:relative; left:0; top:0; width:100%; height:100%; box-sizing:border-box; padding:10px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr 180px; column-gap:14px; row-gap:10px; height:100%;">

          {# ---- Top row: Uncorrected ---- #}
          <div>
            <div style="font-weight:600; margin-bottom:4px;">Right Eye Uncorrected</div>
            <select name="{{ c.name }}_right_uncorr" size="7" style="width:100%;"
                    class="readcode-host"
                    data-readcodes="2B6D — O/E - visual acuity R-eye=6/4\u000A2B61 — O/E - visual acuity R-eye =6/5\u000A2B62 — O/E - visual acuity R-eye =6/6\u000A2B6d — O/E - visual acuity right eye = 6/7.5\u000A2B63 — O/E - visual acuity R-eye =6/9\u000A2B64 — O/E - visual acuity R-eye=6/12\u000A2B6b — O/E- visual acuity R-eye =6/15\u000A2B65 — O/E - visual acuity R-eye=6/18\u000A2B66 — O/E - visual acuity R-eye=6/24\u000A2B67 — O/E - visual acuity R-eye=6/36\u000A2B6e — O/E - visual acuity right eye = 6/48\u000A2B68 — O/E - visual acuity R-eye=6/60\u000A2B69 — O/E -R-eye counts fingers only\u000A2B6C — O/E - R-eye sees hand movements\u000A2B6A — O/E-R-eye perceives light only\u000A2B6A — O/E - blind R-eye\u000A2B6B — O/E - R-eye completely blind">
              <option>O/E - visual acuity R-eye=6/4</option>
              <option>O/E - visual acuity R-eye =6/5</option>
              <option>O/E - visual acuity R-eye =6/6</option>
              <option>O/E - visual acuity right eye = 6/7.5</option>
              <option>O/E - visual acuity R-eye =6/9</option>
              <option>O/E - visual acuity R-eye=6/12</option>
              <option>O/E- visual acuity R-eye =6/15</option>
              <option>O/E - visual acuity R-eye=6/18</option>
              <option>O/E - visual acuity R-eye=6/24</option>
              <option>O/E - visual acuity R-eye=6/36</option>
              <option>O/E - visual acuity right eye = 6/48</option>
              <option>O/E - visual acuity R-eye=6/60</option>
              <option>O/E -R-eye counts fingers only</option>
              <option>O/E - R-eye sees hand movements</option>
              <option>O/E-R-eye perceives light only</option>
              <option>O/E - blind R-eye</option>
              <option>O/E - R-eye completely blind</option>
            </select>
          </div>

          <div>
            <div style="font-weight:600; margin-bottom:4px;">Left Eye Uncorrected</div>
            <select name="{{ c.name }}_left_uncorr" size="7" style="width:100%;"
                    class="readcode-host"
                    data-readcodes="2B7D — O/E - visual acuity L-eye =6/4\u000A2B71 — O/E - visual acuity L-eye =6/5\u000A2B72 — O/E - visual acuity L-eye =6/6\u000A2B7e — O/E - visual acuity left eye = 6/7.5\u000A2B73 — O/E - visual acuity L-eye =6/9\u000A2B74 — O/E - visual acuity L-eye=6/12\u000A2B7b — O/E- visual acuity L-eye =6/15\u000A2B75 — O/E - visual acuity L-eye=6/18\u000A2B76 — O/E - visual acuity L-eye=6/24\u000A2B77 — O/E - visual acuity L-eye=6/36\u000A2B7d — O/E - visual acuity left eye = 6/48\u000A2B78 — O/E - visual acuity L-eye=6/60\u000A2B79 — O/E -L-eye counts fingers only\u000A2B7C — O/E - L-eye sees hand movements\u000A2B7A — O/E-L-eye perceives light only\u000A2B7A — O/E - blind L-eye\u000A2B7B — O/E - L-eye completely blind">
              <option>O/E - visual acuity L-eye =6/4</option>
              <option>O/E - visual acuity L-eye =6/5</option>
              <option>O/E - visual acuity L-eye =6/6</option>
              <option>O/E - visual acuity left eye = 6/7.5</option>
              <option>O/E - visual acuity L-eye =6/9</option>
              <option>O/E - visual acuity L-eye=6/12</option>
              <option>O/E- visual acuity L-eye =6/15</option>
              <option>O/E - visual acuity L-eye=6/18</option>
              <option>O/E - visual acuity L-eye=6/24</option>
              <option>O/E - visual acuity L-eye=6/36</option>
              <option>O/E - visual acuity left eye = 6/48</option>
              <option>O/E - visual acuity L-eye=6/60</option>
              <option>O/E -L-eye counts fingers only</option>
              <option>O/E - L-eye sees hand movements</option>
              <option>O/E-L-eye perceives light only</option>
              <option>O/E - blind L-eye</option>
              <option>O/E - L-eye completely blind</option>
            </select>
          </div>

          {# ---- Summary column (independently offset vertically) ---- #}
          <div class="summary-col" style="padding-top:60px;">
            <div class="row" style="display:grid; grid-template-columns: 70px 1fr 1fr; align-items:center; margin-top:2px;">
              <span></span>
              <strong style="text-align:center;">Right</strong>
              <strong style="text-align:center;">Left</strong>
            </div>

            <div class="row" style="display:grid; grid-template-columns: 70px 1fr 1fr; align-items:center; gap:6px; margin-top:10px;">
              <span></span>
              <div style="display:flex; justify-content:space-around; width:100%;"><label>U</label><label>C</label></div>
              <div style="display:flex; justify-content:space-around; width:100%;"><label>U</label><label>C</label></div>
            </div>

            <div class="row" style="display:grid; grid-template-columns: 70px 1fr 1fr; align-items:center; gap:6px; margin-top:6px;">
              <label>Eyes</label>

              {# Right U/C summary boxes with their own code lists #}
              <div style="display:flex; justify-content:space-around; width:100%; gap:6px;">
                <input type="text" name="{{ c.name }}_right_U" readonly style="width:12px; text-align:center;"
                      class="readcode-host"
                      data-readcodes="RAFPUER1 — Eur1\u000ARAFPUER2 — Eur2\u000ARAFPUER3 — Eur3\u000ARAFPUER4 — Eur4\u000ARAFPUER5 — Eur5\u000ARAFPUER6 — Eur6\u000ARAFPUER7 — Eur7\u000ARAFPUER8 — Eur8">
                <input type="text" name="{{ c.name }}_right_C" readonly style="width:12px; text-align:center;"
                      class="readcode-host"
                      data-readcodes="RAFPUEC17 — Ecr1\u000ARAFPUEC2 — Ecr2\u000ARAFPUEC3 — Ecr3\u000ARAFPUEC4 — Ecr4\u000ARAFPUEC5 — Ecr5\u000ARAFPUEC6 — Ecr6\u000ARAFPUEC7 — Ecr7\u000ARAFPUEC8 — Ecr8">
              </div>

              {# Left U/C summary boxes with their own code lists #}
              <div style="display:flex; justify-content:space-around; width:100%; gap:6px;">
                <input type="text" name="{{ c.name }}_left_U" readonly style="width:12px; text-align:center;"
                      class="readcode-host"
                      data-readcodes="RAFPUEL3 — Eul1\u000ARAFPUEL4 — Eul2\u000ARAFPUEL5 — Eul3\u000ARAFPUEL6 — Eul4\u000ARAFPUEL7 — Eul5\u000ARAFPUEL8 — Eul6\u000ARAFPUEL9 — Eul7\u000ARFPUEU1 — Eul8">
                <input type="text" name="{{ c.name }}_left_C" readonly style="width:12px; text-align:center;"
                      class="readcode-host"
                      data-readcodes="RAFPUEC1 — Ecl1\u000ARAFPUEC10 — Ecl2\u000ARAFPUEC11 — Ecl3\u000ARAFPUEC12 — Ecl4\u000ARAFPUEC13 — Ecl5\u000ARAFPUEC14 — Ecl6\u000ARAFPUEC15 — Ecl7\u000ARAFPUEC16 — Ecl8">
              </div>
            </div>
          </div>

          {# ---- Second row: Corrected ---- #}
          <div>
            <div style="font-weight:600; margin:8px 0 4px;">Right Eye Corrected</div>
            <select name="{{ c.name }}_right_corr" size="7" style="width:100%;"
                    class="readcode-host"
                    data-readcodes="TRIQQOE57 — O/E - visual acuity (corrected) R-eye 6/4\u000ATRISOZ2 — O/E - visual acuity (corrected) R-eye 6/5\u000ATRISOZ3 — O/E - visual acuity (corrected) R-eye 6/6\u000ATRISOZ4 — O/E - visual acuity (corrected) R-eye 6/9\u000ATRISOZ5 — O/E - visual acuity (corrected) R-eye 6/12\u000ATRISOZ6 — O/E - visual acuity (corrected) R-eye 6/18\u000ATRISOZ7 — O/E - visual acuity (corrected) R-eye 6/24\u000ATRISOZ8 — O/E - visual acuity (corrected) R-eye 6/36\u000ATRISOZ9 — O/E - visual acuity (corrected) R-eye 6/60">
              <option>O/E - visual acuity (corrected) R-eye 6/4</option>
              <option>O/E - visual acuity (corrected) R-eye 6/5</option>
              <option>O/E - visual acuity (corrected) R-eye 6/6</option>
              <option>O/E - visual acuity (corrected) R-eye 6/9</option>
              <option>O/E - visual acuity (corrected) R-eye 6/12</option>
              <option>O/E - visual acuity (corrected) R-eye 6/18</option>
              <option>O/E - visual acuity (corrected) R-eye 6/24</option>
              <option>O/E - visual acuity (corrected) R-eye 6/36</option>
              <option>O/E - visual acuity (corrected) R-eye 6/60</option>
            </select>
          </div>

          <div>
            <div style="font-weight:600; margin:8px 0 4px;">Left Eye Corrected</div>
            <select name="{{ c.name }}_left_corr" size="7" style="width:100%;"
                    class="readcode-host"
                    data-readcodes="TRIQQOE56 — O/E - visual acuity (corrected) L-eye 6/4\u000ATRISO/39 — O/E - visual acuity (corrected) L-eye 6/5\u000ATRISO/40 — O/E - visual acuity (corrected) L-eye 6/6\u000ATRISO/41 — O/E - visual acuity (corrected) L-eye 6/9\u000ATRISO/44 — O/E - visual acuity (corrected) L-eye 6/12\u000ATRISO/46 — O/E - visual acuity (corrected) L-eye 6/18\u000ATRISO/48 — O/E - visual acuity (corrected) L-eye 6/24\u000ATRISO/61 — O/E - visual acuity (corrected) L-eye 6/36\u000ATRISO/65 — O/E - visual acuity (corrected) L-eye 6/60">
              <option>O/E - visual acuity (corrected) L-eye 6/4</option>
              <option>O/E - visual acuity (corrected) L-eye 6/5</option>
              <option>O/E - visual acuity (corrected) L-eye 6/6</option>
              <option>O/E - visual acuity (corrected) L-eye 6/9</option>
              <option>O/E - visual acuity (corrected) L-eye 6/12</option>
              <option>O/E - visual acuity (corrected) L-eye 6/18</option>
              <option>O/E - visual acuity (corrected) L-eye 6/24</option>
              <option>O/E - visual acuity (corrected) L-eye 6/36</option>
              <option>O/E - visual acuity (corrected) L-eye 6/60</option>
            </select>
          </div>

          {# spacer #}
          <div></div>
        </div>
      </div>

      {% elif 'AudiometryCompare' in c.type %}
      <div class="audio-compare-widget"
          style="position:relative; left:0; top:0; width:100%; height:100%; box-sizing:border-box; padding:10px;">

        <!-- Top: two identical panels with Hz rows & sums (readonly) -->
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">

          <!-- First audiogram (left) -->
          <fieldset style="border:0;padding:10px;">
            <legend style="position:relative; left:180px;">First audiogram:</legend>

            <div style="display:grid; grid-auto-rows:min-content; row-gap:8px; align-items:center; max-width:320px;">
            <!-- Date/Time dropdown (no label) -->
            <select name="{{ c.name }}_a1_dt" style="max-width:170px;position:relative; left:120px;">
              <option>05/04/2024 14:58</option>
              <option>25/11/2015 09:12</option>
            </select>

            <!-- Age row -->
            <div style="display:flex; gap:8px; align-items:center;">
              <label style="min-width:60px;position:relative; left:70px;">Age:</label>
              <input type="text" value="44" name="{{ c.name }}_a1_age" style="width:48px;position:relative; left:50px;" readonly>
            </div>

            <!-- Reason row -->
            <div style="display:flex; gap:8px; align-items:center;">
              <label style="min-width:90px;position:relative; left:53px;">Reason:</label>
              <input value="Routine Audiometry" type="text" name="{{ c.name }}_a1_reason" style="width:180px;position:relative; left:20px;" readonly>
            </div>

            <!-- Hz headers + Right/Left rows (identical widths to Audiometry widget) -->
            <div style="margin-top:10px;">
              <div style="display:grid; grid-template-columns: 30px repeat(7, 30px); gap:8px 20px; align-items:center;">
                <span></span>
                <div style="text-align:center;">500Hz</div>
                <div style="text-align:center;">1KHz</div>
                <div style="text-align:center;">2KHz</div>
                <div style="text-align:center;">3KHz</div>
                <div style="text-align:center;">4KHz</div>
                <div style="text-align:center;">6KHz</div>
                <div style="text-align:center;">8KHz</div>

                <div>R (dB)</div>
                {% for val in ac_1_r %}
                  <input type="text"
                        name="{{ c.name }}_a1_r{{ forloop.counter }}"
                        value="{{ val }}"
                        style="width:30px; height:18px; text-align:center;"
                        readonly>
                {% endfor %}

                <div>L (dB)</div>
                {% for val in ac_1_l %}
                  <input type="text" name="{{ c.name }}_a1_l{{ forloop.counter }}" 
                          value="{{ val }}"
                          style="width:30px; height:18px; text-align:center;" 
                          readonly>
                {% endfor %}
              </div>
            </div>

            <!-- Sums / H grade (same labels & widths) -->
            <div style="display:grid; grid-template-columns: 60px repeat(3, 70px); gap:8px 20px; align-items:center; margin-top:10px;">
              <span></span><div>Sum of Low</div><div>Sum of High</div><div>H Grade</div>

              <div style="position:relative; left:50px;">R</div>
              <input type="text" name="{{ c.name }}_a1_r_sum_low"  value="30" style="width:30px; height:18px; text-align:center;" readonly>
              <input type="text" name="{{ c.name }}_a1_r_sum_high" value="75" style="width:30px; height:18px; text-align:center;" readonly>
              <input type="text" name="{{ c.name }}_a1_r_hgrade"   value="2" style="width:30px; height:18px; text-align:center;" readonly>

              <div style="position:relative; left:50px;">L</div>
              <input type="text" name="{{ c.name }}_a1_l_sum_low"  value="25" style="width:30px; height:18px; text-align:center;" readonly>
              <input type="text" name="{{ c.name }}_a1_l_sum_high" value="55" style="width:30px; height:18px; text-align:center;" readonly>
              <input type="text" name="{{ c.name }}_a1_l_hgrade"   value="2" style="width:30px; height:18px; text-align:center;" readonly>
            </div>
          </fieldset>

          <!-- Second audiogram (right) -->
         <fieldset style="border:0;padding:10px;">
            <legend style="position:relative; left:180px;">Second audiogram:</legend>

            <div style="display:grid; grid-auto-rows:min-content; row-gap:8px; align-items:center; max-width:420px;">
            <!-- Date/Time dropdown (no label) -->
            <select name="{{ c.name }}_a2_dt" style="max-width:180px;position:relative; left:120px;">
              <option>05/04/2024 14:58</option>
              <option selected>25/11/2015 09:12</option>
            </select>

            <!-- Age row -->
            <div style="display:flex; gap:8px; align-items:center;">
              <label style="min-width:110px;position:relative; left:70px;">Age:</label>
              <input type="text" value="35" name="{{ c.name }}_a2_age" style="width:48px;" readonly>
              <label style="min-width:110px;">Age Difference:</label>
              <input type="text" value="8/4" name="{{ c.name }}_age_diff" style="width:48px;" readonly>
            </div>

            <!-- Reason row -->
            <div style="display:flex; gap:8px; align-items:center;">
              <label style="min-width:110px;position:relative; left:53px;">Reason:</label>
              <input value="Routine Audiometry" type="text" name="{{ c.name }}_a2_reason" style="width:180px;" readonly>
            </div>

            <!-- Hz headers + Right/Left rows (identical to left) -->
            <div style="margin-top:10px;">
              <div style="display:grid; grid-template-columns: 30px repeat(7, 30px); gap:8px 20px; align-items:center;">
                <span></span>
                <div style="text-align:center;">500Hz</div>
                <div style="text-align:center;">1KHz</div>
                <div style="text-align:center;">2KHz</div>
                <div style="text-align:center;">3KHz</div>
                <div style="text-align:center;">4KHz</div>
                <div style="text-align:center;">6KHz</div>
                <div style="text-align:center;">8KHz</div>

                <div>R (dB)</div>
                {% for val in ac_2_r %}
                  <input type="text" 
                        name="{{ c.name }}_a2_r{{ forloop.counter }}" 
                        value="{{ val }}"
                        style="width:30px; height:18px; text-align:center;" 
                        readonly>
                {% endfor %}

                <div>L (dB)</div>
                {% for val in ac_2_l %}
                  <input type="text" 
                      name="{{ c.name }}_a2_l{{ forloop.counter }}" 
                      value="{{ val }}"
                      style="width:30px; height:18px; text-align:center;" 
                      readonly>
                {% endfor %}
              </div>
            </div>

            <!-- Sums / H grade (identical) -->
            <div style="display:grid; grid-template-columns: 60px repeat(3, 70px); gap:8px 20px; align-items:center; margin-top:10px;">
              <span></span><div>Sum of Low</div><div>Sum of High</div><div>H Grade</div>

              <div style="position:relative; left:50px;">R</div>
              <input type="text" name="{{ c.name }}_a2_r_sum_low"  value="15" style="width:30px; height:18px; text-align:center;" readonly>
              <input type="text" name="{{ c.name }}_a2_r_sum_high" value="15" style="width:30px; height:18px; text-align:center;" readonly>
              <input type="text" name="{{ c.name }}_a2_r_hgrade"   value="1" style="width:30px; height:18px; text-align:center;" readonly>

              <div style="position:relative; left:50px;">L</div>
              <input type="text" name="{{ c.name }}_a2_l_sum_low"  value="15" style="width:30px; height:18px; text-align:center;" readonly>
              <input type="text" name="{{ c.name }}_a2_l_sum_high" value="15" style="width:30px; height:18px; text-align:center;" readonly>
              <input type="text" name="{{ c.name }}_a2_l_hgrade"   value="1" style="width:30px; height:18px; text-align:center;" readonly>
            </div>
          </fieldset>

        </div>

        <!-- Bottom: charts EXACTLY like the Audiometry widget (same frame & legend) -->
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:14px; justify-items:start;">

          <!-- Left chart -->
          <div style="width:432px; height:370px; border:1px solid #bbb; background:#fafafa;">
            <div style="position:relative; width:100%; height:100%;">
              <div style="position:absolute; inset:12px; border:1px solid #888; background:#fff;"></div>
              <div style="position:absolute; right:14px; top:14px; border:1px solid #666; padding:3px 6px; background:#fff; font-size:11px;">
                <div><span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#d00; margin-right:6px;"></span>Right ear</div>
                <div style="margin-top:2px;"><span style="display:inline-block; width:8px; height:8px; border-left:2px solid #06c; border-bottom:2px solid #06c; transform:rotate(45deg); margin-right:8px;"></span>Left ear</div>
              </div>
              <div style="position:absolute; left:6px; top:50%; transform:translateY(-50%) rotate(-90deg); transform-origin:left top; font-size:11px; color:#333;">
                Hearing Level (dB)
              </div>
              <div style="position:absolute; left:50%; bottom:6px; transform:translateX(-50%); font-size:11px; color:#333;">
                Frequency (Hz)
              </div>
            </div>
          </div>

          <!-- Right chart -->
          <div style="width:432px; height:370px; border:1px solid #bbb; background:#fafafa;">
            <div style="position:relative; width:100%; height:100%;">
              <div style="position:absolute; inset:12px; border:1px solid #888; background:#fff;"></div>
              <div style="position:absolute; right:14px; top:14px; border:1px solid #666; padding:3px 6px; background:#fff; font-size:11px;">
                <div><span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#d00; margin-right:6px;"></span>Right ear</div>
                <div style="margin-top:2px;"><span style="display:inline-block; width:8px; height:8px; border-left:2px solid #06c; border-bottom:2px solid #06c; transform:rotate(45deg); margin-right:8px;"></span>Left ear</div>
              </div>
              <div style="position:absolute; left:6px; top:50%; transform:translateY(-50%) rotate(-90deg); transform-origin:left top; font-size:11px; color:#333;">
                Hearing Level (dB)
              </div>
              <div style="position:absolute; left:50%; bottom:6px; transform:translateX(-50%); font-size:11px; color:#333;">
                Frequency (Hz)
              </div>
            </div>
          </div>

        </div>

        <div style="text-align:center; margin-top:10px;">
          <button type="button">Analyse</button>
        </div>
      </div>


      {% elif 'Audiometry' in c.type %}
      <div class="audiometry-widget" style="position:relative; left:0; top:0; width:100%; height:100%; box-sizing:border-box;">

        {# --- Graph / chart frame ----------------------------------------------- #}
        <div style="position:absolute; left:140px; top:40px; width:432px; height:370px; border:1px solid #bbb; background:#fafafa;">
          <div style="position:absolute; inset:12px; border:1px solid #888; background:#fff;"></div>
          <div style="position:absolute; right:14px; top:14px; border:1px solid #666; padding:3px 6px; background:#fff; font-size:11px;">
            <div><span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#d00; margin-right:6px;"></span>Right ear</div>
            <div style="margin-top:2px;"><span style="display:inline-block; width:8px; height:8px; border-left:2px solid #06c; border-bottom:2px solid #06c; transform:rotate(45deg); margin-right:8px;"></span>Left ear</div>
          </div>
          <div style="position:absolute; left:6px; top:50%; transform:translateY(-50%) rotate(-90deg); transform-origin:left top; font-size:11px; color:#333;">
            Hearing Level (dB)
          </div>
          <div style="position:absolute; left:50%; bottom:6px; transform:translateX(-50%); font-size:11px; color:#333;">
            Frequency (Hz)
          </div>
        </div>

        {# --- Column headers (Hz) ------------------------------------------------ #}
        <div style="position:absolute; left:113px; top:430px; width:30px; text-align:center;">500Hz</div>
        <div style="position:absolute; left:163px; top:430px; width:30px; text-align:center;">1000Hz</div>
        <div style="position:absolute; left:213px; top:430px; width:30px; text-align:center;">2000Hz</div>
        <div style="position:absolute; left:263px; top:430px; width:30px; text-align:center;">3000Hz</div>
        <div style="position:absolute; left:313px; top:430px; width:30px; text-align:center;">4000Hz</div>
        <div style="position:absolute; left:363px; top:430px; width:30px; text-align:center;">6000Hz</div>
        <div style="position:absolute; left:413px; top:430px; width:30px; text-align:center;">8000Hz</div>

        {# --- Row labels --------------------------------------------------------- #}
        <div style="position:absolute; left:60px; top:456px;">Right (dB)</div>
        <div style="position:absolute; left:60px; top:486px;">Left (dB)</div>

        {# --- Right ear inputs (y=454) ------------------------------------------ #}
        <input name="{{ c.name }}_r_500"   type="text" style="position:absolute; left:113px; top:454px; width:30px; height:18px;">
        <input name="{{ c.name }}_r_1000"  type="text" style="position:absolute; left:163px; top:454px; width:30px; height:18px;">
        <input name="{{ c.name }}_r_2000"  type="text" style="position:absolute; left:213px; top:454px; width:30px; height:18px;">
        <input name="{{ c.name }}_r_3000"  type="text" style="position:absolute; left:263px; top:454px; width:30px; height:18px;">
        <input name="{{ c.name }}_r_4000"  type="text" style="position:absolute; left:313px; top:454px; width:30px; height:18px;">
        <input name="{{ c.name }}_r_6000"  type="text" style="position:absolute; left:363px; top:454px; width:30px; height:18px;">
        <input name="{{ c.name }}_r_8000"  type="text" style="position:absolute; left:413px; top:454px; width:30px; height:18px;">

        {# --- Left ear inputs (y=484) ------------------------------------------- #}
        <input name="{{ c.name }}_l_500"   type="text" style="position:absolute; left:113px; top:484px; width:30px; height:18px;">
        <input name="{{ c.name }}_l_1000"  type="text" style="position:absolute; left:163px; top:484px; width:30px; height:18px;">
        <input name="{{ c.name }}_l_2000"  type="text" style="position:absolute; left:213px; top:484px; width:30px; height:18px;">
        <input name="{{ c.name }}_l_3000"  type="text" style="position:absolute; left:263px; top:484px; width:30px; height:18px;">
        <input name="{{ c.name }}_l_4000"  type="text" style="position:absolute; left:313px; top:484px; width:30px; height:18px;">
        <input name="{{ c.name }}_l_6000"  type="text" style="position:absolute; left:363px; top:484px; width:30px; height:18px;">
        <input name="{{ c.name }}_l_8000"  type="text" style="position:absolute; left:413px; top:484px; width:30px; height:18px;">

        {# --- Repeat audiogram block (482,430)-(646,517) ------------------------ #}
        <fieldset style="position:absolute; left:482px; top:430px; width:164px; height:75px; padding:4px 5px;">
          <legend>Is this a repeat audiogram?</legend>
          <label style="margin-right:14px;"><input type="radio" name="{{ c.name }}_repeat" value="Yes"> Yes</label>
          <label><input type="radio" name="{{ c.name }}_repeat" value="No"> No</label>
          <div style="margin-top:8px;margin-left: 34px;">
            <button type="button">Initial Analysis</button>
          </div>
        </fieldset>

        {# --- Sums / H grade (Right row y=544; Left row y=584) ------------------ #}
        <div style="position:absolute; left:113px; top:526px;">Sum L Freq.</div>
        <div style="position:absolute; left:183px; top:526px;">Sum H Freq.</div>
        <div style="position:absolute; left:253px; top:526px;">H Grade</div>

        <div style="position:absolute; left:60px; top:546px;">Right</div>
        <input name="{{ c.name }}_r_sum_low"  type="text" readonly style="position:absolute; left:113px; top:544px; width:30px; height:18px;">
        <input name="{{ c.name }}_r_sum_high" type="text" readonly style="position:absolute; left:183px; top:544px; width:30px; height:18px;">
        <input name="{{ c.name }}_r_hgrade"   type="text" readonly style="position:absolute; left:253px; top:544px; width:30px; height:18px;">

        <div style="position:absolute; left:60px; top:586px;">Left</div>
        <input name="{{ c.name }}_l_sum_low"  type="text" readonly style="position:absolute; left:113px; top:584px; width:30px; height:18px;">
        <input name="{{ c.name }}_l_sum_high" type="text" readonly style="position:absolute; left:183px; top:584px; width:30px; height:18px;">
        <input name="{{ c.name }}_l_hgrade"   type="text" readonly style="position:absolute; left:253px; top:584px; width:30px; height:18px;">

        {# --- Right/Left/Points/Lines/Print block (452,543)-(676,607) ----------- #}
        <fieldset style="position:absolute; left:452px; top:543px; width:224px; height:60px; padding:4px 5px;">
          <div style="display:grid; grid-template-columns:auto auto min-content; grid-template-rows:auto auto; column-gap:12px; row-gap:3px; align-items:center; height:100%;">
            <label><input type="checkbox" name="{{ c.name }}_show_right" checked> Right</label>
            <label><input type="checkbox" name="{{ c.name }}_show_points"> Points</label>

            {# Print button to the right, centered between rows #}
            <button type="button" style="grid-column:3; grid-row:1 / span 2; align-self:center; justify-self:center;">Print</button>

            <label><input type="checkbox" name="{{ c.name }}_show_left" checked> Left</label>
            <label><input type="checkbox" name="{{ c.name }}_show_lines"> Lines</label>
          </div>
        </fieldset>

      </div>

      
      {# Hyperlink #}
      {% elif 'HyperLink' in c.type %}
      <a href="{{ c.props.strURL|default:'#' }}" target="_blank" rel="noopener"
        style="display:inline-block; text-decoration:underline; cursor:pointer;">
        {{ c.props.strHyperLink|default:c.props.strNormal|default:c.name }}
      </a>

      {% else %}
      <div style="border:1px solid #000;">{{ c.type }}: {{ c.name }}</div>

      {% endif %}
    </div>
    {% endif %}
    {% endfor %}
  </div>

  {# Sidebar (right) #}
  <aside style="width:320px; max-height:{{ canvas.height }}px; overflow:auto; border:1px solid #ddd; padding:8px; background:#fafafa; font-size: 12px;">
    <h3 style="margin:0 0 8px;">Data Entry Read codes in form</h3>
    {% if all_read_codes %}
      <ul style="margin:0 0 12px; padding-left:18px;">
        {% for rc in all_read_codes %}
          <li><code>{{ rc.code }}</code> — {{ rc.label }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p style="margin:0 0 12px; color:#666;">None detected.</p>
    {% endif %}

    <h4 style="margin:0 0 8px;">Diary entry codes</h4>
    {% if diary_read_codes %}
      <ul style="margin:0; padding-left:18px;">
        {% for rc in diary_read_codes %}
          <li><code>{{ rc.code }}</code> — {{ rc.label }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p style="margin:0; color:#666;">None detected.</p>
    {% endif %}
  </aside>
</div>

</form>

<script>
  (function () {
    function toggleTargets(chk) {
      var ids = (chk.getAttribute('data-targets') || '').split(',').map(function (s) { return s.trim(); }).filter(Boolean);
      if (!ids.length) return;
      ids.forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.disabled = !chk.checked;
      });
      if (chk.checked) {
        var first = document.getElementById(ids[0]);
        if (first) { try { first.focus(); } catch (e) {} }
      }
    }
    document.querySelectorAll('.rc-chk').forEach(function (chk) {
      chk.addEventListener('change', function () { toggleTargets(chk); });
      toggleTargets(chk); // init
    });
  })();
</script>

<script>
  (function () {
    function setupMultiDropdown(ms) {
      var btn   = ms.querySelector('.ms-btn');
      var panel = ms.querySelector('.ms-panel');
      var label = ms.querySelector('.ms-label');

      // NEW: use existing label text (or data-caption) as the default
      var defaultCaption = (label && label.textContent.trim()) ||
                           ms.getAttribute('data-caption') ||
                           'Select…';

      function close() { panel.style.display = 'none'; btn.setAttribute('aria-expanded','false'); }
      function open()  { panel.style.display = 'block'; btn.setAttribute('aria-expanded','true'); }

      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        (panel.style.display === 'block') ? close() : open();
      });

      panel.addEventListener('click', function (e) { e.stopPropagation(); });
      document.addEventListener('click', close);

      function updateLabel() {
        var checked = panel.querySelectorAll('input[type=checkbox]:checked');
        if (checked.length === 0) {
          label.textContent = defaultCaption;           // CHANGED
        } else if (checked.length === 1) {
          var t = checked[0].closest('label');
          label.textContent = t ? t.textContent.trim() : defaultCaption;
        } else {
          label.textContent = checked.length + ' selected';
        }
      }

      panel.querySelectorAll('input[type=checkbox]').forEach(function (cb) {
        cb.addEventListener('change', updateLabel);
      });
      updateLabel();
    }

    document.querySelectorAll('.ms').forEach(setupMultiDropdown);
  })();
</script>


<script>
  (function () {
    // --- Simple checkbox controls: enable/disable their text inputs
    function toggleTarget(chk) {
      var tgtId = chk.getAttribute('data-target');
      if (!tgtId) return;
      var input = document.getElementById(tgtId);
      if (!input) return;
      input.disabled = !chk.checked;
      if (chk.checked) { try { input.focus(); } catch (e) {} }
    }
    document.querySelectorAll('.rc-chk').forEach(function (chk) {
      chk.addEventListener('change', function () { toggleTarget(chk); });
      toggleTarget(chk); // init
    });

    // --- Yes/No pairs (QuestionReadCode): mutually exclusive; optional text enabled by YES
    function handleYesNoChange(el) {
      var pairId = el.getAttribute('data-pair');
      if (pairId) {
        var other = document.getElementById(pairId);
        if (other && el.checked) other.checked = false;
      }
      // if there is a sibling text input, enable only when YES is checked
      var row = el.closest('.rc-row');
      if (!row) return;
      var yes = row.querySelector('input.rc-yesno[id$="_yes"]');
      var text = row.querySelector('input[type="text"]');
      if (text) {
        text.disabled = !(yes && yes.checked);
      }
    }
    document.querySelectorAll('.rc-yesno').forEach(function (el) {
      el.addEventListener('change', function () { handleYesNoChange(el); });
      handleYesNoChange(el); // init
    });

    // --- Hover tooltip for readcode-host (decodes \u000A)
    var tip = document.createElement('div');
    Object.assign(tip.style, {
      position: 'fixed', zIndex: '2000', display: 'none', pointerEvents: 'none',
      background: 'rgba(0,0,0,0.8)', color: '#fff', padding: '6px 8px',
      borderRadius: '4px', font: '12px/1.3 Tahoma, Arial, sans-serif',
      maxWidth: '360px', whiteSpace: 'pre-wrap', boxShadow: '0 2px 8px rgba(0,0,0,.25)'
    });
    document.body.appendChild(tip);
    function decodeEscapes(s) {
      if (!s) return '';
      try { return JSON.parse('"' + s.replace(/"/g, '\\"') + '"'); }
      catch (e) { return s.replace(/\\u000A/gi, '\n').replace(/\\n/g, '\n'); }
    }
    function showTip(e, text) {
      if (!text) return;
      tip.textContent = decodeEscapes(text);
      tip.style.display = 'block';
      position(e);
    }
    function hideTip() { tip.style.display = 'none'; }
    function position(e) {
      var x = e.clientX + 12, y = e.clientY + 12;
      var rect = tip.getBoundingClientRect();
      if (x + rect.width > window.innerWidth - 8) x = window.innerWidth - rect.width - 8;
      if (y + rect.height > window.innerHeight - 8) y = window.innerHeight - rect.height - 8;
      tip.style.left = x + 'px'; tip.style.top = y + 'px';
    }
    document.querySelectorAll('.readcode-host').forEach(function (el) {
      var data = el.getAttribute('data-readcodes');
      if (!data) return;
      el.addEventListener('mouseenter', function (e) { showTip(e, data); });
      el.addEventListener('mousemove', position);
      el.addEventListener('mouseleave', hideTip);
      el.addEventListener('scroll', hideTip, true);
    });
  })();
</script>

<script>
(function () {
  function num(v){ var x=parseFloat(String(v||'').replace(/[^0-9.]/g,'')); return isNaN(x)?null:x; }
  function findValueByReadCode(code) {
    const host = document.querySelector(`.readcode-host[data-readcodes^="${code}"]`);
    if (!host) return null;
    return host.querySelector('.rc-value') || host.querySelector('input[type="number"], input[type="text"]');
  }
  function recalcDerived(){
    const hInput = findValueByReadCode('229..'); // O/E - height
    const wInput = findValueByReadCode('22A..'); // O/E - weight
    var hcm = hInput ? num(hInput.value) : null;
    var wkg = wInput ? num(wInput.value) : null;
    var hm = (hcm!=null) ? (hcm/100) : null;
    var age = 30; // assumed (male)

    document.querySelectorAll('.rc-row').forEach(function(row){
      var lab = row.querySelector('label'); if(!lab) return;
      var out = row.querySelector('input[id$="_value"][name$="_value"]'); if(!out) return;
      var t = lab.textContent.trim().toLowerCase();
      if (t === 'ideal weight'){
        if (hm!=null){ out.value = Math.round(22 * hm * hm); }  // BMI 22 target
      } else if (t === 'bmi'){
        if (hm!=null && wkg!=null){ out.value = (wkg / (hm*hm)).toFixed(1); }
      } else if (t === 'predicted pefr' || t.includes('peak flow')){
        if (hm != null){
          var lmin = (((hm * 5.48) + 1.58) - (age * 0.041)) * 60;
          if (lmin < 0) lmin = 0;
          out.value = Math.round(lmin);
        }
      }
    });
  }
  ['input','change'].forEach(function(ev){
    document.addEventListener(ev, function(e){
      if (e.target && e.target.matches('.rc-row input[type="text"], .rc-row input[type="number"]')) {
        recalcDerived();
      }
    });
  });
  window.addEventListener('DOMContentLoaded', recalcDerived);
})();
</script>
<script>
(function () {
  // Decode \u000A etc.
  function decodeEscapes(s) {
    if (!s) return '';
    try { return JSON.parse('"' + s.replace(/"/g, '\\"') + '"'); }
    catch(e) { return s.replace(/\\u000A/gi, '\n').replace(/\\n/g, '\n'); }
  }

  var sidebar = document.querySelector('aside');
  if (!sidebar) return;

  var h3 = sidebar.querySelector('h3');    // "Data Entry Read codes in form"
  var h4 = sidebar.querySelector('h4');    // "Diary entry codes"

  // Return {ul, noneP} where noneP is the "None detected." <p> if present
  function getSection(afterHeader) {
    var sib = afterHeader ? afterHeader.nextElementSibling : null;
    var noneP = null, ul = null;

    if (sib && sib.tagName === 'UL') {
      ul = sib;
    } else if (sib && sib.tagName === 'P') {
      // keep a ref so we can remove it if we add items
      noneP = sib;
    }

    // Ensure we have a UL; if not, create it just after the header (and before/replace the <p>)
    if (!ul) {
      ul = document.createElement('ul');
      ul.style.margin = '0 0 12px';
      ul.style.paddingLeft = '18px';
      ul.style.color = ''; // inherit default (avoid grey)
      if (noneP) {
        noneP.parentNode.insertBefore(ul, noneP.nextSibling);
      } else if (afterHeader && afterHeader.parentNode) {
        afterHeader.parentNode.insertBefore(ul, afterHeader.nextSibling);
      }
    } else {
      // make sure list uses normal color (not inherited grey)
      ul.style.color = '';
    }

    return { ul: ul, noneP: noneP };
  }

  var allSec   = getSection(h3);
  var diarySec = getSection(h4);

  function collectExistingCodes(ul) {
    var set = new Set();
    ul.querySelectorAll('li > code').forEach(function (c) {
      set.add((c.textContent || '').trim());
    });
    return set;
  }

  var seenAll   = collectExistingCodes(allSec.ul);
  var seenDiary = collectExistingCodes(diarySec.ul);

  var addedAll = 0, addedDiary = 0;

  document.querySelectorAll('.readcode-host').forEach(function (el) {
    var blob = el.getAttribute('data-readcodes');
    if (!blob) return;

    var isDiary = el.getAttribute('data-diary') === '1' ||
                  el.classList.contains('tpl-lastentry');

    decodeEscapes(blob).split(/\r?\n/).forEach(function (line) {
      line = line.trim();
      if (!line) return;

      var m = line.split('—');
      var code  = (m[0] || '').trim();
      var label = (m.slice(1).join('—') || '').trim();
      if (!code) return;

      var ul   = isDiary ? diarySec.ul : allSec.ul;
      var seen = isDiary ? seenDiary : seenAll;

      if (seen.has(code)) return;

      var li = document.createElement('li');
      var c  = document.createElement('code');
      c.textContent = code;
      li.appendChild(c);
      if (label) li.appendChild(document.createTextNode(' — ' + label));
      ul.appendChild(li);
      seen.add(code);

      if (isDiary) addedDiary++; else addedAll++;
    });
  });

  // If we added anything, remove the old "None detected." paragraph
  if (addedAll && allSec.noneP) allSec.noneP.remove();
  if (addedDiary && diarySec.noneP) diarySec.noneP.remove();
})();
</script>

<script>
(function () {
  function extractDenom(text) {
    var m = String(text || '').match(/6\/(\d+(?:\.\d+)?)/);
    if (m) return parseFloat(m[1]);
    // non-numeric descriptions => treat as worst category for U
    if (/counts\s*fingers|hand\s*movements|perceives\s*light|blind/i.test(String(text))) {
      return Infinity; // funnels to worst branch in U logic (→ 8)
    }
    return null;
  }

  // Uncorrected (U) extended:
  // 6/4,6/5,6/6=1; 6/7.5,6/9=2; 6/12=3; 6/15,6/18=4; 6/24=5; 6/36=6; 6/48,6/60=7; else 8
  function scoreU(d) {
    if (d == null) return '';
    if (d <= 6) return 1;
    if (d === 7.5 || d === 9) return 2;
    if (d === 12) return 3;
    if (d === 15 || d === 18) return 4;
    if (d === 24) return 5;
    if (d === 36) return 6;
    if (d === 48 || d === 60) return 7;
    if (!isFinite(d)) return 8; // CF/HM/PL/Blind
    return 8;
  }

  // Corrected (C) extended:
  // 6/4,6/5,6/6=1; 6/9=2; 6/12=3; 6/15,6/18=4; 6/24=5; 6/36=6; 6/60=7
  function scoreC(d) {
    if (d == null) return '';
    if (d <= 6) return 1;
    if (d === 9)  return 2;
    if (d === 12) return 3;
    if (d === 15 || d === 18) return 4;
    if (d === 24) return 5;
    if (d === 36) return 6;
    if (d === 60) return 7;
    return '';
  }

  function selectedText(sel) {
    return (sel && sel.options && sel.selectedIndex >= 0)
      ? sel.options[sel.selectedIndex].text
      : (sel ? sel.value : '');
  }

  function updateWidget(widget) {
    var rU = widget.querySelector('select[name$="_right_uncorr"]');
    var lU = widget.querySelector('select[name$="_left_uncorr"]');
    var rC = widget.querySelector('select[name$="_right_corr"]');
    var lC = widget.querySelector('select[name$="_left_corr"]');

    var out_rU = widget.querySelector('input[name$="_right_U"]');
    var out_lU = widget.querySelector('input[name$="_left_U"]');
    var out_rC = widget.querySelector('input[name$="_right_C"]');
    var out_lC = widget.querySelector('input[name$="_left_C"]');

    if (rU && out_rU) out_rU.value = scoreU(extractDenom(selectedText(rU))) || '';
    if (lU && out_lU) out_lU.value = scoreU(extractDenom(selectedText(lU))) || '';
    if (rC && out_rC) out_rC.value = scoreC(extractDenom(selectedText(rC))) || '';
    if (lC && out_lC) out_lC.value = scoreC(extractDenom(selectedText(lC))) || '';
  }

  document.querySelectorAll('.visual-acuity-widget').forEach(function (widget) {
    widget.querySelectorAll('select[name$="_uncorr"], select[name$="_corr"]').forEach(function (sel) {
      sel.addEventListener('change', function () { updateWidget(widget); });
    });
    updateWidget(widget); // init
  });
})();
</script>

{% endif %}
{% endblock %}