{# templates/import_tex.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Templates | TT-MICP{% endblock %}
{% block content %}

<div class="tex-wrapper">
  <div class="tex-spacer">
  <div class="tex-layout">
    <form id="tex-controls" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="controls-row">
        <div>
          <label for="{{ form.tex_file.id_for_label }}"><strong>Upload TEX</strong></label><br>
          {{ form.tex_file }}
        </div>

        <div>
          <label><strong>Or pick from library</strong></label><br>

          <!-- Hover trigger + radios -->
          <div id="lib-trigger" style="display:inline-flex; gap:8px; align-items:center; position:relative;">
            <label style="margin:0;">
              <input type="radio" name="libmode" value="list" {% if request.POST.libmode == 'list' or not request.POST.libmode %}checked{% endif %}>
              List
            </label>
            <label style="margin:0;">
              <input type="radio" name="libmode" value="search" {% if request.POST.libmode == 'search' %}checked{% endif %}>
              Search
            </label>
            <label style="margin:0;">
              <input type="radio" name="libmode" value="tree" {% if request.POST.libmode == 'tree' %}checked{% endif %}>
              Tree
            </label>

            <!-- Flyout panel (only used for search/tree) -->
            <div id="lib-flyout" style="display:none;">
              <!-- Mode 2: search as you type -->
              <div id="lib-pane-search" style="display:none; max-width:480px;">
                <input id="lib-search-input" type="text" placeholder="Search by name, filename, or TARGETPATH…"
                      style="width:100%; box-sizing:border-box; padding:4px 6px; font-size:12px;">
                <div id="lib-search-results"
                    style="margin-top:6px; max-height:220px; overflow:auto; border:1px solid #ddd; font-size:12px; line-height:1.3;"></div>
              </div>

              <!-- Mode 3: tree / folder view -->
              <div id="lib-pane-tree"
                  style="display:none; max-width:480px; border:1px solid #ddd; padding:6px; max-height:260px; overflow:auto;
                          font-size:12px; line-height:1.3;">
                <div id="lib-tree"></div>
              </div>
            </div>
          </div>

          <!-- Mode 1: the original long list (remains inline) -->
          <div id="lib-pane-list" style="margin-top:6px;">
            {{ form.library_choice }}
          </div>
        </div>
        <div>
          <strong>Then render:</strong>
          <span id="selected-tex-label" style="font-weight:800;">no tex file selected</span><br>
          <button type="submit">Render</button>
        </div>
        </div>
    </form>

    {% if controls %}
    <form d="tex-render" method="post" action="{% url 'submit_tex_form' %}">
      {% csrf_token %}
      <div class="tex-work">

      {# Canvas (left) #}
      <div
        style="position:relative; flex:0 0 auto; border:1px solid #ccc; width:{{ canvas.width }}px; height:{{ canvas.height }}px; font-family:sans-serif, 'MS Sans Serif', Tahoma, Arial; font-size:10px; line-height:1.2; background:#fff;">

        {% for c in controls %}
        {% if c.props.Visible != 'False' %}
        <div class="ctrl readcode-host"
            data-readcodes="{{ c.hover_codes|default:''|escapejs }}"
            style="position:absolute; left:{{ c.x }}px; top:{{ c.y }}px; width:{{ c.width|add:6 }}px; height:{{ c.height }}px; overflow:visible;">

          {# Labels #}
          {% if 'Label' in c.type %}
            <label style="display:block; width:{{ c.width|add:10 }}px;
                          {% if c.font_name %}font-family:{% if ' ' in c.font_name %}'{{ c.font_name }}'{% else %}{{ c.font_name }}{% endif %}, sans-serif;{% endif %}
                          {% if c.font_size_pt %}font-size:{{ c.font_size_pt|add:-1 }}pt;{% endif %}
                          {% if c.font_color %}color:{{ c.font_color }};{% endif %}
                          font-weight:{% if c.is_bold %}700{% else %}400{% endif %};background-color:#fff;">
              {{ c.caption|default:c.name }}
            </label>

          {# Buttons #}
          {% elif 'Button' in c.type %}
            <button type="button" name="{{ c.name }}" tabindex="{{ c.props.TabOrder|default:'0' }}" style="font-size: 10px;">
              {{ c.caption|default:c.name }}
            </button>

          {# Read lists (classic + minimised). Add machine-readable labels/captions for export. #}
          {% elif 'ReadList' in c.type %}
            <div class="rl-wrap"
                style="white-space:normal;"
                data-name="{{ c.name }}"
                data-caption="{{ c.caption|default:'' }}">
              {# Visible caption for classic (non-minimised) lists. Give it a class to find easily. #}
              {% if c.caption and not c.rl_minimised %}
                <div class="rl-caption" style="font-weight:600; margin-bottom:-1px;">{{ c.caption }}</div>
              {% endif %}

              {% if c.rl_minimised and c.rl_multi %}
                {# Minimized MULTI (custom multiselect) #}
                <div class="ms" id="ms_{{ c.name }}"
                    style="position:relative; display:inline-block; min-width:140px;"
                    data-caption="{{ c.caption|default:'' }}">
                  <button type="button"
                          class="ms-btn"
                          aria-haspopup="listbox"
                          aria-expanded="false"
                          aria-label="{{ c.caption|default:'Select options' }}"
                          style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%; min-width:140px; padding:0px 6px; border:1px solid #888; background:#fff; cursor:pointer; font-size: 10.5px;">
                    <span class="ms-label">{{ c.caption|default:"Select…" }}</span><span aria-hidden="true">▾</span>
                  </button>
                  <div class="ms-panel"
                      style="position:absolute; top:100%; left:0; z-index:1000; display:none; border:1px solid #888; background:#fff; max-height:180px; overflow:auto; min-width:220px; padding:6px; box-shadow:0 2px 6px rgba(0,0,0,.15);">
                    {% for opt in c.options %}
                      <label style="display:block; white-space:nowrap;">
                        <input type="checkbox"
                              name="{{ c.name }}[]"
                              value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                        {{ opt.label }}
                      </label>
                    {% endfor %}
                  </div>
                </div>

              {% elif c.rl_minimised %}
                {# Minimized SINGLE (native select, size=1). Add aria/data-caption. #}
                <select name="{{ c.name }}"
                        id="{{ c.name }}"
                        size="1"
                        tabindex="{{ c.props.TabOrder|default:'0' }}"
                        style="min-width:140px; font-size: 10.5px;"
                        aria-label="{{ c.caption|default:'Select…' }}"
                        data-caption="{{ c.caption|default:'' }}">
                  <option value="" selected disabled hidden>{{ c.caption|default:"Select…" }}</option>
                  {% for opt in c.options %}
                    <option value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                      {{ opt.label }}
                    </option>
                  {% endfor %}
                </select>

              {% else %}
                {# Classic list (single or multi via multiple attribute). Add class + aria/data-caption. #}
                <select name="{{ c.name }}{% if c.rl_multi %}[]{% endif %}"
                        id="{{ c.name }}"
                        class="rl-classic"
                        {% if c.rl_multi %}multiple{% endif %}
                        size="{{ c.rl_size|default:5 }}"
                        tabindex="{{ c.props.TabOrder|default:'0' }}"
                        style="min-width:120px; font-size: 10.5px;"
                        aria-label="{{ c.caption|default:c.name }}"
                        data-caption="{{ c.caption|default:'' }}">
                  {% for opt in c.options %}
                    <option value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                      {{ opt.label }}
                    </option>
                  {% endfor %}
                </select>
              {% endif %}

              {% if c.rl_date_prompt %}
                <div style="margin-top:6px;">
                  <label for="{{ c.name }}_date" style="margin-right:6px;">Date:</label>
                  <input id="{{ c.name }}_date"
                        name="{{ c.name }}_date"
                        type="date"
                        tabindex="{{ c.props.TabOrder|default:'0' }}"
                        aria-label="{{ c.caption|default:c.name }} date"
                        data-caption="{{ c.caption|default:'' }}">
                </div>
              {% endif %}
            </div>

          {# ReadCode: for TEmisReadCode and TEmisQuestionReadCode #}
          {% elif 'ReadCode' in c.type %}
          <div class="rc-row readcode-host"
              data-readcodes="{{ c.rc_code|default:'' }} — {{ c.rc_term|default:'' }}{% if c.rc_has_negation %}\n\n{{ c.rc_neg_prefix }}{{ c.rc_code }} — Not - {{ c.rc_term }}{% endif %}{% if c.props.TextAuto %}\nAuto-Entered Text: {{ c.props.TextAuto }}{% endif %}"
              style="white-space:normal;">

            <div class="rc-wrap">
              {# Prompt / caption #}
              <label class="rc-prompt" for="{{ c.name }}_yes">{{ c.rc_prompt }}</label>

              {# --- CASE A: Question with Negation (unchanged) ------------------------- #}
              {% if c.rc_is_question and c.rc_has_negation %}
                <label class="rc-yes-label">
                  <input id="{{ c.name }}_yes"
                        class="rc-yesno"
                        data-pair="{{ c.name }}_no"
                        name="{{ c.name }}_checked_yes"
                        type="checkbox"
                        value="{{ c.rc_code|default:'' }}"
                        tabindex="{{ c.props.TabOrder|default:'0' }}"
                        style="vertical-align:middle;"
                        {% if c.props.bPresentQualChecked == 'True' %}checked{% endif %}>
                  yes
                </label>

                <label class="rc-no-label">
                  <input id="{{ c.name }}_no"
                        class="rc-yesno"
                        data-pair="{{ c.name }}_yes"
                        name="{{ c.name }}_checked_no"
                        type="checkbox"
                        value="{% if c.rc_code %}{{ c.rc_neg_prefix }}{{ c.rc_code }}{% endif %}"
                        tabindex="{{ c.props.TabOrder|default:'0' }}"
                        style="vertical-align:middle;"
                        {% if c.props.bPresentQualChecked == 'True' %}checked{% endif %}>
                  no
                </label>

                {% if c.rc_has_text %}
                  <input id="{{ c.name }}_text"
                        name="{{ c.name }}_text"
                        type="text"
                        {% if c.rc_required %}required{% endif %}
                        disabled
                        value="{{ c.props.TextPrompt|default:'' }}"
                        style="width:{% if c.rc_prompt_width_ch %}{% widthratio c.rc_prompt_width_ch 10 8 %}ch{% else %}100px{% endif %}; vertical-align:middle; font-size:85%;">
                {% endif %}

              {# --- CASE B: Pure value-only ReadCode (no checkbox; enabled by default) - #}
              {% elif c.rc_has_value and not c.rc_is_question and not c.rc_has_text %}
                <input id="{{ c.name }}_val"
                      name="{{ c.name }}_val"
                      type="text"
                      inputmode="decimal"
                      class="rc-val"
                      style="vertical-align:middle;">
                {% if c.rc_value_unit %}<span>{{ c.rc_value_unit }}</span>{% endif %}

              {# --- CASE C: Simple ReadCode -------------------------------------------- #}
              {% else %}
                {% if c.rc_qual_present and 'Negation' in c.rc_qualifiers|default:'' %}
                  <label class="rc-yes-label">
                    <input id="{{ c.name }}_yes_simple"
                          class="rc-yesno"
                          data-pair="{{ c.name }}_no_simple"
                          name="{{ c.name }}_checked_yes"
                          type="checkbox"
                          value="{{ c.rc_code|default:'' }}"
                          tabindex="{{ c.props.TabOrder|default:'0' }}"
                          style="vertical-align:middle;"
                          {% if c.props.bPresentQualChecked == 'True' %}checked{% endif %}>
                    <span class="sr-only">yes</span>  {# keep for logic; not visible #}
                  </label>

                  <label class="rc-no-label" style="margin-left:6px;">
                    <input id="{{ c.name }}_no_simple"
                          class="rc-yesno"
                          data-pair="{{ c.name }}_yes_simple"
                          name="{{ c.name }}_checked_no"
                          type="checkbox"
                          value="{% if c.rc_code %}{{ c.rc_neg_prefix }}{{ c.rc_code }}{% endif %}"
                          tabindex="{{ c.props.TabOrder|default:'0' }}"
                          style="vertical-align:middle;"
                          {% if c.props.bPresentQualChecked == 'True' %}checked{% endif %}>
                    no
                  </label>
                {% else %}
                  {# Fallback: single checkbox toggles dependent fields #}
                  <input id="{{ c.name }}_chk"
                        class="rc-chk"
                        data-targets="{% if c.rc_has_text %}{{ c.name }}_text{% endif %}{% if c.rc_has_value %}{% if c.rc_has_text %},{% endif %}{{ c.name }}_val{% endif %}{% if c.rc_has_datepicker %}{% if c.rc_has_text or c.rc_has_value %},{% endif %}{{ c.name }}_date{% endif %}"
                        name="{{ c.name }}_checked"
                        type="checkbox"
                        tabindex="{{ c.props.TabOrder|default:'0' }}"
                        style="vertical-align:middle;"
                        {% if c.props.bPresentQualChecked == 'True' %}checked{% endif %}>
                {% endif %}

                {% if c.rc_has_text %}
                  <input id="{{ c.name }}_text"
                        name="{{ c.name }}_text"
                        type="text"
                        {% if c.rc_required %}required{% endif %}
                        disabled
                        value="{{ c.props.TextPrompt|default:'' }}"
                        style="width:{% if c.rc_prompt_width_ch %}{% widthratio c.rc_prompt_width_ch 10 8 %}ch{% else %}100px{% endif %}; vertical-align:middle;">
                {% endif %}

                {% if c.rc_has_value %}
                  <input id="{{ c.name }}_val"
                        name="{{ c.name }}_val"
                        type="text"
                        inputmode="decimal"
                        disabled
                        class="rc-val"
                        style="vertical-align:middle;">
                  {% if c.rc_value_unit %}<span>{{ c.rc_value_unit }}</span>{% endif %}
                {% endif %}

              {% endif %}

              {% comment %} {# --- Optional line-break before qualifiers/date if TEX says "new line" -- #}
              {% if c.rc_qual_newline %}<i class="rc-break"></i>{% endif %} {% endcomment %}

              {# Date picker (if applicable) #}
              {% if c.rc_has_datepicker %}
                <input id="{{ c.name }}_date"
                      name="{{ c.name }}_date"
                      type="date"
                      class="rc-date"
                      tabindex="{{ c.props.TabOrder|default:'0' }}"
                      style="vertical-align:middle;">
              {% endif %}

              {# Hidden input to carry the readcode itself #}
              {% if c.rc_code %}
                <input type="hidden" name="{{ c.name }}_readcode" value="{{ c.rc_code }}">
              {% endif %}
            </div>
          </div>

          {# DiaryEntry (unchanged) #}
          {% elif 'DiaryEntry' in c.type %}
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:nowrap; white-space:nowrap; width:100%;">
              <label for="{{ c.name }}_date" style="font-weight:600; margin-right:6px; white-space:nowrap;">
                {{ c.diary_prompt }}
              </label>
              <input id="{{ c.name }}_date" name="{{ c.name }}_date" type="date" tabindex="{{ c.props.TabOrder|default:'0' }}" style="vertical-align:middle; font-size: 10.5px;">
              {% if c.diary_editbox and not c.diary_prompt_below %}
                <input id="{{ c.name }}_text" name="{{ c.name }}_text" type="text" tabindex="{{ c.props.TabOrder|default:'0' }}"
                      {% if c.diary_editbox_chars %} style="width: {{ c.diary_editbox_chars }}ch;" {% else %} style="width: 24ch;" {% endif %}>
              {% endif %}
            </div>
            {% if c.diary_editbox and c.diary_prompt_below %}
              <div style="margin-top:4px;">
                <input id="{{ c.name }}_text" name="{{ c.name }}_text" type="text" tabindex="{{ c.props.TabOrder|default:'0' }}"
                      {% if c.diary_editbox_chars %} style="width: {{ c.diary_editbox_chars }}ch;" {% else %} style="width: 24ch;" {% endif %}>
              </div>
            {% endif %}
            {% if c.diary_readcode %}
              <input type="hidden" name="{{ c.name }}_readcode" value="{{ c.diary_readcode }}">
            {% endif %}

          {# TTplLastEntry: read-only date, no label, optional tooltip of its read code #}
          {% elif 'LastEntry' in c.type or c.is_lastentry %}
          <input
            type="date"
            class="tpl-lastentry readcode-host"
            {% if c.le_code or c.le_term %}
              data-readcodes="Last Entry for {{ c.le_code|default:'' }}{% if c.le_term %} — {{ c.le_term }}{% endif %}"
              title="{{ c.le_code|default:'' }}{% if c.le_term %} — {{ c.le_term }}{% endif %}"
            {% endif %}
            disabled
            style="width: 100px; font-size: 10px;">
          
          {% elif 'Panel' in c.type %}

          {% elif 'Bevel' in c.type %}

          {% elif 'FORM' in c.type %}

          {% elif 'Group' in c.type %}

          {% elif 'Btn' in c.type %}
            <button type="button" name="{{ c.name }}" tabindex="{{ c.props.TabOrder|default:'0' }}" style="font-size: 9px;">
              Prev Data
            </button>

          {# TTplAvgBP: fixed read-only average blood pressure #}
          {% elif 'AvgBP' in c.type %}
          <span class="tpl-avgbp" style="font-size: 10.5px;padding-left: 10px">
              125/85
          </span>

          {# --- TTplIdealWeight ---------------------------------------------------- #}
          {% elif 'IdealWeight' in c.type %}
          <div class="rc-row readcode-host" style="white-space:nowrap;" data-readcodes="66CB. — Ideal Weight">
            <label for="{{ c.name }}_chk" style="margin-right:4px;">Ideal Weight</label>
            <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
                  tabindex="{{ c.props.TabOrder|default:'0' }}"
                  style="margin-right:0px; vertical-align:middle;">
            <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
                  readonly style="width:20px; vertical-align:middle;">
            <span style="margin-left:2px;">kg</span>
          </div>

          {# --- TTplBMI ------------------------------------------------------------ #}
          {% elif 'BMI' in c.type %}
          <div class="rc-row readcode-host" style="white-space:nowrap;" data-readcodes="22K.. — Body Mass Index">
            <label for="{{ c.name }}_chk" style="margin-right:4px;">BMI</label>
            <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
                  tabindex="{{ c.props.TabOrder|default:'0' }}"
                  style="margin-right:0px; vertical-align:middle;">
            <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
                  readonly style="width:25px; vertical-align:middle;">
            <span style="margin-left:2px;">kg/m²</span>
          </div>

          {# --- TTplExpPeakFlow ---------------------------------------------------- #}
          {% elif 'ExpPeakFlow' in c.type %}
          <div class="rc-row readcode-host" style="white-space:nowrap;" data-readcodes="339p. — Expected PEFR">
            <label for="{{ c.name }}_chk" style="margin-right:6px;">Predicted PEFR</label>
            <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
                  tabindex="{{ c.props.TabOrder|default:'0' }}"
                  style="margin-right:8px; vertical-align:middle;">
            <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
                  readonly style="width:25px; vertical-align:middle;">
            <span style="margin-left:2px;">L/min</span>
          </div>

          {# import_tex.html #}
          {% elif 'PULHHEEMS' in c.type %}
            <div class="pulhheems-widget"
                style="position:relative; left:0; top:0; width:100%; height:100%; box-sizing:border-box; padding:10px;margin-top:5px;">
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; height:100%;">
                {# LEFT SIDE #}
                <div class="pul-left" style="display:grid; grid-auto-rows:min-content; row-gap:8px;">

                  <div class="row readcode-host" style="display:grid; grid-template-columns: 80px 40px 20px auto; align-items:center; gap:6px;margin-top:7px;" 
                      data-readcodes="RAFPUP01 — P0\u000ARAFPUP02 — P0R\u000ARAFPUP21 — P2\u000ARAFPUP22 — P2R\u000ARAFPUP31 — P3\u000ARAFPUP32 — P3R\u000ARAFPUP41 — P4\u000ARAFPUP42 — P4R\u000ARAFPUP71 — P7\u000ARAFPUP72 — P7R\u000ARAFPUP81 — P8\u000ARAFPUP82 — P8R">
                    <label>Physical</label>
                    <select name="{{ c.name }}_physical" style="width:40px;">
                      <option>2</option><option>3</option>
                      <option>4</option><option>7</option><option>8</option><option>0</option>
                    </select>
                    <input type="checkbox" name="{{ c.name }}_physical_remedial">
                    <label>Remedial</label>
                  </div>

                  <div class="row readcode-host"
                    style="display:grid; grid-template-columns: 80px 40px 20px auto; align-items:center; gap:6px; margin-top:7px;"
                    data-readcodes="RAFPUU01 — U0\u000ARAFPUU02 — U0R\u000ARAFPUU21 — U2\u000ARAFPUU22 — U2R\u000ARAFPUU31 — U3\u000ARAFPUU32 — U3R\u000ARAFPUU71 — U7\u000ARAFPUU72 — U7R\u000ARAFPUU81 — U8\u000ARAFPUU82 — U8R">
                    <label>Upper Limbs</label>
                    <select name="{{ c.name }}_upper" style="width:40px;">
                      <option>2</option><option>3</option>
                      <option>7</option><option>8</option><option>0</option>
                    </select>
                    <input type="checkbox" name="{{ c.name }}_upper_remedial">
                    <label>Remedial</label>
                  </div>

                  <div class="row readcode-host"
                      style="display:grid; grid-template-columns: 80px 40px 20px auto; align-items:center; gap:6px; margin-top:7px;"
                      data-readcodes="RAFPUL01 — L0\u000ARAFPUL02 — L0R\u000ARAFPUL21 — L2\u000ARAFPUL22 — L2R\u000ARAFPUL31 — L3\u000ARAFPUL32 — L3R\u000ARAFPUL71 — L7\u000ARAFPUL72 — L7R\u000ARAFPUL81 — L8\u000ARAFPUL82 — L8R">
                    <label>Lower Limbs</label>
                    <select name="{{ c.name }}_lower">
                      <option>2</option><option>3</option>
                      <option>7</option><option>8</option><option>0</option>
                    </select>
                    <input type="checkbox" name="{{ c.name }}_lower_remedial">
                    <label>Remedial</label>
                  </div>      

                  <div class="row" style="display:grid; grid-template-columns: 70px 85px 80px; align-items:center; margin-top:14px;">
                    <span></span>
                    <strong style="text-align:center;">Right</strong>
                    <strong style="text-align:center;">Left</strong>
                  </div>

                  <div class="row" style="display:grid; grid-template-columns: 80px 80px 80px; align-items:center; gap:6px;margin-top:14px;">
                    <label>Hearing</label>
                    <input type="text" value="2" readonly style="width:40px; text-align:center;">
                    <input type="text" value="2" readonly style="width:40px; text-align:center;">
                  </div>

                  <div class="row" style="display:grid; grid-template-columns: 70px 80px 80px; align-items:center; gap:6px;margin-top:14px;">
                    <span></span>
                    <div style="display:flex; justify-content:space-around; width:100%;">
                      <label>U</label><label>C</label>
                    </div>
                    <div style="display:flex; justify-content:space-around; width:100%;">
                      <label>U</label><label>C</label>
                    </div>
                  </div>

                  <div class="row" style="display:grid; grid-template-columns: 70px 80px 80px; align-items:center; gap:7px;margin-top:5px;">
                    <label>Eyes</label>
                    <div style="display:flex; justify-content:space-around; width:100%; gap:6px;">
                      <input type="text" value="2" readonly style="width:24px; text-align:center;">
                      <input type="text" value="" readonly style="width:24px; text-align:center;">
                    </div>
                    <div style="display:flex; justify-content:space-around; width:100%; gap:6px;">
                      <input type="text" value="2" readonly style="width:24px; text-align:center;">
                      <input type="text" value="" readonly style="width:24px; text-align:center;">
                    </div>
                  </div>

                  <div class="row readcode-host"
                      style="display:grid; grid-template-columns: 80px 40px; align-items:center; gap:6px; margin-top:14px;"
                      data-readcodes="RAFPUM21 — M2\u000ARAFPUM31 — M3\u000ARAFPUM71 — M7\u000ARAFPUM81 — M8">
                    <label>Mental</label>
                    <select name="{{ c.name }}_mental" style="width:40px;">
                      <option>2</option><option>3</option><option>7</option><option>8</option>
                    </select>
                  </div>

                  <div class="row readcode-host"
                      style="display:grid; grid-template-columns: 80px 40px 20px auto; align-items:center; gap:6px; margin-top:7px;"
                      data-readcodes="RAFPUS01 — S0\u000ARAFPUS02 — S0R\u000ARAFPUS21 — S2\u000ARAFPUS22 — S2R\u000ARAFPUS31 — S3\u000ARAFPUS32 — S3R\u000ARAFPUS71 — S7\u000ARAFPUS72 — S7R\u000ARAFPUS81 — S8\u000ARAFPUS82 — S8R">
                    <label>Stability</label>
                    <select name="{{ c.name }}_stability" style="width:40px;">
                      <option>2</option><option>3</option><option>7</option><option>8</option><option>0</option>
                    </select>
                    <input type="checkbox" name="{{ c.name }}_stability_remedial">
                    <label>Remedial</label>
                  </div>
                </div>


              {# RIGHT SIDE #}
              <div class="pul-right" style="display:grid; grid-auto-rows:min-content; row-gap:10px;">
                <fieldset class="readcode-host"
                          style="padding:6px 8px;"
                          data-readcodes="TRIQQNMF1 — MFD - Medically Fully Deployable\u000ATRIQQNML1 — MLD - Medically Limited Deployable\u000ATRIQQNMN1 — MND - Medically Not Deployable">
                  <legend>Medical Deployability</legend>
                  <label><input type="radio" name="{{ c.name }}_deploy" value="Full"> Full</label>
                  <label style="margin-left:12px;"><input type="radio" name="{{ c.name }}_deploy" value="Limited"> Limited</label>
                  <label style="margin-left:12px;"><input type="radio" name="{{ c.name }}_deploy" value="Not"> Not</label>
                </fieldset>

                <label>JMES</label>
                <div class="jmes-row" style="display:grid; grid-template-columns:auto auto auto auto auto auto auto auto; align-items:center; gap:6px;margin-top:3px;">
                  <label>A</label>
                  <select name="{{ c.name }}_jmes_A" class="readcode-host"
                          data-readcodes="TRIQQNA11 — A1 - Fit for flying duties without restriction\u000ATRIQQNA21 — A2 - Fit for flying duties but has reduced hearing or eyesight\u000ATRIQQNA31 — A3 - Fit for duties in the air within the stated employment or MedLims\u000ATRIQQNA41 — A4 - Fit to be flown in a passenger aircraft\u000ATRIQQNA51 — A5 - Unfit to be taken in the air\u000ATRIQQNA61 — A6 - Unfit for any duties in the aviation environment">
                    {% for i in "123456"|make_list %}
                      <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                  </select>
                  <label>L</label>
                  <select name="{{ c.name }}_jmes_L" class="readcode-host"
                          data-readcodes="TRIQQNL11 — L1 - Fit for unrestricted duty\u000ATRIQQNL21 — L2 - Fit for high readiness roles with minor limitations\u000ATRIQQNL31 — L3 - Fit for limited duties but with some restriction subject to MRA\u000ATRIQQNL41 — L4 - Fit for certain deployed roles into well-established MOB locations subject to Consultant Occupational Physician MRA\u000ATRIQQNL51 — L5 - Unfit deployment. Fit for branch/trade and limited UK operations\u000ATRIQQNL61 — L6 - Unfit for service in the land environment">
                    {% for i in "123456"|make_list %}
                      <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                  </select>

                  <label>M</label>
                  <select name="{{ c.name }}_jmes_M" class="readcode-host"
                          data-readcodes="TRIQQNM11 — M1 - Fit for unrestricted duties\u000ATRIQQNM21 — M2 - Fit for restricted duties afloat within the limitations as stated\u000ATRIQQNM31 — M3 - Fit for restricted duties in a vessel in harbour or alongside with the limitations as stated\u000ATRIQQNM41 — M4 - Fit to be carried as embarked forces in transit\u000ATRIQQNM51 — M5 - Fit for restricted duties ashore within the limitations as stated\u000ATRIQQNM61 — M6 - Unfit for any duties in the maritime environment">
                    {% for i in "123456"|make_list %}
                      <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                  </select>

                  <label>E</label>
                  <select name="{{ c.name }}_jmes_E" class="readcode-host"
                          data-readcodes="TRIQQNE11 — E1 - Fit for worldwide service in all environments\u000ATRIQQNE21 — E2 - Fit for unrestricted duties but with a medical risk marker\u000ATRIQQNE31 — E3 - Restricted employment outside UK due to medical support or environmental requirements\u000ATRIQQNE41 — E4 - Only to be employed out of the UK with access to established, 'NHS equivalent or better' Primary and Secondary Healthcare\u000ATRIQQNE51 — E5 - May be employed within the UK only\u000ATRIQQNE61 — E6 - Pregnancy/Maternity">
                    {% for i in "123456"|make_list %}
                      <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                  </select>

                </div>
                <div style="display:flex; align-items:center; gap:8px;margin-top:5px;">
                  <label>JMES Status</label>
                  <select name="{{ c.name }}_jmes_status" class="readcode-host"
                          data-readcodes="RAFMETE5 — Temporary MES\u000ARAFMEPE1 — Permanent MES\u000ARAFMENO3 — Not Applicable">
                    <option>Temporary</option>
                    <option>Permanent</option>
                    <option>Not Applicable</option>
                  </select>
                </div>


                <div style="display:flex; align-items:center; gap:8px;margin-top:5px;">
                  <label>Review Date</label>
                  <input type="date" name="{{ c.name }}_review_date" class="readcode-host"
                        data-diary="1"
                        data-readcodes="RAFPUPU1 — Diary entry for PULHHEEMS Profile">
                </div>

                <div style="margin-top:5px;">
                  <label>Notes</label>
                  <textarea name="{{ c.name }}_notes" rows="1" style="width:100%; box-sizing:border-box;margin-top:10px;"></textarea>
                </div>
              </div>
            </div>
          </div>

          {% elif 'VisualAcuity' in c.type %}
          <div class="visual-acuity-widget"
              style="position:relative; left:0; top:0; width:100%; height:100%; box-sizing:border-box; padding:10px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 180px; column-gap:14px; row-gap:10px; height:100%;">

              {# ---- Top row: Uncorrected ---- #}
              <div>
                <div style="font-weight:600; margin-bottom:4px;">Right Eye Uncorrected</div>
                <select name="{{ c.name }}_right_uncorr" size="7" style="width:100%;"
                        class="readcode-host"
                        data-readcodes="2B6D — O/E - visual acuity R-eye=6/4\u000A2B61 — O/E - visual acuity R-eye =6/5\u000A2B62 — O/E - visual acuity R-eye =6/6\u000A2B6d — O/E - visual acuity right eye = 6/7.5\u000A2B63 — O/E - visual acuity R-eye =6/9\u000A2B64 — O/E - visual acuity R-eye=6/12\u000A2B6b — O/E- visual acuity R-eye =6/15\u000A2B65 — O/E - visual acuity R-eye=6/18\u000A2B66 — O/E - visual acuity R-eye=6/24\u000A2B67 — O/E - visual acuity R-eye=6/36\u000A2B6e — O/E - visual acuity right eye = 6/48\u000A2B68 — O/E - visual acuity R-eye=6/60\u000A2B69 — O/E -R-eye counts fingers only\u000A2B6C — O/E - R-eye sees hand movements\u000A2B6A — O/E-R-eye perceives light only\u000A2B6A — O/E - blind R-eye\u000A2B6B — O/E - R-eye completely blind">
                  <option>O/E - visual acuity R-eye=6/4</option>
                  <option>O/E - visual acuity R-eye =6/5</option>
                  <option>O/E - visual acuity R-eye =6/6</option>
                  <option>O/E - visual acuity right eye = 6/7.5</option>
                  <option>O/E - visual acuity R-eye =6/9</option>
                  <option>O/E - visual acuity R-eye=6/12</option>
                  <option>O/E- visual acuity R-eye =6/15</option>
                  <option>O/E - visual acuity R-eye=6/18</option>
                  <option>O/E - visual acuity R-eye=6/24</option>
                  <option>O/E - visual acuity R-eye=6/36</option>
                  <option>O/E - visual acuity right eye = 6/48</option>
                  <option>O/E - visual acuity R-eye=6/60</option>
                  <option>O/E -R-eye counts fingers only</option>
                  <option>O/E - R-eye sees hand movements</option>
                  <option>O/E-R-eye perceives light only</option>
                  <option>O/E - blind R-eye</option>
                  <option>O/E - R-eye completely blind</option>
                </select>
              </div>

              <div>
                <div style="font-weight:600; margin-bottom:4px;">Left Eye Uncorrected</div>
                <select name="{{ c.name }}_left_uncorr" size="7" style="width:100%;"
                        class="readcode-host"
                        data-readcodes="2B7D — O/E - visual acuity L-eye =6/4\u000A2B71 — O/E - visual acuity L-eye =6/5\u000A2B72 — O/E - visual acuity L-eye =6/6\u000A2B7e — O/E - visual acuity left eye = 6/7.5\u000A2B73 — O/E - visual acuity L-eye =6/9\u000A2B74 — O/E - visual acuity L-eye=6/12\u000A2B7b — O/E- visual acuity L-eye =6/15\u000A2B75 — O/E - visual acuity L-eye=6/18\u000A2B76 — O/E - visual acuity L-eye=6/24\u000A2B77 — O/E - visual acuity L-eye=6/36\u000A2B7d — O/E - visual acuity left eye = 6/48\u000A2B78 — O/E - visual acuity L-eye=6/60\u000A2B79 — O/E -L-eye counts fingers only\u000A2B7C — O/E - L-eye sees hand movements\u000A2B7A — O/E-L-eye perceives light only\u000A2B7A — O/E - blind L-eye\u000A2B7B — O/E - L-eye completely blind">
                  <option>O/E - visual acuity L-eye =6/4</option>
                  <option>O/E - visual acuity L-eye =6/5</option>
                  <option>O/E - visual acuity L-eye =6/6</option>
                  <option>O/E - visual acuity left eye = 6/7.5</option>
                  <option>O/E - visual acuity L-eye =6/9</option>
                  <option>O/E - visual acuity L-eye=6/12</option>
                  <option>O/E- visual acuity L-eye =6/15</option>
                  <option>O/E - visual acuity L-eye=6/18</option>
                  <option>O/E - visual acuity L-eye=6/24</option>
                  <option>O/E - visual acuity L-eye=6/36</option>
                  <option>O/E - visual acuity left eye = 6/48</option>
                  <option>O/E - visual acuity L-eye=6/60</option>
                  <option>O/E -L-eye counts fingers only</option>
                  <option>O/E - L-eye sees hand movements</option>
                  <option>O/E-L-eye perceives light only</option>
                  <option>O/E - blind L-eye</option>
                  <option>O/E - L-eye completely blind</option>
                </select>
              </div>

              {# ---- Summary column (independently offset vertically) ---- #}
              <div class="summary-col" style="padding-top:60px;">
                <div class="row" style="display:grid; grid-template-columns: 70px 1fr 1fr; align-items:center; margin-top:2px;">
                  <span></span>
                  <strong style="text-align:center;">Right</strong>
                  <strong style="text-align:center;">Left</strong>
                </div>

                <div class="row" style="display:grid; grid-template-columns: 70px 1fr 1fr; align-items:center; gap:6px; margin-top:10px;">
                  <span></span>
                  <div style="display:flex; justify-content:space-around; width:100%;"><label>U</label><label>C</label></div>
                  <div style="display:flex; justify-content:space-around; width:100%;"><label>U</label><label>C</label></div>
                </div>

                <div class="row" style="display:grid; grid-template-columns: 70px 1fr 1fr; align-items:center; gap:6px; margin-top:6px;">
                  <label>Eyes</label>

                  {# Right U/C summary boxes with their own code lists #}
                  <div style="display:flex; justify-content:space-around; width:100%; gap:6px;">
                    <input type="text" name="{{ c.name }}_right_U" readonly style="width:12px; text-align:center;"
                          class="readcode-host"
                          data-readcodes="RAFPUER1 — Eur1\u000ARAFPUER2 — Eur2\u000ARAFPUER3 — Eur3\u000ARAFPUER4 — Eur4\u000ARAFPUER5 — Eur5\u000ARAFPUER6 — Eur6\u000ARAFPUER7 — Eur7\u000ARAFPUER8 — Eur8">
                    <input type="text" name="{{ c.name }}_right_C" readonly style="width:12px; text-align:center;"
                          class="readcode-host"
                          data-readcodes="RAFPUEC17 — Ecr1\u000ARAFPUEC2 — Ecr2\u000ARAFPUEC3 — Ecr3\u000ARAFPUEC4 — Ecr4\u000ARAFPUEC5 — Ecr5\u000ARAFPUEC6 — Ecr6\u000ARAFPUEC7 — Ecr7\u000ARAFPUEC8 — Ecr8">
                  </div>

                  {# Left U/C summary boxes with their own code lists #}
                  <div style="display:flex; justify-content:space-around; width:100%; gap:6px;">
                    <input type="text" name="{{ c.name }}_left_U" readonly style="width:12px; text-align:center;"
                          class="readcode-host"
                          data-readcodes="RAFPUEL3 — Eul1\u000ARAFPUEL4 — Eul2\u000ARAFPUEL5 — Eul3\u000ARAFPUEL6 — Eul4\u000ARAFPUEL7 — Eul5\u000ARAFPUEL8 — Eul6\u000ARAFPUEL9 — Eul7\u000ARAFPUEU1 — Eul8">
                    <input type="text" name="{{ c.name }}_left_C" readonly style="width:12px; text-align:center;"
                          class="readcode-host"
                          data-readcodes="RAFPUEC1 — Ecl1\u000ARAFPUEC10 — Ecl2\u000ARAFPUEC11 — Ecl3\u000ARAFPUEC12 — Ecl4\u000ARAFPUEC13 — Ecl5\u000ARAFPUEC14 — Ecl6\u000ARAFPUEC15 — Ecl7\u000ARAFPUEC16 — Ecl8">
                  </div>
                </div>
              </div>

              {# ---- Second row: Corrected ---- #}
              <div>
                <div style="font-weight:600; margin:8px 0 4px;">Right Eye Corrected</div>
                <select name="{{ c.name }}_right_corr" size="7" style="width:100%;"
                        class="readcode-host"
                        data-readcodes="TRIQQOE57 — O/E - visual acuity (corrected) R-eye 6/4\u000ATRISOZ2 — O/E - visual acuity (corrected) R-eye 6/5\u000ATRISOZ3 — O/E - visual acuity (corrected) R-eye 6/6\u000ATRISOZ4 — O/E - visual acuity (corrected) R-eye 6/9\u000ATRISOZ5 — O/E - visual acuity (corrected) R-eye 6/12\u000ATRISOZ6 — O/E - visual acuity (corrected) R-eye 6/18\u000ATRISOZ7 — O/E - visual acuity (corrected) R-eye 6/24\u000ATRISOZ8 — O/E - visual acuity (corrected) R-eye 6/36\u000ATRISOZ9 — O/E - visual acuity (corrected) R-eye 6/60">
                  <option>O/E - visual acuity (corrected) R-eye 6/4</option>
                  <option>O/E - visual acuity (corrected) R-eye 6/5</option>
                  <option>O/E - visual acuity (corrected) R-eye 6/6</option>
                  <option>O/E - visual acuity (corrected) R-eye 6/9</option>
                  <option>O/E - visual acuity (corrected) R-eye 6/12</option>
                  <option>O/E - visual acuity (corrected) R-eye 6/18</option>
                  <option>O/E - visual acuity (corrected) R-eye 6/24</option>
                  <option>O/E - visual acuity (corrected) R-eye 6/36</option>
                  <option>O/E - visual acuity (corrected) R-eye 6/60</option>
                </select>
              </div>

              <div>
                <div style="font-weight:600; margin:8px 0 4px;">Left Eye Corrected</div>
                <select name="{{ c.name }}_left_corr" size="7" style="width:100%;"
                        class="readcode-host"
                        data-readcodes="TRIQQOE56 — O/E - visual acuity (corrected) L-eye 6/4\u000ATRISO/39 — O/E - visual acuity (corrected) L-eye 6/5\u000ATRISO/40 — O/E - visual acuity (corrected) L-eye 6/6\u000ATRISO/41 — O/E - visual acuity (corrected) L-eye 6/9\u000ATRISO/44 — O/E - visual acuity (corrected) L-eye 6/12\u000ATRISO/46 — O/E - visual acuity (corrected) L-eye 6/18\u000ATRISO/48 — O/E - visual acuity (corrected) L-eye 6/24\u000ATRISO/61 — O/E - visual acuity (corrected) L-eye 6/36\u000ATRISO/65 — O/E - visual acuity (corrected) L-eye 6/60">
                  <option>O/E - visual acuity (corrected) L-eye 6/4</option>
                  <option>O/E - visual acuity (corrected) L-eye 6/5</option>
                  <option>O/E - visual acuity (corrected) L-eye 6/6</option>
                  <option>O/E - visual acuity (corrected) L-eye 6/9</option>
                  <option>O/E - visual acuity (corrected) L-eye 6/12</option>
                  <option>O/E - visual acuity (corrected) L-eye 6/18</option>
                  <option>O/E - visual acuity (corrected) L-eye 6/24</option>
                  <option>O/E - visual acuity (corrected) L-eye 6/36</option>
                  <option>O/E - visual acuity (corrected) L-eye 6/60</option>
                </select>
              </div>

              {# spacer #}
              <div></div>
            </div>
          </div>

          {% elif 'AudiometryCompare' in c.type %}
          <div class="audio-compare-widget"
              style="position:relative; left:0; top:0; width:100%; height:100%; box-sizing:border-box; padding:10px;">

            <!-- Top: two identical panels with Hz rows & sums (readonly) -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">

              <!-- First audiogram (left) -->
              <fieldset style="border:0;padding:10px;">
                <legend style="position:relative; left:180px;">First audiogram:</legend>

                <div style="display:grid; grid-auto-rows:min-content; row-gap:8px; align-items:center; max-width:320px;">
                <!-- Date/Time dropdown (no label) -->
                <select name="{{ c.name }}_a1_dt" style="max-width:170px;position:relative; left:120px;">
                  <option>05/04/2024 14:58</option>
                  <option>25/11/2015 09:12</option>
                </select>

                <!-- Age row -->
                <div style="display:flex; gap:8px; align-items:center;">
                  <label style="min-width:60px;position:relative; left:70px;">Age:</label>
                  <input type="text" value="44" name="{{ c.name }}_a1_age" style="width:48px;position:relative; left:50px;" readonly>
                </div>

                <!-- Reason row -->
                <div style="display:flex; gap:8px; align-items:center;">
                  <label style="min-width:90px;position:relative; left:53px;">Reason:</label>
                  <input value="Routine Audiometry" type="text" name="{{ c.name }}_a1_reason" style="width:180px;position:relative; left:20px;" readonly>
                </div>

                <!-- Hz headers + Right/Left rows (identical widths to Audiometry widget) -->
                <div style="margin-top:10px;">
                  <div style="display:grid; grid-template-columns: 30px repeat(7, 30px); gap:8px 20px; align-items:center;">
                    <span></span>
                    <div style="text-align:center;">500Hz</div>
                    <div style="text-align:center;">1KHz</div>
                    <div style="text-align:center;">2KHz</div>
                    <div style="text-align:center;">3KHz</div>
                    <div style="text-align:center;">4KHz</div>
                    <div style="text-align:center;">6KHz</div>
                    <div style="text-align:center;">8KHz</div>

                    <div>R (dB)</div>
                    {% for val in ac_1_r %}
                      <input type="text"
                            name="{{ c.name }}_a1_r{{ forloop.counter }}"
                            value="{{ val }}"
                            style="width:30px; height:18px; text-align:center;"
                            readonly>
                    {% endfor %}

                    <div>L (dB)</div>
                    {% for val in ac_1_l %}
                      <input type="text" name="{{ c.name }}_a1_l{{ forloop.counter }}" 
                              value="{{ val }}"
                              style="width:30px; height:18px; text-align:center;" 
                              readonly>
                    {% endfor %}
                  </div>
                </div>

                <!-- Sums / H grade (same labels & widths) -->
                <div style="display:grid; grid-template-columns: 60px repeat(3, 70px); gap:8px 20px; align-items:center; margin-top:10px;">
                  <span></span><div>Sum of Low</div><div>Sum of High</div><div>H Grade</div>

                  <div style="position:relative; left:50px;">R</div>
                  <input type="text" name="{{ c.name }}_a1_r_sum_low"  value="30" style="width:30px; height:18px; text-align:center;" readonly>
                  <input type="text" name="{{ c.name }}_a1_r_sum_high" value="75" style="width:30px; height:18px; text-align:center;" readonly>
                  <input type="text" name="{{ c.name }}_a1_r_hgrade"   value="2" style="width:30px; height:18px; text-align:center;" readonly>

                  <div style="position:relative; left:50px;">L</div>
                  <input type="text" name="{{ c.name }}_a1_l_sum_low"  value="25" style="width:30px; height:18px; text-align:center;" readonly>
                  <input type="text" name="{{ c.name }}_a1_l_sum_high" value="55" style="width:30px; height:18px; text-align:center;" readonly>
                  <input type="text" name="{{ c.name }}_a1_l_hgrade"   value="2" style="width:30px; height:18px; text-align:center;" readonly>
                </div>
              </fieldset>

              <!-- Second audiogram (right) -->
            <fieldset style="border:0;padding:10px;">
                <legend style="position:relative; left:180px;">Second audiogram:</legend>

                <div style="display:grid; grid-auto-rows:min-content; row-gap:8px; align-items:center; max-width:420px;">
                <!-- Date/Time dropdown (no label) -->
                <select name="{{ c.name }}_a2_dt" style="max-width:180px;position:relative; left:120px;">
                  <option>05/04/2024 14:58</option>
                  <option selected>25/11/2015 09:12</option>
                </select>

                <!-- Age row -->
                <div style="display:flex; gap:8px; align-items:center;">
                  <label style="min-width:110px;position:relative; left:70px;">Age:</label>
                  <input type="text" value="35" name="{{ c.name }}_a2_age" style="width:48px;" readonly>
                  <label style="min-width:110px;">Age Difference:</label>
                  <input type="text" value="8/4" name="{{ c.name }}_age_diff" style="width:48px;" readonly>
                </div>

                <!-- Reason row -->
                <div style="display:flex; gap:8px; align-items:center;">
                  <label style="min-width:110px;position:relative; left:53px;">Reason:</label>
                  <input value="Routine Audiometry" type="text" name="{{ c.name }}_a2_reason" style="width:180px;" readonly>
                </div>

                <!-- Hz headers + Right/Left rows (identical to left) -->
                <div style="margin-top:10px;">
                  <div style="display:grid; grid-template-columns: 30px repeat(7, 30px); gap:8px 20px; align-items:center;">
                    <span></span>
                    <div style="text-align:center;">500Hz</div>
                    <div style="text-align:center;">1KHz</div>
                    <div style="text-align:center;">2KHz</div>
                    <div style="text-align:center;">3KHz</div>
                    <div style="text-align:center;">4KHz</div>
                    <div style="text-align:center;">6KHz</div>
                    <div style="text-align:center;">8KHz</div>

                    <div>R (dB)</div>
                    {% for val in ac_2_r %}
                      <input type="text" 
                            name="{{ c.name }}_a2_r{{ forloop.counter }}" 
                            value="{{ val }}"
                            style="width:30px; height:18px; text-align:center;" 
                            readonly>
                    {% endfor %}

                    <div>L (dB)</div>
                    {% for val in ac_2_l %}
                      <input type="text" 
                          name="{{ c.name }}_a2_l{{ forloop.counter }}" 
                          value="{{ val }}"
                          style="width:30px; height:18px; text-align:center;" 
                          readonly>
                    {% endfor %}
                  </div>
                </div>

                <!-- Sums / H grade (identical) -->
                <div style="display:grid; grid-template-columns: 60px repeat(3, 70px); gap:8px 20px; align-items:center; margin-top:10px;">
                  <span></span><div>Sum of Low</div><div>Sum of High</div><div>H Grade</div>

                  <div style="position:relative; left:50px;">R</div>
                  <input type="text" name="{{ c.name }}_a2_r_sum_low"  value="15" style="width:30px; height:18px; text-align:center;" readonly>
                  <input type="text" name="{{ c.name }}_a2_r_sum_high" value="15" style="width:30px; height:18px; text-align:center;" readonly>
                  <input type="text" name="{{ c.name }}_a2_r_hgrade"   value="1" style="width:30px; height:18px; text-align:center;" readonly>

                  <div style="position:relative; left:50px;">L</div>
                  <input type="text" name="{{ c.name }}_a2_l_sum_low"  value="15" style="width:30px; height:18px; text-align:center;" readonly>
                  <input type="text" name="{{ c.name }}_a2_l_sum_high" value="15" style="width:30px; height:18px; text-align:center;" readonly>
                  <input type="text" name="{{ c.name }}_a2_l_hgrade"   value="1" style="width:30px; height:18px; text-align:center;" readonly>
                </div>
              </fieldset>

            </div>

            <!-- Bottom -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:14px; justify-items:start;">

              <!-- Left chart -->
              <div class="audio-frame" style="position:relative; width:432px; height:370px; border:1px solid #bbb; background:#fafafa;">
                <!-- Plot area with gutters identical to entry widget -->
                <div class="plot-pane"
                    style="position:absolute; left:56px; top:12px; right:110px; bottom:42px;
                            background:#fff;
                            border-left:3px solid #000;   /* Y axis */
                            border-bottom:3px solid #000; /* X axis */
                            border-top:1px solid #999; border-right:1px solid #999;"></div>

                <!-- Canvas slot (JS will size/position the canvas here) -->
                <div class="audio-canvas-slot"
                    style="position:absolute; left:56px; top:12px; right:110px; bottom:42px;"></div>

                <!-- Legend in right gutter -->
                <div style="position:absolute; right:14px; top:14px;
                            background:#fff; border:1px solid #000; padding:3px 6px; font-size:11px;
                            box-shadow:3px 3px 0 #000;">
                  <div>
                    <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#d00; margin-right:6px;"></span>
                    Right ear
                  </div>
                  <div style="margin-top:2px;">
                    <span style="display:inline-block; width:8px; height:8px; margin-right:6px; position:relative;">
                      <span style="position:absolute; top:0; left:50%; width:2px; height:100%; background:#06c; transform:rotate(45deg);  transform-origin:center;"></span>
                      <span style="position:absolute; top:0; left:50%; width:2px; height:100%; background:#06c; transform:rotate(-45deg); transform-origin:center;"></span>
                    </span>
                    Left ear
                  </div>
                </div>

                <!-- Axis titles (left/bottom gutters) -->
                <div style="position:absolute; left:6px; top:50%; transform:translateY(-50%) rotate(-90deg); transform-origin:left top; font-size:11px; color:#333;">
                  Hearing Level (dB)
                </div>
                <div style="position:absolute; left:50%; bottom:6px; transform:translateX(-50%); font-size:11px; color:#333;">
                  Frequency (Hz)
                </div>
              </div>

              <!-- Right chart -->
              <div class="audio-frame" style="position:relative; width:432px; height:370px; border:1px solid #bbb; background:#fafafa;">
                <div class="plot-pane"
                    style="position:absolute; left:56px; top:12px; right:110px; bottom:42px;
                            background:#fff;
                            border-left:3px solid #000;
                            border-bottom:3px solid #000;
                            border-top:1px solid #999; border-right:1px solid #999;"></div>

                <div class="audio-canvas-slot"
                    style="position:absolute; left:56px; top:12px; right:110px; bottom:42px;"></div>

                <div style="position:absolute; right:14px; top:14px;
                            background:#fff; border:1px solid #000; padding:3px 6px; font-size:11px;
                            box-shadow:3px 3px 0 #000;">
                  <div>
                    <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#d00; margin-right:6px;"></span>
                    Right ear
                  </div>
                  <div style="margin-top:2px;">
                    <span style="display:inline-block; width:8px; height:8px; margin-right:6px; position:relative;">
                      <span style="position:absolute; top:0; left:50%; width:2px; height:100%; background:#06c; transform:rotate(45deg);  transform-origin:center;"></span>
                      <span style="position:absolute; top:0; left:50%; width:2px; height:100%; background:#06c; transform:rotate(-45deg); transform-origin:center;"></span>
                    </span>
                    Left ear
                  </div>
                </div>

                <div style="position:absolute; left:6px; top:50%; transform:translateY(-50%) rotate(-90deg); transform-origin:left top; font-size:11px; color:#333;">
                  Hearing Level (dB)
                </div>
                <div style="position:absolute; left:50%; bottom:6px; transform:translateX(-50%); font-size:11px; color:#333;">
                  Frequency (Hz)
                </div>
              </div>
            </div>

            <div style="text-align:center; margin-top:10px;">
              <button type="button" id="btn-comp-analysis">Analyse</button>
            </div>
            <form id="analysis-form2" target="_blank" method="post" action="{% url 'audiogram_analysis' %}" style="display:none;">
              {% csrf_token %}
              <input type="hidden" name="payload" id="analysis-payload">
            </form>
          </div>


          {% elif 'Audiometry' in c.type %}
          <div class="audiometry-widget" style="position:relative; left:0; top:0; width:100%; height:100%; box-sizing:border-box;">
            
            {# --- Graph / chart frame (with explicit gutters) ----------------------- #}
            <div style="position:absolute; left:140px; top:40px; width:432px; height:370px; border:1px solid #bbb; background:#fafafa;">

              {# Gutter sizes to match the screenshot #}
              {% comment %} top=12, left=56 for y-label & ticks, bottom=42 for x-label & ticks, right=110 for legend {% endcomment %}

              {# Plot pane: where the canvas goes (thick left/bottom axes, thin top/right) #}
              <div class="plot-pane"
                  style="position:absolute; left:56px; top:12px; right:110px; bottom:42px;
                          background:#fff;
                          border-left:3px solid #000;      /* Y axis */
                          border-bottom:3px solid #000;    /* X axis */
                          border-top:1px solid #999; 
                          border-right:1px solid #999;">
              </div>

              {# Canvas slot — ensure JS sizes/positions the canvas to fill this slot #}
              <div class="audio-canvas-slot"
                  style="position:absolute; left:56px; top:12px; right:110px; bottom:42px;"></div>

              {# Legend sits in the right gutter, not overlapping the plot #}
              <div style="position:absolute; right:14px; top:14px;
                          background:#fff; border:1px solid #000; padding:3px 6px; font-size:11px;
                          box-shadow:3px 3px 0 #000;">
                <div>
                  <span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#d00; margin-right:6px;"></span>
                  Right ear
                </div>
                <div style="margin-top:2px;">
                  <span style="display:inline-block; width:8px; height:8px; margin-right:6px; position:relative;">
                    <span style="position:absolute; top:0; left:50%; width:2px; height:100%; background:#06c; transform:rotate(45deg); transform-origin:center;"></span>
                    <span style="position:absolute; top:0; left:50%; width:2px; height:100%; background:#06c; transform:rotate(-45deg); transform-origin:center;"></span>
                  </span>
                  Left ear
                </div>
              </div>

              {# Axis titles occupy the left/bottom gutters #}
              <div style="position:absolute; left:6px; top:50%; transform:translateY(-50%) rotate(-90deg); transform-origin:left top; font-size:11px; color:#333;">
                Hearing Level (dB)
              </div>
              <div style="position:absolute; left:50%; bottom:6px; transform:translateX(-50%); font-size:11px; color:#333;">
                Frequency (Hz)
              </div>
            </div>


            {# --- Column headers (Hz) ------------------------------------------------ #}
            <div style="position:absolute; left:113px; top:425px; width:30px; text-align:center;">500Hz</div>
            <div style="position:absolute; left:163px; top:425px; width:30px; text-align:center;">1000Hz</div>
            <div style="position:absolute; left:213px; top:425px; width:30px; text-align:center;">2000Hz</div>
            <div style="position:absolute; left:263px; top:425px; width:30px; text-align:center;">3000Hz</div>
            <div style="position:absolute; left:313px; top:425px; width:30px; text-align:center;">4000Hz</div>
            <div style="position:absolute; left:363px; top:425px; width:30px; text-align:center;">6000Hz</div>
            <div style="position:absolute; left:413px; top:425px; width:30px; text-align:center;">8000Hz</div>

            {# --- Row labels --------------------------------------------------------- #}
            <div style="position:absolute; left:60px; top:446px;">Right (dB)</div>
            <div style="position:absolute; left:60px; top:476px;">Left (dB)</div>

            {# --- Right ear inputs (y=454) ------------------------------------------ #}
            <input class="readcode-host" data-readcodes="RAFAURI17 — Right Ear (Air)  500 Hz"
                  name="{{ c.name }}_r_500"   type="text"
                  style="position:absolute; left:113px; top:444px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAURI16 — Right Ear (Air)  1000 Hz"
                  name="{{ c.name }}_r_1000"  type="text"
                  style="position:absolute; left:163px; top:444px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAURI15 — Right Ear (Air)  2000 Hz"
                  name="{{ c.name }}_r_2000"  type="text"
                  style="position:absolute; left:213px; top:444px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAURI19 — Right Ear (Air)  3000 Hz"
                  name="{{ c.name }}_r_3000"  type="text"
                  style="position:absolute; left:263px; top:444px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAURI14 — Right Ear (Air)  4000 Hz"
                  name="{{ c.name }}_r_4000"  type="text"
                  style="position:absolute; left:313px; top:444px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAURI13 — Right Ear (Air)  6000 Hz"
                  name="{{ c.name }}_r_6000"  type="text"
                  style="position:absolute; left:363px; top:444px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAURI12 — Right Ear (Air)  8000 Hz"
                  name="{{ c.name }}_r_8000"  type="text"
                  style="position:absolute; left:413px; top:444px; width:30px; height:18px;">

            {# --- Left ear inputs (y=484) ------------------------------------------- #}
            <input class="readcode-host" data-readcodes="RAFAULE17 — Left Ear (Air)  500 Hz"
                  name="{{ c.name }}_l_500"   type="text"
                  style="position:absolute; left:113px; top:474px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAULE16 — Left Ear (Air)  1000 Hz"
                  name="{{ c.name }}_l_1000"  type="text"
                  style="position:absolute; left:163px; top:474px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAULE15 — Left Ear (Air)  2000 Hz"
                  name="{{ c.name }}_l_2000"  type="text"
                  style="position:absolute; left:213px; top:474px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAULE20 — Left Ear (Air)  3000 Hz"
                  name="{{ c.name }}_l_3000"  type="text"
                  style="position:absolute; left:263px; top:474px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAULE14 — Left Ear (Air)  4000 Hz"
                  name="{{ c.name }}_l_4000"  type="text"
                  style="position:absolute; left:313px; top:474px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAULE13 — Left Ear (Air)  6000 Hz"
                  name="{{ c.name }}_l_6000"  type="text"
                  style="position:absolute; left:363px; top:474px; width:30px; height:18px;">
            <input class="readcode-host" data-readcodes="RAFAULE12 — Left Ear (Air)  8000 Hz"
                  name="{{ c.name }}_l_8000"  type="text"
                  style="position:absolute; left:413px; top:474px; width:30px; height:18px;">


            {# --- Repeat audiogram block (unchanged legend etc.) --- #}
            <fieldset style="position:absolute; left:482px; top:430px; width:164px; height:75px; padding:4px 5px;">
              <div class="readcode-host" data-readcodes="DMSAC009 — Repeat audiogram">
                <legend>Is this a repeat audiogram?</legend>
                <label style="margin-right:14px;"><input type="radio" name="{{ c.name }}_repeat" value="Yes"> Yes</label>
                <label><input type="radio" name="{{ c.name }}_repeat" value="No"> No</label>
                </div>
                <div style="margin-top:8px;margin-left: 34px;">
                  <button id="btn-initial-analysis" type="button" class="readcode-host"
                        data-readcodes="DMSACA02 — Significant change from previous audiogram\u000ADMSACA04 — Audiogram shows acute change\u000ADMSACA05 — Audiogram shows unilateral hearing loss\u000ADMSACA06 — Audiogram shows change in H grade\u000ADMSACA07 — Audiogram is consistent with HCP pass and below the warning level\u000ADMSACA08 — Audiogram is consistent with HCP pass, but is greater than or equal to the warning level\u000ADMSACA09 — Audiogram indicates hearing loss exceeding the HCP action required level">Initial Analysis</button>
                </div>
            </fieldset>

            {# Hidden form to open analysis page in a new tab #}
            <form id="analysis-form" target="_blank" method="post" action="{% url 'audiogram_analysis' %}" style="display:none;">
              {% csrf_token %}
              <input type="hidden" name="payload" id="analysis-payload">
            </form>

            {# --- Sums / H grade (Right row y=544; Left row y=584) ------------------ #}
            <div style="position:absolute; left:113px; top:526px;">Sum L Freq.</div>
            <div style="position:absolute; left:180px; top:526px;">Sum H Freq.</div>
            <div style="position:absolute; left:250px; top:526px;">H Grade</div>

            <div style="position:absolute; left:60px; top:546px;">Right</div>
            <input class="readcode-host" data-readcodes="CABESSU2 — Sum low frequency right ear"
          name="{{ c.name }}_r_sum_low"  type="text" readonly
          style="position:absolute; left:113px; top:544px; width:30px; height:18px;">

          <input class="readcode-host" data-readcodes="CABESSU1 — Sum high frequency right ear"
                name="{{ c.name }}_r_sum_high" type="text" readonly
                style="position:absolute; left:180px; top:544px; width:30px; height:18px;">

          <input class="readcode-host" data-readcodes="RAFPUH11 — Hr1\u000ARAFPUH21 — Hr2\u000ARAFPUH31 — Hr3\u000ARAFPUHR1 — Hr4\u000ARAFPUHR2 — Hr8"
                name="{{ c.name }}_r_hgrade"   type="text" readonly
                style="position:absolute; left:250px; top:544px; width:30px; height:18px;">

          <div style="position:absolute; left:60px; top:576px;">Left</div>

          <input class="readcode-host" data-readcodes="CABESSU4 — Sum low frequency left ear"
                name="{{ c.name }}_l_sum_low"  type="text" readonly
                style="position:absolute; left:113px; top:570px; width:30px; height:18px;">

          <input class="readcode-host" data-readcodes="CABESSU3 — Sum high frequency left ear"
                name="{{ c.name }}_l_sum_high" type="text" readonly
                style="position:absolute; left:180px; top:570px; width:30px; height:18px;">

          <input class="readcode-host" data-readcodes="RAFPUHL1 — Hl1\u000ARAFPUHL2 — Hl2\u000ARAFPUHL3 — Hl3\u000ARAFPUHL4 — Hl4\u000ARAFPUHL5 — Hl8"
                name="{{ c.name }}_l_hgrade"   type="text" readonly
                style="position:absolute; left:250px; top:570px; width:30px; height:18px;">


            {# --- Right/Left/Points/Lines/Print block (452,543)-(676,607) ----------- #}
            <fieldset style="position:absolute; left:452px; top:523px; width:224px; height:60px; padding:4px 5px;">
              <div style="display:grid; grid-template-columns:auto auto min-content; grid-template-rows:auto auto; column-gap:12px; row-gap:3px; align-items:center; height:100%;">
                <label><input type="checkbox" name="{{ c.name }}_show_right" checked> Right</label>
                <label><input type="checkbox" name="{{ c.name }}_show_points"> Points</label>

                {# Print button to the right, centered between rows #}
                <button type="button" style="grid-column:3; grid-row:1 / span 2; align-self:center; justify-self:center;">Print</button>

                <label><input type="checkbox" name="{{ c.name }}_show_left" checked> Left</label>
                <label><input type="checkbox" name="{{ c.name }}_show_lines"> Lines</label>
              </div>
            </fieldset>

          </div>

          
          {# Hyperlink #}
          {% elif 'HyperLink' in c.type %}
          <a href="{{ c.props.strURL|default:'#' }}" target="_blank" rel="noopener"
            style="display:inline-block; text-decoration:underline; cursor:pointer;">
            {{ c.props.strHyperLink|default:c.props.strNormal|default:c.name }}
          </a>

          {% else %}
          <div style="border:1px solid #000;">{{ c.type }}: {{ c.name }}</div>

          {% endif %}
        </div>
        {% endif %}
        {% endfor %}
      </div>

      {# Sidebar (right) #}
      <aside id="readcodes-sidebar"
            style="width:320px; border:1px solid #ddd; padding:8px; background:#fafafa;
                    font-size:12px; position:relative; overflow:auto;">

        <div style="max-height:{{ canvas.height }}px; overflow:auto; padding-right:4px;">
          <h3 style="margin:0 0 8px;">Data Entry Read codes in form</h3>

          {% if all_read_codes %}
            <ul id="readcode-list" style="margin:0 0 12px; padding-left:18px;">
              {% for rc in all_read_codes %}
                <li class="rc-row" data-read-code="{{ rc.code }}">
                  <code class="rc-code">{{ rc.code }}</code> — <span class="rc-label">{{ rc.label }}</span>
                  <span class="rc-decision badge badge--pending" title="Decision">checking…</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p style="margin:0 0 12px; color:#666;">None detected.</p>
          {% endif %}

          <h4 style="margin:0 0 8px;">Diary entry codes</h4>
          {% if diary_read_codes %}
            <ul id="diarycode-list" style="margin:0; padding-left:18px;">
              {% for rc in diary_read_codes %}
                <li class="rc-row" data-read-code="{{ rc.code }}">
                  <code class="rc-code">{{ rc.code }}</code> — <span class="rc-label">{{ rc.label }}</span>
                  <span class="rc-decision badge badge--pending" title="Decision">checking…</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p style="margin:0; color:#666;">None detected.</p>
          {% endif %}
        </div>
      </aside>
    </div>
    </form>
  </div>
  </div>
</div>

<style>
    .tex-wrapper {
      display: flex;
      justify-content: center;   /* horizontally centre */
      width: 100%;
  }

    .badge{ margin-left:8px; padding:1px 6px; border-radius:4px; font-size:11px; border:1px solid transparent; }
    .badge--pending{ background:#eee; color:#666; }
    .badge--create{ background:#c9fcd6; border-color:#91d5ff; color:#055118; }
    .badge--ok{ background:#e6f7ff; border-color:#91d5ff; color:#096dd9; }
    .badge--warn{ background:#fffbe6; border-color:#ffe58f; color:#ad6800; }
    .badge--miss{ background:#ffffff; border-color:#ffffff; color:#ffffff; }
    .badge--loose{ background:#fb9295; border-color:#e8e8e8; color:#ffffff; }
    .rc-decision{ cursor:pointer; } 
    .readcode-highlight {
      outline: 2px solid #ffbf47;
      box-shadow: 0 0 0 3px rgba(255,191,71,.35);
      background-color: rgba(255,191,71,.08);
      transition: background-color .15s ease, box-shadow .15s ease, outline-color .15s ease;
    }
    .lib-selected { background:#e6f7ff; outline:1px solid #91d5ff; }
</style>

<style>
    #rc-tooltip{
      position:fixed;
      z-index:99999;
      display:none;
      max-width:260px;
      background:#D4D452;
      color:#111;
      font-size:12px;
      line-height:1.25;
      padding:6px 8px;
      border-radius:4px;
      box-shadow:0 2px 8px rgba(0,0,0,.35);
      white-space:pre-line;
      pointer-events:none; /* don’t steal hover */
    }
</style>

<style>
    #lib-pane-search input {
      font-size: 12px;
      padding: 4px 6px;
    }
    #lib-search-results {
      font-size: 12px;
      line-height: 1.3;
    }
    #lib-search-results div {
      padding: 2px 4px;
      cursor: pointer;
    }
    #lib-search-results div:hover {
      background: #eef;
    }

    #lib-pane-tree {
      font-size: 12px;
      line-height: 1.3;
    }
    #lib-pane-tree div {
      margin: 1px 0;
      cursor: pointer;
    }
    #lib-pane-tree div:hover {
      background: #eef;
    }
</style>

<style>
    #lib-trigger { position: relative; }
    #lib-flyout {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 2000;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
      padding: 8px;
      min-width: 340px;
      max-width: 520px;
      border-radius: 4px;
    }
    /* compact visuals inside results/tree */
    #lib-search-results div { padding: 2px 4px; cursor: pointer; }
    #lib-search-results div:hover,
    #lib-pane-tree div:hover { background: #eef; }
</style>

<style>
    .ctrl .rc-wrap{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px 8px;
      width:100%;
      max-width:100%;
      box-sizing:border-box;
      overflow:hidden;      
    }
    .ctrl .rc-wrap > *{ flex:0 0 auto; }
    .ctrl .rc-break{ flex-basis:100%; height:0; }  /* forces a line break */
    .ctrl .rc-prompt{ white-space:nowrap; max-width:100%; overflow:hidden; text-overflow:ellipsis;}
    .ctrl .rc-val{ width:40px; }
    .ctrl .rc-date{ width: 70px; font-size:10px; }
    .ctrl .rc-yes-label{ margin-right:0; }
    .ctrl .rc-no-label{ margin-right:0; }
</style>

<style>
    .sr-only{
      position:absolute !important; width:1px; height:1px;
      padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0);
      white-space:nowrap; border:0;
    }
</style>

<style>
/* Grid that forces two rows: controls (row 1), work area (row 2) */
.tex-layout{
  display:grid;
  grid-template-rows: auto auto;
  grid-template-columns: 1fr; /* single column only */
  row-gap: 16px;
  width:100%;
}
#tex-controls{
  grid-row:1; grid-column:1;
  display:block; width:100%;
}
/* keep the row contents on a single line but wrap *inside* that row, not next to row 2 */
.controls-row{
  display:flex;
  gap:12px;
  align-items:flex-end;
  flex-wrap:wrap;
}
#tex-render{
  grid-row:2; grid-column:1;
  display:block; width:100%;
}
.tex-work{
  display:flex;
  align-items:flex-start;
  gap:16px;
  width:100%;
}
@media (max-width: 900px){
  .tex-work{ flex-direction:column; }
  #readcodes-sidebar{ width:100% !important; }
}
</style>


<script>
  (function () {
    function toggleTargets(chk) {
      var ids = (chk.getAttribute('data-targets') || '').split(',').map(function (s) { return s.trim(); }).filter(Boolean);
      if (!ids.length) return;
      ids.forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.disabled = !chk.checked;
      });
      if (chk.checked) {
        var first = document.getElementById(ids[0]);
        if (first) { try { first.focus(); } catch (e) {} }
      }
    }
    document.querySelectorAll('.rc-chk').forEach(function (chk) {
      chk.addEventListener('change', function () { toggleTargets(chk); });
      toggleTargets(chk); // init
    });
  })();
</script>

<script>
  (function () {
    function setupMultiDropdown(ms) {
      var btn   = ms.querySelector('.ms-btn');
      var panel = ms.querySelector('.ms-panel');
      var label = ms.querySelector('.ms-label');

      // NEW: use existing label text (or data-caption) as the default
      var defaultCaption = (label && label.textContent.trim()) ||
                           ms.getAttribute('data-caption') ||
                           'Select…';

      function close() { panel.style.display = 'none'; btn.setAttribute('aria-expanded','false'); }
      function open()  { panel.style.display = 'block'; btn.setAttribute('aria-expanded','true'); }

      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        (panel.style.display === 'block') ? close() : open();
      });

      panel.addEventListener('click', function (e) { e.stopPropagation(); });
      document.addEventListener('click', close);

      function updateLabel() {
        var checked = panel.querySelectorAll('input[type=checkbox]:checked');
        if (checked.length === 0) {
          label.textContent = defaultCaption; 
        } else if (checked.length === 1) {
          var t = checked[0].closest('label');
          label.textContent = t ? t.textContent.trim() : defaultCaption;
        } else {
          label.textContent = checked.length + ' selected';
        }
      }

      panel.querySelectorAll('input[type=checkbox]').forEach(function (cb) {
        cb.addEventListener('change', updateLabel);
      });
      updateLabel();
    }

    document.querySelectorAll('.ms').forEach(setupMultiDropdown);
  })();
</script>


<script>
  (function () {
    // --- Simple checkbox controls: enable/disable their text inputs
    function toggleTarget(chk) {
      var tgtId = chk.getAttribute('data-target');
      if (!tgtId) return;
      var input = document.getElementById(tgtId);
      if (!input) return;
      input.disabled = !chk.checked;
      if (chk.checked) { try { input.focus(); } catch (e) {} }
    }
    document.querySelectorAll('.rc-chk').forEach(function (chk) {
      chk.addEventListener('change', function () { toggleTarget(chk); });
      toggleTarget(chk);
    });

    // --- Yes/No pairs (QuestionReadCode): mutually exclusive; optional text enabled by YES
    function handleYesNoChange(el) {
      var pairId = el.getAttribute('data-pair');
      if (pairId) {
        var other = document.getElementById(pairId);
        if (other && el.checked) other.checked = false;
      }
      // if there is a sibling text input, enable only when YES is checked
      var row = el.closest('.rc-row');
      if (!row) return;
      var yes = row.querySelector('input.rc-yesno[id$="_yes"]');
      var text = row.querySelector('input[type="text"]');
      if (text) {
        text.disabled = !(yes && yes.checked);
      }
    }
    document.querySelectorAll('.rc-yesno').forEach(function (el) {
      el.addEventListener('change', function () { handleYesNoChange(el); });
      handleYesNoChange(el); // init
    });

    // --- Hover tooltip for readcode-host (decodes \u000A)
    var tip = document.createElement('div');
    Object.assign(tip.style, {
      position: 'fixed', zIndex: '2000', display: 'none', pointerEvents: 'none',
      background: 'rgba(0,0,0,0.8)', color: '#fff', padding: '6px 8px',
      borderRadius: '4px', font: '12px/1.3 Tahoma, Arial, sans-serif',
      maxWidth: '360px', whiteSpace: 'pre-wrap', boxShadow: '0 2px 8px rgba(0,0,0,.25)'
    });
    document.body.appendChild(tip);
    function decodeEscapes(s) {
      if (!s) return '';
      try { return JSON.parse('"' + s.replace(/"/g, '\\"') + '"'); }
      catch (e) { return s.replace(/\\u000A/gi, '\n').replace(/\\n/g, '\n'); }
    }
    function showTip(e, text) {
      if (!text) return;
      tip.textContent = decodeEscapes(text);
      tip.style.display = 'block';
      position(e);
    }
    function hideTip() { tip.style.display = 'none'; }
    function position(e) {
      var x = e.clientX + 12, y = e.clientY + 12;
      var rect = tip.getBoundingClientRect();
      if (x + rect.width > window.innerWidth - 8) x = window.innerWidth - rect.width - 8;
      if (y + rect.height > window.innerHeight - 8) y = window.innerHeight - rect.height - 8;
      tip.style.left = x + 'px'; tip.style.top = y + 'px';
    }
    document.querySelectorAll('.readcode-host').forEach(function (el) {
      var data = el.getAttribute('data-readcodes');
      if (!data) return;
      el.addEventListener('mouseenter', function (e) { showTip(e, data); });
      el.addEventListener('mousemove', position);
      el.addEventListener('mouseleave', hideTip);
      el.addEventListener('scroll', hideTip, true);
    });
  })();
</script>

<script>
  (function () {
  function num(v){ var x=parseFloat(String(v||'').replace(/[^0-9.]/g,'')); return isNaN(x)?null:x; }
  function findValueByReadCode(code) {
    const host = document.querySelector(`.readcode-host[data-readcodes^="${code}"]`);
    if (!host) return null;
    return host.querySelector('.rc-value') || host.querySelector('input[type="number"], input[type="text"]');
  }
  function recalcDerived(){
    const hInput = findValueByReadCode('229..'); // O/E - height
    const wInput = findValueByReadCode('22A..'); // O/E - weight
    var hcm = hInput ? num(hInput.value) : null;
    var wkg = wInput ? num(wInput.value) : null;
    var hm = (hcm!=null) ? (hcm/100) : null;
    var age = 30; // assumed (male)

    document.querySelectorAll('.rc-row').forEach(function(row){
      var lab = row.querySelector('label'); if(!lab) return;
      var out = row.querySelector('input[id$="_value"][name$="_value"]'); if(!out) return;
      var t = lab.textContent.trim().toLowerCase();
      if (t === 'ideal weight'){
        if (hm!=null){ out.value = Math.round(22 * hm * hm); }  // BMI 22 target
      } else if (t === 'bmi'){
        if (hm!=null && wkg!=null){ out.value = (wkg / (hm*hm)).toFixed(1); }
      } else if (t === 'predicted pefr' || t.includes('peak flow')){
        if (hm != null){
          var lmin = (((hm * 5.48) + 1.58) - (age * 0.041)) * 60;
          if (lmin < 0) lmin = 0;
          out.value = Math.round(lmin);
        }
      }
    });
  }
  ['input','change'].forEach(function(ev){
    document.addEventListener(ev, function(e){
      if (e.target && e.target.matches('.rc-row input[type="text"], .rc-row input[type="number"]')) {
        recalcDerived();
      }
    });
  });
  window.addEventListener('DOMContentLoaded', recalcDerived);
  })();
</script>


<script>
  (function () {
  // Decode \u000A etc.
  function decodeEscapes(s) {
    if (!s) return '';
    try { return JSON.parse('"' + s.replace(/"/g, '\\"') + '"'); }
    catch(e) { return s.replace(/\\u000A/gi, '\n').replace(/\\n/g, '\n'); }
  }

  var sidebar = document.querySelector('aside');
  if (!sidebar) return;

  var h3 = sidebar.querySelector('h3');    // "Data Entry Read codes in form"
  var h4 = sidebar.querySelector('h4');    // "Diary entry codes"

  // Return {ul, noneP} where noneP is the "None detected." <p> if present
  function getSection(afterHeader) {
    var sib = afterHeader ? afterHeader.nextElementSibling : null;
    var noneP = null, ul = null;

    if (sib && sib.tagName === 'UL') {
      ul = sib;
    } else if (sib && sib.tagName === 'P') {
      // keep a ref so we can remove it if we add items
      noneP = sib;
    }

    // Ensure we have a UL; if not, create it just after the header (and before/replace the <p>)
    if (!ul) {
      ul = document.createElement('ul');
      ul.style.margin = '0 0 12px';
      ul.style.paddingLeft = '18px';
      ul.style.color = ''; // inherit default (avoid grey)
      if (noneP) {
        noneP.parentNode.insertBefore(ul, noneP.nextSibling);
      } else if (afterHeader && afterHeader.parentNode) {
        afterHeader.parentNode.insertBefore(ul, afterHeader.nextSibling);
      }
    } else {
      // make sure list uses normal color (not inherited grey)
      ul.style.color = '';
    }

    return { ul: ul, noneP: noneP };
  }

  var allSec   = getSection(h3);
  var diarySec = getSection(h4);

  function collectExistingCodes(ul) {
    var set = new Set();
    ul.querySelectorAll('li > code').forEach(function (c) {
      set.add((c.textContent || '').trim());
    });
    return set;
  }

  var seenAll   = collectExistingCodes(allSec.ul);
  var seenDiary = collectExistingCodes(diarySec.ul);

  var addedAll = 0, addedDiary = 0;

  document.querySelectorAll('.readcode-host').forEach(function (el) {
    var blob = el.getAttribute('data-readcodes');
    if (!blob) return;

    var isDiary = el.getAttribute('data-diary') === '1' ||
                  el.classList.contains('tpl-lastentry');

    var raw = decodeEscapes(blob);
      // NEW: harvest auto text (first one found per host)
      var autoTextMatch = raw.split(/\r?\n/).find(function(line){
        return /^\s*Auto-Entered Text\s*:/.test(line);
      });
      var autoText = '';
      if (autoTextMatch){
        autoText = autoTextMatch.replace(/^\s*Auto-Entered Text\s*:\s*/,'').trim();
        if (autoText) autoText = 'Auto-Entered Text: ' + autoText;
      }

      raw.split(/\r?\n/).forEach(function (line) {
        line = line.trim();
        if (!line) return;

        // skip the auto-text line itself (we attach it as tooltip for the code)
        if (/^\s*Auto-Entered Text\s*:/.test(line)) return;

        var m = line.split('—');
        var code  = (m[0] || '').trim();
        var label = (m.slice(1).join('—') || '').trim();
        if (!code) return;

        var ul   = isDiary ? diarySec.ul : allSec.ul;
        var seen = isDiary ? seenDiary : seenAll;

        if (seen.has(code)) {
          // Attach Auto-Entered Text to the existing LI for this code (if any)
          var listEl = isDiary ? diarySec.ul : allSec.ul;
          var existing = Array.from(listEl.querySelectorAll('li')).find(function(li){
            var cEl = li.querySelector('code');
            return cEl && (cEl.textContent || '').trim() === code;
          });
          if (existing && autoText && !existing.dataset.autotext) {
            existing.dataset.autotext = autoText;
          }
          return;
        }

        var li = document.createElement('li');
        li.className = 'rc-row';
        li.setAttribute('data-read-code', code);
        if (autoText) li.dataset.autotext = autoText;      // ← store for tooltip

        var c  = document.createElement('code');
        c.className = 'rc-code';
        c.textContent = code;
        li.appendChild(c);
        if (label) {
          var spanLbl = document.createElement('span');
          spanLbl.className = 'rc-label';
          spanLbl.textContent = ' — ' + label;
          li.appendChild(spanLbl);
        }

        // decision badge placeholder
        var b = document.createElement('span');
        b.className = 'rc-decision badge badge--pending';
        b.textContent = 'checking…';
        li.appendChild(b);

        ul.appendChild(li);
        seen.add(code);

        if (isDiary) addedDiary++; else addedAll++;
      });
    });

    if (addedAll && allSec.noneP) allSec.noneP.remove();
    if (addedDiary && diarySec.noneP) diarySec.noneP.remove();
})();
</script>

<script>
(function () {
  function extractDenom(text) {
    var m = String(text || '').match(/6\/(\d+(?:\.\d+)?)/);
    if (m) return parseFloat(m[1]);
    // non-numeric descriptions => treat as worst category for U
    if (/counts\s*fingers|hand\s*movements|perceives\s*light|blind/i.test(String(text))) {
      return Infinity; // funnels to worst branch in U logic (→ 8)
    }
    return null;
  }

  // Uncorrected (U) extended:
  // 6/4,6/5,6/6=1; 6/7.5,6/9=2; 6/12=3; 6/15,6/18=4; 6/24=5; 6/36=6; 6/48,6/60=7; else 8
  function scoreU(d) {
    if (d == null) return '';
    if (d <= 6) return 1;
    if (d === 7.5 || d === 9) return 2;
    if (d === 12) return 3;
    if (d === 15 || d === 18) return 4;
    if (d === 24) return 5;
    if (d === 36) return 6;
    if (d === 48 || d === 60) return 7;
    if (!isFinite(d)) return 8; // CF/HM/PL/Blind
    return 8;
  }

  // Corrected (C) extended:
  // 6/4,6/5,6/6=1; 6/9=2; 6/12=3; 6/15,6/18=4; 6/24=5; 6/36=6; 6/60=7
  function scoreC(d) {
    if (d == null) return '';
    if (d <= 6) return 1;
    if (d === 9)  return 2;
    if (d === 12) return 3;
    if (d === 15 || d === 18) return 4;
    if (d === 24) return 5;
    if (d === 36) return 6;
    if (d === 60) return 7;
    return '';
  }

  function selectedText(sel) {
    return (sel && sel.options && sel.selectedIndex >= 0)
      ? sel.options[sel.selectedIndex].text
      : (sel ? sel.value : '');
  }

  function updateWidget(widget) {
    var rU = widget.querySelector('select[name$="_right_uncorr"]');
    var lU = widget.querySelector('select[name$="_left_uncorr"]');
    var rC = widget.querySelector('select[name$="_right_corr"]');
    var lC = widget.querySelector('select[name$="_left_corr"]');

    var out_rU = widget.querySelector('input[name$="_right_U"]');
    var out_lU = widget.querySelector('input[name$="_left_U"]');
    var out_rC = widget.querySelector('input[name$="_right_C"]');
    var out_lC = widget.querySelector('input[name$="_left_C"]');

    if (rU && out_rU) out_rU.value = scoreU(extractDenom(selectedText(rU))) || '';
    if (lU && out_lU) out_lU.value = scoreU(extractDenom(selectedText(lU))) || '';
    if (rC && out_rC) out_rC.value = scoreC(extractDenom(selectedText(rC))) || '';
    if (lC && out_lC) out_lC.value = scoreC(extractDenom(selectedText(lC))) || '';
  }

  document.querySelectorAll('.visual-acuity-widget').forEach(function (widget) {
    widget.querySelectorAll('select[name$="_uncorr"], select[name$="_corr"]').forEach(function (sel) {
      sel.addEventListener('change', function () { updateWidget(widget); });
    });
    updateWidget(widget); // init
  });
})();
</script>

<script>  
  (function(){
  // ---------- constants ----------
  const FREQS = ["500","1000","2000","3000","4000","6000","8000"];
  const Y_MIN = -20, Y_MAX = 130, STEP = 10;
  const PAD_X = 6, PAD_Y = 4; // inner pad so endpoints don't clip

  // ---------- mapping helpers ----------
  function xAt(index, w){ return PAD_X + (index/(FREQS.length-1)) * (w - 2*PAD_X); }
  function yAt(db, h){
    const t = (db - Y_MIN) / (Y_MAX - Y_MIN); // -20(top) .. 130(bottom)
    return PAD_Y + t * (h - 2*PAD_Y);
  }
  const toNum = v => {
    const n = parseFloat((v||'').toString().replace(/[^0-9.-]/g,''));
    return isNaN(n) ? 0 : n;
  };

  // ---------- canvas placement (aligned to your plot-pane gutters) ----------
  function ensureCanvas(frameEl, id){
    let cvs = frameEl.querySelector('canvas#'+id);
    if (!cvs) {
      cvs = document.createElement('canvas');
      cvs.id = id;
      Object.assign(cvs.style, {
        position: 'absolute',
        left: '56px',   // left gutter (y-labels)
        top: '12px',    // top gutter
        right: '110px', // right gutter (legend)
        bottom: '42px', // bottom gutter (x-labels)
        zIndex: '1',
        pointerEvents: 'none'
      });
      frameEl.style.position = 'relative';
      frameEl.appendChild(cvs);
    }
    const plotW = frameEl.clientWidth  - (56 + 110);
    const plotH = frameEl.clientHeight - (12 + 42);
    if (cvs.width !== plotW || cvs.height !== plotH) {
      cvs.width  = plotW;
      cvs.height = plotH;
    }
    return cvs.getContext('2d');
  }

  // ---------- axis label layers (DOM, positioned in gutters) ----------
  function ensureAxisLayers(frameEl){
    let yTicks = frameEl.querySelector('.y-ticks');
    let xTicks = frameEl.querySelector('.x-ticks');
    if (!yTicks) {
      yTicks = document.createElement('div');
      yTicks.className = 'y-ticks';
      Object.assign(yTicks.style, {
        position:'absolute', left:'6px', top:'12px', bottom:'42px',
        width:'48px', font:'11px Tahoma, Arial, sans-serif', color:'#333',
        lineHeight:'1', textAlign:'right', pointerEvents:'none'
      });
      frameEl.appendChild(yTicks);
    }
    if (!xTicks) {
      xTicks = document.createElement('div');
      xTicks.className = 'x-ticks';
      Object.assign(xTicks.style, {
        position:'absolute', left:'56px', right:'110px', bottom:'6px',
        height:'18px', font:'11px Tahoma, Arial, sans-serif', color:'#333',
        lineHeight:'1', pointerEvents:'none'
      });
      frameEl.appendChild(xTicks);
    }
    return { yTicks, xTicks };
  }

  function renderAxisLabels(frameEl, ctx){
    const { yTicks, xTicks } = ensureAxisLayers(frameEl);
    const w = ctx.canvas.width, h = ctx.canvas.height;

    // Y labels: -10, 0, 10, ... 120
    yTicks.innerHTML = '';
    for (let yv = -10; yv <= 120; yv += 10) {
      const y = yAt(yv, h); // relative inside canvas
      const tick = document.createElement('div');
      Object.assign(tick.style, {
        position:'absolute',
        top: (12 + y - 18) + 'px', // 12px top gutter + y; center vertically ~6px
        right:'0'
      });
      tick.textContent = (yv === 0 ? '0' : String(yv));
      yTicks.appendChild(tick);
    }

    // X labels at each frequency
    xTicks.innerHTML = '';
    FREQS.forEach((f, i)=>{
      const x = xAt(i, w);
      const tick = document.createElement('div');
      Object.assign(tick.style, {
        position:'absolute',
        left: (x - 16) + 'px', // 56px left gutter + x, center ~32px width
        width:'34px',
        textAlign:'center',
        top: '-10px'
      });
      tick.textContent = f;
      xTicks.appendChild(tick);
    });
  }

  // ---------- grid (no labels; labels are DOM) ----------
  function drawGrid(ctx, w, h){
    ctx.clearRect(0,0,w,h);
    ctx.save();
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 1;

    // verticals
    for (let i=0; i<FREQS.length; i++){
      const x = xAt(i, w);
      ctx.beginPath(); ctx.moveTo(x, PAD_Y); ctx.lineTo(x, h - PAD_Y); ctx.stroke();
    }
    // horizontals every 10 dB
    for (let yv = Y_MIN; yv <= Y_MAX; yv += STEP){
      const y = yAt(yv, h);
      ctx.beginPath(); ctx.moveTo(PAD_X, y); ctx.lineTo(w - PAD_X, y); ctx.stroke();
    }
    ctx.restore();
  }

  // ---------- plotting ----------
  function plotRight(ctx, w, h, arr){
    ctx.save();
    ctx.strokeStyle = '#d00';
    ctx.fillStyle = '#d00';
    ctx.lineWidth = 1.25;
    for (let i=0; i<FREQS.length; i++){
      const x = xAt(i, w), y = yAt(arr[i]||0, h);
      ctx.beginPath(); ctx.arc(x, y, 3.2, 0, Math.PI*2); ctx.fill();
      if (i>0){
        const px = xAt(i-1, w), py = yAt(arr[i-1]||0, h);
        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(x, y); ctx.stroke();
      }
    }
    ctx.restore();
  }
  function plotLeft(ctx, w, h, arr){
    ctx.save();
    ctx.strokeStyle = '#06c';
    ctx.lineWidth = 1.25;
    const r = 4;
    for (let i=0; i<FREQS.length; i++){
      const x = xAt(i, w), y = yAt(arr[i]||0, h);
      ctx.beginPath();
      ctx.moveTo(x - r, y - r); ctx.lineTo(x + r, y + r);
      ctx.moveTo(x - r, y + r); ctx.lineTo(x + r, y - r);
      ctx.stroke();
      if (i>0){
        const px = xAt(i-1, w), py = yAt(arr[i-1]||0, h);
        ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(x, y); ctx.stroke();
      }
    }
    ctx.restore();
  }
  function drawAudiogram(ctx, rightVals, leftVals){
    const w = ctx.canvas.width, h = ctx.canvas.height;
    drawGrid(ctx, w, h);
    plotRight(ctx, w, h, rightVals);
    plotLeft(ctx,  w, h, leftVals);
  }

  // ---------- value readers ----------
  function readEntryWidgetValues(widgetEl){
    function getFor(side){
      return FREQS.map(f=>{
        const el = widgetEl.querySelector(`input[name$="_${side}_${f}"]`);
        return toNum(el ? el.value : 0);
      });
    }
    return { right: getFor('r'), left: getFor('l') };
  }
  function readComparePanelValues(containerEl, which){ // 'a1' or 'a2'
    function seq(side){
      return FREQS.map((_, idx)=>{
        const el = containerEl.querySelector(`input[name$="_${which}_${side}${idx+1}"]`);
        return toNum(el ? el.value : 0);
      });
    }
    return { right: seq('r'), left: seq('l') };
  }

  // ---------- mount: audiometry entry ----------
  document.querySelectorAll('.audiometry-widget').forEach(widget=>{
    const frame = widget.querySelector('div[style*="left:140px"][style*="top:40px"]') || widget.querySelector('div');
    if (!frame) return;
    const ctx = ensureCanvas(frame, 'canvas_entry');
    renderAxisLabels(frame, ctx);

    function redraw(){
      const {right, left} = readEntryWidgetValues(widget);
      drawAudiogram(ctx, right, left);
      renderAxisLabels(frame, ctx); // keep aligned on resize
    }
    widget.querySelectorAll('input[type="text"]').forEach(inp=>{
      inp.addEventListener('input', redraw);
      inp.addEventListener('change', redraw);
    });
    redraw();
    // optional: re-render labels on window resize
    window.addEventListener('resize', ()=>renderAxisLabels(frame, ctx));
  });

  // ---------- mount: audio comparison ----------
  document.querySelectorAll('.audio-compare-widget').forEach(widget=>{
    const frames = widget.querySelectorAll('div[style*="width:432px"][style*="height:370px"]');
    const leftChartFrame  = frames[0];
    const rightChartFrame = frames[1];
    if (!leftChartFrame || !rightChartFrame) return;

    const ctxL = ensureCanvas(leftChartFrame,  'canvas_cmp_left');
    const ctxR = ensureCanvas(rightChartFrame, 'canvas_cmp_right');
    renderAxisLabels(leftChartFrame,  ctxL);
    renderAxisLabels(rightChartFrame, ctxR);

    const leftPanel  = widget.querySelector('fieldset:nth-of-type(1)');
    const rightPanel = widget.querySelector('fieldset:nth-of-type(2)');

    function redrawCompare(){
      const a1 = readComparePanelValues(leftPanel,  'a1');
      const a2 = readComparePanelValues(rightPanel, 'a2');
      drawAudiogram(ctxL, a1.right, a1.left);
      drawAudiogram(ctxR, a2.right, a2.left);
      renderAxisLabels(leftChartFrame,  ctxL);
      renderAxisLabels(rightChartFrame, ctxR);
    }
    widget.querySelectorAll('input[type="text"]').forEach(inp=>{
      inp.addEventListener('input', redrawCompare);
      inp.addEventListener('change', redrawCompare);
    });
    redrawCompare();
    window.addEventListener('resize', ()=>{
      renderAxisLabels(leftChartFrame,  ctxL);
      renderAxisLabels(rightChartFrame, ctxR);
    });
  });

})();
</script>



<script>
  (function () {
  // thresholds as per H-grade rules
  function getLowH(sum){ return (sum > 150) ? 4 : (sum > 84) ? 3 : (sum > 45) ? 2 : 1; }
  function getHighH(sum){ return (sum > 210) ? 4 : (sum > 123) ? 3 : (sum > 45) ? 2 : 1; }
  function hToLabel(h){ return (h === 4) ? 'H4/8' : ('H' + h); }

  function num(v){
    var x = parseFloat(String(v||'').replace(/[^0-9.\-]/g,'')); 
    return isNaN(x) ? 0 : x;
  }

  // Recalculate sums & H for one audiometry widget container
  function wireAudiometry(widget){
    if(!widget) return;

    // helper to fetch input by name suffix (since {{ c.name }} is prefixed)
    function bySuffix(sfx){ return widget.querySelector('input[name$="'+sfx+'"]'); }

    // fetchers for each ear & Hz
    function getEarVals(prefix){
      return {
        v500 : num(bySuffix('_'+prefix+'_500') ?.value),
        v1k  : num(bySuffix('_'+prefix+'_1000')?.value),
        v2k  : num(bySuffix('_'+prefix+'_2000')?.value),
        v3k  : num(bySuffix('_'+prefix+'_3000')?.value),
        v4k  : num(bySuffix('_'+prefix+'_4000')?.value),
        v6k  : num(bySuffix('_'+prefix+'_6000')?.value),
        // 8k is not used in sums/H grade
      };
    }

    function setIf(el, val){ if(el){ el.value = val; } }

    function recompute(){
      var R = getEarVals('r');
      var L = getEarVals('l');

      // sums (Low: 500/1k/2k, High: 3k/4k/6k)
      var rLow  = R.v500 + R.v1k + R.v2k;
      var rHigh = R.v3k  + R.v4k + R.v6k;
      var lLow  = L.v500 + L.v1k + L.v2k;
      var lHigh = L.v3k  + L.v4k + L.v6k;

      setIf(bySuffix('_r_sum_low'),  rLow);
      setIf(bySuffix('_r_sum_high'), rHigh);
      setIf(bySuffix('_l_sum_low'),  lLow);
      setIf(bySuffix('_l_sum_high'), lHigh);

      // H grade = worse of Low/High (4 shown as H4/8)
      var rH = Math.max(getLowH(rLow),  getHighH(rHigh));
      var lH = Math.max(getLowH(lLow),  getHighH(lHigh));

      setIf(bySuffix('_r_hgrade'), hToLabel(rH));
      setIf(bySuffix('_l_hgrade'), hToLabel(lH));
    }

    // attach listeners to all freq fields we care about
    ['_r_500','_r_1000','_r_2000','_r_3000','_r_4000','_r_6000',
     '_l_500','_l_1000','_l_2000','_l_3000','_l_4000','_l_6000'
    ].forEach(function(sfx){
      var inp = bySuffix(sfx);
      if(inp){
        inp.addEventListener('input', recompute);
        inp.addEventListener('change', recompute);
      }
    });

    // initial compute
    recompute();
  }

  // wire up every Audiometry widget on the page
  window.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.audiometry-widget').forEach(wireAudiometry);
  });
})();
</script>

<script>
  (function(){
  const FREQS = ["500","1000","2000","3000","4000","6000","8000"];
  const toNum = v => {
    const n = parseFloat((v||'').toString().replace(/[^0-9.-]/g,''));
    return isNaN(n) ? 0 : n;
  };

  const normalize7 = arr =>
    (Array.isArray(arr) ? arr : []).slice(0,7).map(toNum).concat(Array(7).fill(0)).slice(0,7);

  function getOrCreateAnalysisForm(widget){
    // try widget-local first
    let form = widget.querySelector('form.analysis-form');
    if (!form) {
      form = document.createElement('form');
      form.className = 'analysis-form';
      form.target = '_blank';
      form.method = 'post';
      form.action = "{% url 'audiogram_analysis' %}";
      form.style.display = 'none';

      // clone an existing CSRF token if present on the page
      const csrfSrc = document.querySelector('input[name=csrfmiddlewaretoken]');
      if (csrfSrc) {
        const csrf = csrfSrc.cloneNode();
        csrf.value = csrfSrc.value;
        form.appendChild(csrf);
      }

      const payloadInput = document.createElement('input');
      payloadInput.type = 'hidden';
      payloadInput.name = 'payload';
      payloadInput.className = 'analysis-payload';
      form.appendChild(payloadInput);

      // attach to the widget so multiple widgets don’t clash
      widget.appendChild(form);
    }
    return form;
  }

  function collectEntryWidget(widget){
    const getSide = (side) => FREQS.map(f=>{
      const el = widget.querySelector(`input[name$="_${side}_${f}"]`);
      return toNum(el ? el.value : 0);
    });
    return { right: getSide('r'), left: getSide('l') };
  }

  function hFromLow(sum){ return (sum>150)?4:(sum>84)?3:(sum>45)?2:1; }
  function hFromHigh(sum){ return (sum>210)?4:(sum>123)?3:(sum>45)?2:1; }
  function hToStr(h){ return (h===4)?'H4/8':('H'+h); }

  function calcMetrics(ear){
    const lowIdx=[0,1,2], highIdx=[3,4,5];
    const sum = (arr, ids)=>ids.reduce((a,i)=>a+(arr[i]||0),0);
    const rLow=sum(ear.right,lowIdx), rHigh=sum(ear.right,highIdx);
    const lLow=sum(ear.left,lowIdx),  lHigh=sum(ear.left,highIdx);
    const rH=Math.max(hFromLow(rLow),hFromHigh(rHigh));
    const lH=Math.max(hFromLow(lLow),hFromHigh(lHigh));
    return {rightLow:rLow,rightHigh:rHigh,rightH:rH,rightHStr:hToStr(rH),
            leftLow:lLow,leftHigh:lHigh,leftH:lH,leftHStr:hToStr(lH)};
  }

  document.getElementById('btn-initial-analysis')?.addEventListener('click', function(){
    const widget = this.closest('.audiometry-widget');
    if (!widget) return;

    const latest = collectEntryWidget(widget);
    const latestMetrics = calcMetrics(latest);

    // TODO: replace with real previous values when available
    const PREV_RIGHT_CTX = {{ ac_1_r|default:'[]'|safe }};
    const PREV_LEFT_CTX  = {{ ac_1_l|default:'[]'|safe }};

    const previous = {
      right: normalize7(PREV_RIGHT_CTX),
      left:  normalize7(PREV_LEFT_CTX)
    };

    const payload = {
      patient:{title:'',forenames:'Mike',surname:'Pee',gender:'Male',dob:'2/11/1970',age:'54',
               serviceNo:'8008135',service:'Narmaf',nhsNo:'80081358008135',patientId:'43'},
      latest:{ date:new Date().toISOString().slice(0,10),
               age:'54', reason:'Routine Audiometry',
               right:latest.right, left:latest.left },
      previous:{ date:'2015-09-12', age:'44', reason:'Routine Audiometry',
                 right:previous.right, left:previous.left },
      metrics: latestMetrics
    };

    const form = getOrCreateAnalysisForm(widget);
    form.querySelector('.analysis-payload').value = JSON.stringify(payload);
    form.submit();
  });

  document.getElementById('btn-comp-analysis')?.addEventListener('click', function(){
    const widget = this.closest('.audio-compare-widget');
    if (!widget) return;

    const PREV_RIGHT_CTX2 = {{ ac_2_r|default:'[]'|safe }};
    const PREV_LEFT_CTX2  = {{ ac_2_l|default:'[]'|safe }};

    const latest = {
      right: normalize7(PREV_RIGHT_CTX2),
      left:  normalize7(PREV_LEFT_CTX2)
    };

    const latestMetrics = calcMetrics(latest);

    // TODO: replace with real previous values when available
    const PREV_RIGHT_CTX = {{ ac_1_r|default:'[]'|safe }};
    const PREV_LEFT_CTX  = {{ ac_1_l|default:'[]'|safe }};

    const previous = {
      right: normalize7(PREV_RIGHT_CTX),
      left:  normalize7(PREV_LEFT_CTX)
    };

    const payload = {
      patient:{title:'',forenames:'Taking',surname:'TPee',gender:'Male',dob:'2/11/1980',age:'45',
               serviceNo:'8008135',service:'Narmaf',nhsNo:'80081358008135',patientId:'42'},
      latest:{ date:'2024-05-04',
               age:'44', reason:'Routine Audiometry',
               right:latest.right, left:latest.left },
      previous:{ date:'2015-11-25', age:'35', reason:'Routine Audiometry',
                 right:previous.right, left:previous.left },
      metrics: latestMetrics
    };

    const form = getOrCreateAnalysisForm(widget);
    form.querySelector('.analysis-payload').value = JSON.stringify(payload);
    form.submit();
  });
})();
</script>

<script>
  (function(){
  const API = "{{ snowfusion_url }}/review/decisions";

  const sidebar = document.getElementById('readcodes-sidebar');
  if (!sidebar) return;

  // Collect all codes from the rendered list items (take text inside <code>)
  const items = Array.from(sidebar.querySelectorAll('ul li'));
  const codes = [...new Set(
    items.map(li => {
      let code = (li.querySelector('code')?.textContent || '').trim();
      return code.replace(/^Last Entry for\s+/i, '');
    }).filter(Boolean)
  )];

  if (!codes.length) return;

  // Ensure each <li> has a decision badge we can fill
  items.forEach(li => {
    if (!li.querySelector('.rc-decision')) {
      const badge = document.createElement('span');
      badge.className = 'rc-decision badge';
      badge.style.marginLeft = '6px';
      badge.textContent = '…';
      li.appendChild(badge);
    }
  });

  function classFor(decision){
    if (!decision) return 'badge--miss';
    const d = String(decision).toLowerCase();
    if (d.includes('dms')) return 'badge--create';
    if (d.includes('inactivate')) return 'badge--loose';
    if (d.includes('manual')) return 'badge--warn';
    if (d.includes('api') || d.includes('exact') || d.includes('auto')) return 'badge--ok';
    return 'badge--ok';
  }

  fetch(API, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ codes })
    })
    .then(r => r.ok ? r.json() : Promise.reject(r.statusText))
    .then(({ results } = { results:{} }) => {
      items.forEach(li => {
        // --- Normalise code for lookup ---
        let code = (li.querySelector('code')?.textContent || '').trim();
        const cleanCode = code.replace(/^Last Entry for\s+/i, '').trim();

        const badge = li.querySelector('.rc-decision');
        const hit = results && results[cleanCode];   // ← use cleaned code for lookup

        if (!badge) return;

        const extra = li.dataset.autotext ? `\n${li.dataset.autotext}` : '';

        if (!hit) {
          badge.textContent = '✗';
          badge.className = 'rc-decision badge badge--miss';
          badge.removeAttribute('title');
          badge.setAttribute('data-tip', `Not in SnowFusion${extra}`);
        } else {
          const decision = hit.decision || '—';
          const desc = hit.description || '';
          const info = hit.info || '';

          // Symbol selection (as before)
          let symbol = '•';
          if (decision === 'DMSCreate') symbol = '✔';
          else if (decision === 'ManualMap' || decision === 'APIMap') symbol = '↔';
          else if (decision === 'Inactivate') symbol = '✗';

          badge.textContent = symbol;
          badge.className = 'rc-decision ' + classFor(decision);

          // Tooltip: Decision • Description \n info (if present)
          const parts = [decision, desc].filter(Boolean).join(' • ');
          const tip = info ? `${parts}\n${info}` : (parts || decision);
          badge.setAttribute('data-tip', `${tip}${extra}`);
          badge.removeAttribute('title');
        }
      });
    })
    .catch(err => {
      console.error('SnowFusion lookup failed:', err);
      items.forEach(li => {
        const b = li.querySelector('.rc-decision');
        const extra = li.dataset.autotext ? `\n${li.dataset.autotext}` : '';
        if (b){ b.textContent = 'unavailable'; b.className = 'rc-decision badge badge--miss'; b.setAttribute('data-tip', `Unavailable${extra}`);}
      });
    });
  })();
</script>

<script>
  (function(){
  // Create one floating tooltip rooted at <body>
  let tip = document.getElementById('rc-tooltip');
  if(!tip){
    tip = document.createElement('div');
    tip.id = 'rc-tooltip';
    document.body.appendChild(tip);
  }

  const sidebar = document.getElementById('readcodes-sidebar');

  function positionTip(target){
    const rect = target.getBoundingClientRect();
    // Prefer right-of the badge; clamp to viewport; flip left if needed
    const pad = 8;
    // Show first to get size
    tip.style.display = 'block';
    const vw = window.innerWidth, vh = window.innerHeight;
    let left = rect.right + pad;
    let top  = rect.top + rect.height/2 - tip.offsetHeight/2;

    // Flip to left if overflowing right
    if (left + tip.offsetWidth + pad > vw){
      left = rect.left - tip.offsetWidth - pad;
    }
    // Clamp vertically
    if (top < pad) top = pad;
    const maxTop = vh - tip.offsetHeight - pad;
    if (top > maxTop) top = maxTop;

    tip.style.left = left + 'px';
    tip.style.top  = top  + 'px';
  }

  function show(target){
    const txt = target.getAttribute('data-tip') || target.title || '';
    if (!txt.trim()){ hide(); return; }
    tip.textContent = txt;   // safe: plain text
    positionTip(target);
  }
  function hide(){ tip.style.display = 'none'; }

  if (sidebar){
    // Use pointer events so it works on touchpads too
    sidebar.addEventListener('pointerenter', e=>{
      const el = e.target.closest('.rc-decision');
      if (el) show(el);
    }, true);

    sidebar.addEventListener('pointermove', e=>{
      const el = e.target.closest('.rc-decision');
      if (el) positionTip(el);
    }, true);

    sidebar.addEventListener('pointerleave', e=>{
      const el = e.target.closest('.rc-decision');
      if (el) hide();
    }, true);
  }
})();
</script>

<script>
  (function(){
    const SNOWFUSION_REVIEW_BASE =
      'https://snowfusion-d2s-uksc-medsnomed-medsno.apps.ocp1.azure.dso.digital.mod.uk/review/';

    const sidebar = document.getElementById('readcodes-sidebar');
    if (!sidebar) return;

    sidebar.addEventListener('click', (e) => {
      const badge = e.target.closest('.rc-decision');
      if (!badge) return;

      const row = badge.closest('.rc-row');
      let code = row?.getAttribute('data-read-code') || '';
      // Strip leading “Last Entry for ” if present
      code = code.replace(/^Last Entry for\s+/i, '').trim();
      if (!code) return;

      window.open(SNOWFUSION_REVIEW_BASE + encodeURIComponent(code), '_blank', 'noopener');
    });
  })();
</script>

<script>
  (function(){
    const sidebar = document.getElementById('readcodes-sidebar');
    if (!sidebar) return;

    // ---- utils ------------------------------------------------------------
    function normalizeCode(s){
      return (s || '')
        .replace(/^Last Entry for\s+/i, '')
        .replace(/[^A-Z0-9./-]/g, '');
    }

    function extractCodeToken(s){
      const left = String(s || '')
        .replace(/^Last Entry for\s+/i, '')
        .split('—')[0]
        .split(' - ')[0];
      const m = left.match(/^(?:UNCERTAIN-|NEGATION-)?[A-Z0-9]+(?:[./][A-Z0-9]+)?\.{0,10}/i);
      return m ? normalizeCode(m[0]) : '';
    }

    function parseCodesFromHostAttr(el){
      let raw = el.getAttribute('data-readcodes') || '';
      raw = raw.replace(/\\u000A/gi, '\n').replace(/&mdash;|&#8212;/gi, '—');
      return raw
        .split(/[\n\r,;|\t]+/g)
        .map(extractCodeToken)
        .filter(Boolean);
    }

    // Return all codes associated with an element:
    // - data-readcodes / data-rc-code / data-rc-codes on the element
    // - any child element with those attributes
    // - any OPTION values inside SELECTs
    function getCodesOn(el){
      const out = new Set();

      const add = (c) => { const t = normalizeCode(c); if (t) out.add(t); };
      const pullFrom = (node) => {
        if (node.hasAttribute && node.hasAttribute('data-readcodes')) {
          parseCodesFromHostAttr(node).forEach(add);
        }
        const single = node.getAttribute && node.getAttribute('data-rc-code');
        if (single) add(single);
        const multi = node.getAttribute && node.getAttribute('data-rc-codes');
        if (multi) multi.split(/[\s,;|]+/).forEach(add);
      };

      // self
      pullFrom(el);

      // descendants with metadata
      el.querySelectorAll?.('[data-readcodes],[data-rc-code],[data-rc-codes]').forEach(pullFrom);

      // all OPTION values under this element (covers read lists)
      el.querySelectorAll?.('option').forEach(opt => {
        if (opt.value) add(opt.value);
        // Some lists embed code in text too, keep it conservative
      });

      return Array.from(out);
    }

    function getCodesOn2(el){
      const out = new Set();
      const add = (c) => { const t = normalizeCode(c); if (t) out.add(t); };

      // codes on *this* element
      if (el.hasAttribute?.('data-readcodes')) {
        parseCodesFromHostAttr(el).forEach(add);
      }
      const single = el.getAttribute?.('data-rc-code');
      if (single) add(single);

      const multi = el.getAttribute?.('data-rc-codes');
      if (multi) multi.split(/[\s,;|]+/).forEach(add);

      // if this is a SELECT, allow codes coming from its OPTION values
      if (el.matches?.('select')) {
        el.querySelectorAll('option').forEach(opt => { if (opt.value) add(opt.value); });
      }

      return Array.from(out);
    }

    // Prefer exact matches; only if none, fall back to base (strip NEGATION-/UNCERTAIN-)
    function findHostsFor(code){
      const needle = normalizeCode(code);
      if (!needle) return [];

      const baseNeedle = needle.replace(/^(NEGATION-|UNCERTAIN-)/, '');

      // Candidate containers: anything that might hold read-code metadata or inputs
      const candidates = document.querySelectorAll(
        '.readcode-host,[data-readcodes],[data-rc-code],[data-rc-codes],select,input,textarea,label'
      );

      const exact = [];
      const loose = [];

      candidates.forEach(el => {
        const codes = getCodesOn2(el);
        if (!codes.length) return;

        // If a specific OPTION holds the code, highlight the SELECT (options can't be styled consistently)
        const isSelectChildExact =
          el.matches('select') &&
          Array.from(el.querySelectorAll('option')).some(o => normalizeCode(o.value) === needle);

        const isSelectChildLoose =
          baseNeedle !== needle &&
          el.matches('select') &&
          Array.from(el.querySelectorAll('option')).some(o => normalizeCode(o.value) === baseNeedle);

        if (codes.includes(needle) || isSelectChildExact) {
          exact.push(el.matches('option') ? el.closest('select') || el : el);
        } else if (baseNeedle && (codes.includes(baseNeedle) || isSelectChildLoose)) {
          loose.push(el.matches('option') ? el.closest('select') || el : el);
        }
      });

      // De-dup keeps DOM order
      const dedup = (arr) => Array.from(new Set(arr));
      return exact.length ? dedup(exact) : dedup(loose);
    }

    let current = [];
    function clearHighlight(){
      current.forEach(el => el.classList.remove('readcode-highlight'));
      current = [];
    }

    // Use mouseenter/mouseleave on each row to avoid flicker/clipping issues
    sidebar.querySelectorAll('.rc-row').forEach(row => {
      row.addEventListener('mouseenter', (e) => {
        if (e.target.closest('.rc-decision')) return; // ignore icon hover
        const code = row.getAttribute('data-read-code');
        const targets = findHostsFor(code);
        clearHighlight();
        targets.forEach(el => el.classList.add('readcode-highlight'));
        current = targets;
      });
      row.addEventListener('mouseleave', () => {
        clearHighlight();
      });
    });
  })();
</script>

<script>
  (function(){
    // Source data from the view
    const LIB = {{ tex_library_index_json|safe }};

    // Elements
    const paneList   = document.getElementById('lib-pane-list');
    const paneSearch = document.getElementById('lib-pane-search');
    const paneTree   = document.getElementById('lib-pane-tree');
    const modeRadios = document.querySelectorAll('input[name="libmode"]');

    // Existing <select> for POST
    const selectList = paneList.querySelector('select');

    // NEW: universal selected label
    const selectedLabel = document.getElementById('selected-tex-label');

    // NEW: keep refs to highlight the selected row in search/tree
    let lastSearchRow = null;
    let lastTreeRow = null;

    // Helper: set the visible “selected” text
    function setSelectedText(filename){
      if (!selectedLabel) return;
      if (!filename) {
        selectedLabel.textContent = 'no tex file selected';
        return;
      }
      selectedLabel.textContent = filename;
    }

    // Helper: set selected file (syncs the real select so POST keeps working)
    function chooseFile(filename, opts = {}){
      if (!filename) return;

      // update native select (list mode)
      if (selectList) {
        selectList.value = filename;
        if (selectList.value !== filename) {
          const opt = document.createElement('option');
          opt.value = filename;
          opt.textContent = filename.replace(/\.tex$/i,'').replace(/_/g,' ');
          opt.selected = true;
          selectList.appendChild(opt);
        }
      }

      // update universal label
      setSelectedText(filename);

      // update visual selection in search/tree (if provided)
      if (opts.searchRow) {
        if (lastSearchRow) lastSearchRow.classList.remove('lib-selected');
        opts.searchRow.classList.add('lib-selected');
        lastSearchRow = opts.searchRow;
      }
      if (opts.treeRow) {
        if (lastTreeRow) lastTreeRow.classList.remove('lib-selected');
        opts.treeRow.classList.add('lib-selected');
        lastTreeRow = opts.treeRow;
      }
    }

    // ---------- Mode switching ----------
    function show(mode){
      paneList.style.display   = (mode === 'list')   ? '' : 'none';
      paneSearch.style.display = (mode === 'search') ? '' : 'none';
      paneTree.style.display   = (mode === 'tree')   ? '' : 'none';
    }
    modeRadios.forEach(r => r.addEventListener('change', () => show(r.value)));
    show('{{ libmode|default:"list" }}');

    // ---------- Search mode ----------
    const qInput = document.getElementById('lib-search-input');
    const results = document.getElementById('lib-search-results');

    function renderSearch(list){
      results.innerHTML = '';
      if (!list.length){
        results.textContent = 'No matches.';
        return;
      }
      list.forEach(item => {
        const row = document.createElement('div');
        row.style.padding = '6px 8px';
        row.style.cursor = 'pointer';
        row.style.borderBottom = '1px solid #eee';
        row.innerHTML = `<div><strong>${item.label}</strong></div>
                        <div style="font-size:10px; color:#666;">${item.targetpath || '(no folder)'}</div>`;
        row.addEventListener('click', () => chooseFile(item.filename, { searchRow: row }));
        results.appendChild(row);
      });
    }

    function filterLocal(q){
      const s = q.trim().toLowerCase();
      if (!s) return LIB.slice(0, 200);
      return LIB.filter(d =>
        d.label.toLowerCase().includes(s) ||
        d.filename.toLowerCase().includes(s) ||
        (d.targetpath || '').toLowerCase().includes(s)
      );
    }

    let t;
    qInput.addEventListener('input', () => {
      clearTimeout(t);
      t = setTimeout(() => renderSearch(filterLocal(qInput.value)), 120);
    });
    renderSearch(LIB.slice(0, 50));

    // ---------- Tree mode ----------
    (function(){
      // simple storage helpers
      const LS_EXPANDED = 'texlib.tree.expanded';
      const LS_SCROLL   = 'texlib.tree.scroll';
      const expandedSet = new Set(JSON.parse(localStorage.getItem(LS_EXPANDED) || '[]'));
      const saveExpanded = () =>
        localStorage.setItem(LS_EXPANDED, JSON.stringify(Array.from(expandedSet)));

      function buildTree(items){
        const root = {};
        items.forEach(it => {
          const parts = Array.isArray(it.parts) ? it.parts : [];
          let node = root;
          parts.forEach(seg => {
            node.children = node.children || {};
            node.children[seg] = node.children[seg] || {};
            node = node.children[seg];
          });
          node.files = node.files || [];
          node.files.push(it);
        });
        return root;
      }

      // pathKey is used to remember which folders are open
      function pathKey(pathArr){ return pathArr.join(' / '); }

      // Recursively render a node. `path` is an array of folder names to here.
      function renderNode(node, name, path){
        const el = document.createElement('div');
        el.style.marginLeft = '10px';

        if (name != null){
          const curPath = path.concat(name);
          const key = pathKey(curPath);

          const head = document.createElement('div');
          head.style.cursor = 'pointer';
          head.style.userSelect = 'none';
          head.style.display = 'flex';
          head.style.alignItems = 'center';
          head.style.gap = '4px';

          const arrow = document.createElement('span');
          arrow.style.display = 'inline-block';
          arrow.style.width = '14px';
          arrow.textContent = expandedSet.has(key) ? '▾' : '▸';

          const label = document.createElement('strong');
          label.textContent = name;

          head.appendChild(arrow);
          head.appendChild(label);

          const body = document.createElement('div');
          body.style.display = expandedSet.has(key) ? 'block' : 'none';
          body.style.marginTop = '4px';

          head.addEventListener('click', () => {
            const open = body.style.display !== 'none';
            if (open){
              body.style.display = 'none';
              arrow.textContent = '▸';
              expandedSet.delete(key);
            } else {
              body.style.display = 'block';
              arrow.textContent = '▾';
              expandedSet.add(key);
            }
            saveExpanded();
          });

          el.appendChild(head);
          el.appendChild(body);

          if (node.children){
            Object.keys(node.children).sort().forEach(k => {
              body.appendChild(renderNode(node.children[k], k, curPath));
            });
          }
          if (node.files){
            node.files.forEach(f => {
              const frow = document.createElement('div');
              frow.style.padding = '4px 0 4px 18px';
              frow.style.cursor = 'pointer';
              frow.textContent = f.label;
              frow.title = f.targetpath ? `${f.targetpath}/${f.filename}` : f.filename;
              frow.addEventListener('click', () => {
                // ensure all ancestors for this file are marked expanded
                for (let i = 1; i <= curPath.length; i++){
                  expandedSet.add(pathKey(curPath.slice(0,i)));
                }
                saveExpanded();
                chooseFile(f.filename, { treeRow: frow });
              });
              body.appendChild(frow);
            });
          }
        } else {
          // root
          if (node.children){
            Object.keys(node.children).sort().forEach(k => {
              el.appendChild(renderNode(node.children[k], k, []));
            });
          }
          if (node.files){
            node.files.forEach(f => {
              const frow = document.createElement('div');
              frow.style.padding = '4px 0';
              frow.style.cursor = 'pointer';
              frow.textContent = f.label;
              frow.title = f.filename;
              frow.addEventListener('click', () => chooseFile(f.filename, { treeRow: frow }));
              el.appendChild(frow);
            });
          }
        }
        return el;
      }

      const treeRoot  = buildTree(LIB);
      const treeMount = document.getElementById('lib-tree');
      treeMount.innerHTML = '';
      treeMount.appendChild(renderNode(treeRoot, null, []));

      // restore and persist scroll position within the tree flyout
      const savedScroll = parseInt(localStorage.getItem(LS_SCROLL) || '0', 10);
      if (!isNaN(savedScroll)) treeMount.scrollTop = savedScroll;

      let stTimer = null;
      treeMount.addEventListener('scroll', () => {
        clearTimeout(stTimer);
        stTimer = setTimeout(() => {
          localStorage.setItem(LS_SCROLL, String(treeMount.scrollTop));
        }, 100);
      });
    })();

    // ---------- Also watch: native list select & file uploads ----------
    if (selectList){
      selectList.addEventListener('change', () => {
        if (selectList.value) {
          setSelectedText(selectList.value);
          // clear any highlighted search/tree rows
          if (lastSearchRow) lastSearchRow.classList.remove('lib-selected');
          if (lastTreeRow)   lastTreeRow.classList.remove('lib-selected');
          lastSearchRow = lastTreeRow = null;
        } else {
          setSelectedText('');
        }
      });
    }

    // File upload: when a user picks a file, show its name in the universal label
    const fileInput = document.querySelector('input[type="file"][name="{{ form.tex_file.name }}"]') ||
                      document.querySelector('#{{ form.tex_file.id_for_label }}') ||
                      document.querySelector('input[type="file"]');
    if (fileInput){
      fileInput.addEventListener('change', () => {
        const fname = fileInput.files && fileInput.files[0] ? fileInput.files[0].name : '';
        setSelectedText(fname || '');
        // clear library selection highlights (since upload takes precedence)
        if (selectList) selectList.value = '';
        if (lastSearchRow) lastSearchRow.classList.remove('lib-selected');
        if (lastTreeRow)   lastTreeRow.classList.remove('lib-selected');
        lastSearchRow = lastTreeRow = null;
      });
    }

    // Initialize label from any preselected value
    const initial = (selectList && selectList.value) ? selectList.value : '';
    setSelectedText(initial || '');
  })();
</script>

<script>
  (function(){
  const trigger = document.getElementById('lib-trigger');
  const flyout  = document.getElementById('lib-flyout');
  const paneList   = document.getElementById('lib-pane-list');
  const paneSearch = document.getElementById('lib-pane-search');
  const paneTree   = document.getElementById('lib-pane-tree');
  const modeInputs = trigger.querySelectorAll('input[name="libmode"]');
  const modeHidden = document.getElementById('libmode-hidden');

  let hideTimer = null;

  function currentMode(){
    const checked = Array.from(modeInputs).find(i => i.checked);
    return checked ? checked.value : 'list';
  }

  // keep flyout hidden unless explicitly asked to show (hover/switch)
  function setModeUI(mode, showNow = false){
    if (modeHidden) modeHidden.value = mode;

    if (mode === 'list') {
      paneList.style.display   = '';
      flyout.style.display     = 'none';
      paneSearch.style.display = 'none';
      paneTree.style.display   = 'none';
      return;
    }

    // search/tree share the flyout; keep inline list hidden
    paneList.style.display   = 'none';
    paneSearch.style.display = (mode === 'search') ? 'block' : 'none';
    paneTree.style.display   = (mode === 'tree')   ? 'block'  : 'none';

    // only open the flyout when explicitly requested
    flyout.style.display = showNow ? 'block' : 'none';

    if (showNow && mode === 'search') {
      setTimeout(() => document.getElementById('lib-search-input')?.focus(), 0);
    }
  }

  // ---- init: keep flyout hidden after render/page-load ----
  setModeUI(modeHidden?.value || currentMode(), /*showNow*/ false);

  // switching modes via radios should open flyout immediately for search/tree
  modeInputs.forEach(r => {
    r.addEventListener('change', () => setModeUI(currentMode(), /*showNow*/ true));
  });

  // ---- Hover show/hide for the flyout (only for search/tree) ----
  function maybeShow(){
    if (currentMode() !== 'list') {
      flyout.style.display = 'block';
    }
  }
  function scheduleHide(){
    clearTimeout(hideTimer);
    hideTimer = setTimeout(() => {
      if (currentMode() !== 'list') {
        flyout.style.display = 'none';
      }
    }, 140);
  }
  function cancelHide(){ clearTimeout(hideTimer); }

  trigger.addEventListener('mouseenter', () => { cancelHide(); maybeShow(); });
  trigger.addEventListener('mouseleave', scheduleHide);
  flyout.addEventListener('mouseenter', cancelHide);
  flyout.addEventListener('mouseleave', scheduleHide);
  flyout.addEventListener('focusin',  cancelHide);
  flyout.addEventListener('focusout', scheduleHide);
})();
</script>

<script>
(function(){
  // ========================== CONFIG =========================================
  // Color-blind friendly endpoints (Okabe-Ito palette)
  const COLOR_OTHER = { r: 0x2B, g: 0x8C, b: 0xBE }; // cold blue
  const COLOR_DMS   = { r: 0xE8, g: 0x5E, b: 0x0C }; // warm orange
  //const COLOR_OTHER = { r: 0x2B, g: 0x8C, b: 0xBE }; // sky blue
  //const COLOR_DMS   = { r: 0xE8, g: 0x5E, b: 0x0C }; // bright orange
  //const COLOR_OTHER = { r: 0x00, g: 0x57, b: 0xA7 }; // #0057A7 (deep blue)
  //const COLOR_DMS   = { r: 0xE6, g: 0x8F, b: 0x00 }; // #E68F00 (orange)
  //const COLOR_DMS   = { r: 0x00, g: 0x9E, b: 0x73 }; // #009E73 (green)
  //const COLOR_DMS   == { r:0xE6, g:0x9F, b:0x00 }; // #E69F00 (orange)
  // Where to tint; fallback to body if not found
  const CANVAS = document.querySelector('.tex-work') || document.body;

  const RENDER =
    document.querySelector('.tex-work > div[style*="position:relative"]') ||
    document.querySelector('.tex-work > div') ||
    document.querySelector('.tex-work') ||
    document.body;

  // ========================== UTILS ===========================================
  function lerp(a, b, t){ return a + (b - a) * t; }
  function lerpColor(c1, c2, t){
    const r = Math.round(lerp(c1.r, c2.r, t));
    const g = Math.round(lerp(c1.g, c2.g, t));
    const b = Math.round(lerp(c1.b, c2.b, t));
    return '#' + [r,g,b].map(v => v.toString(16).padStart(2,'0')).join('');
  }
  function pct(n){ return Math.round(n * 100); }

  function txt(n){ return (n && (n.textContent || '').trim()) || ''; }

  // Parse "data-readcodes" blob (lines like "CODE — Label")
  function extractCodesFromBlob(blob){
    if (!blob) return [];
    const lines = blob.replace(/\\u000A/gi, '\n').split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const codes = [];
    for (const line of lines){
      // Skip helper lines
      if (/^\s*Auto-Entered Text\s*:/i.test(line)) continue;
      const parts = line.split('—');
      const code = (parts[0] || '').trim();
      if (code) codes.push(code);
    }
    return codes;
  }

  // ================== BUILD CODE→CATEGORY LOOKUP (from sidebar) ===============
  // Categories we care about: DMSCreate, APIMap, ManualMap, Inactivate, Other
  function classifyFromTipOrClasses(row){
    const code = (row.getAttribute('data-read-code') || '').trim();

    // Prefix-based ignore
    if (/^(NEGATION-|QUERY-)/i.test(code)) return 'Ignored';

    // Prefer decision badge classes (most robust)
    const dec = row.querySelector('.rc-decision');
    if (dec) {
      const cl = dec.classList;
      if (cl.contains('badge--create'))   return 'DMSCreate';   // ✔ DMS
      if (cl.contains('badge--loose'))    return 'Inactivate';  // ✗ inactivate
      // Some builds might have explicit classes for maps; if not, we'll use tip text below
      if (cl.contains('badge--apimap'))   return 'APIMap';
      if (cl.contains('badge--manual'))   return 'ManualMap';
      if (cl.contains('badge--miss'))     return 'Other';       // "Not in SnowFusion" etc
    }
    // Fallback: parse the tip text (e.g., "DMSCreate • …", "APIMap • …")
    const tip = dec ? (dec.getAttribute('data-tip') || '') : '';
    const head = tip.split('•')[0].trim().toLowerCase();
    if (head.includes('dmscreate')) return 'DMSCreate';
    if (head.includes('apimap'))    return 'APIMap';
    if (head.includes('manualmap')) return 'ManualMap';
    if (head.includes('inactivate'))return 'Inactivate';
    return 'Other';
  }

  function buildSidebarMap(){
    const map = new Map(); // code -> category
    // Scan ANY rc-row, not just a specific sidebar container
    const rows = document.querySelectorAll('.rc-row[data-read-code]');
    rows.forEach(row => {
      const code = row.getAttribute('data-read-code') || '';
      if (!code) return;
      map.set(code, classifyFromTipOrClasses(row));
    });
    return map;
  }

  // ===================== SCAN CONTROLS FOR CODES ==============================
  function collectCodes(){
    const seen = new Set(); // unique codes encountered
    const buckets = { DMSCreate:0, APIMap:0, ManualMap:0, Other:0, Inactivate:0 };
    const otherList = [];

    document.querySelectorAll('.rc-row[data-read-code]').forEach(row => {
      const code = (row.getAttribute('data-read-code') || '').trim();
      if (!code || seen.has(code)) return;
      seen.add(code);

      const cat = classifyFromTipOrClasses(row);
      buckets[cat] = (buckets[cat] || 0) + 1;

      if (cat === 'Other') {
        const label = (row.querySelector('.rc-label')?.textContent || '').trim();
        otherList.push(label ? `${code} — ${label}` : code);
      }
    });

    // Denominator excludes Inactivate
    const nonDms = (buckets.APIMap || 0) + (buckets.ManualMap || 0) + (buckets.Other || 0);
    const dms    = (buckets.DMSCreate || 0);
    const denom  = dms + nonDms;
    const ratio  = denom ? (dms / denom) : 0;

    // Console aid
    if (otherList.length) {
      console.log(`🟦 OTHER (${otherList.length}):`, otherList);
    } else {
      console.log('🟦 No codes classified as "Other".');
    }

    return { buckets, ratio, totalConsidered: denom, uniqueCodes: seen.size };
  }

  // ===================== APPLY HEATMAP ========================================
  function applyHeat(ratio){
    // ratio 0 -> all OTHER (blue), 1 -> all DMS (green)
    const col = lerpColor(COLOR_OTHER, COLOR_DMS, ratio);

    // Gentle background + subtle gradient for depth
    //CANVAS.style.background = `linear-gradient(180deg, ${col}1A, ${col}33)`;
    //CANVAS.style.transition = 'background 200ms ease-in-out';
    RENDER.style.background = `linear-gradient(180deg, ${col}1A, ${col}33)`;
    RENDER.style.transition = 'background 200ms ease-in-out';

    // Add an outline that strengthens with purity of either end if you like:
    // CANVAS.style.boxShadow = `inset 0 0 0 2px ${col}80`;
  }
  

  // ===================== SUMMARY PANEL ========================================
  function renderPanel(stats){
    let panel = document.getElementById('code-mix-panel');
    if (!panel){
      panel = document.createElement('div');
      panel.id = 'code-mix-panel';
      panel.style.position = 'fixed';
      panel.style.right = '10px';
      panel.style.bottom = '10px';
      panel.style.zIndex = '9999';
      panel.style.background = '#fff';
      panel.style.border = '1px solid #ddd';
      panel.style.borderRadius = '6px';
      panel.style.boxShadow = '0 2px 8px rgba(0,0,0,.15)';
      panel.style.padding = '10px 12px';
      panel.style.font = '12px/1.4 Arial, sans-serif';
      panel.style.minWidth = '260px';
      document.body.appendChild(panel);
    }

    const { buckets, ratio, totalConsidered, uniqueCodes } = stats;

    // Accessible bar
    const barOuter = `
      <div style="margin-top:8px; background:#f2f2f2; height:10px; border-radius:6px; overflow:hidden;" aria-hidden="true">
        <div style="width:${pct(ratio)}%; height:100%; background:${lerpColor(COLOR_OTHER, COLOR_DMS, ratio)};"></div>
      </div>`;

    panel.innerHTML = `
      <div style="font-weight:bold; margin-bottom:6px;">Code Mix</div>
      <div>Total unique codes: <strong>${uniqueCodes}</strong></div>
      <div>Included (DMS + non-DMS): <strong>${totalConsidered}</strong></div>
      <div style="margin-top:6px;">
        <div>DMSCreate: <strong>${buckets.DMSCreate}</strong></div>
        <div>APIMap: <strong>${buckets.APIMap}</strong></div>
        <div>ManualMap: <strong>${buckets.ManualMap}</strong></div>
        <div>Non-DMS: <strong>${buckets.Other}</strong></div>
        <div style="opacity:.7;">Inactivate/NEGATION/QUERY (ignored): ${buckets.Inactivate}</div>
      </div>
      <div style="margin-top:8px;">DMSCreate / (DMSCreate + Rest): <strong>${pct(ratio)}%</strong></div>
      ${barOuter}
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button type="button" id="cmx-apply" style="padding:4px 8px;">Apply heat-map</button>
        <button type="button" id="cmx-clear" style="padding:4px 8px;">Clear</button>
      </div>
      <div style="margin-top:6px; font-size:11px; opacity:.8;">
        Scale: <span style="color:#0072B2;">Non-DMS</span> → <span style="color:#009E73;">DMSCreate</span>
      </div>
    `;

    //panel.querySelector('#cmx-apply').onclick = () => applyHeat(ratio);
    //panel.querySelector('#cmx-clear').onclick  = () => { CANVAS.style.background = ''; };
    panel.querySelector('#cmx-apply').onclick = () => applyHeat(ratio);
    panel.querySelector('#cmx-clear').onclick  = () => { RENDER.style.background = '#fff'; };
  }

  function debounce(fn, ms){
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}
const recompute = debounce(() => {
  const stats = collectCodes();
  renderPanel(stats);
  // If you want live tinting each time:
   applyHeat(stats.ratio);
}, 150);

// ===== readiness check: wait for SnowFusion classification ====================
function isClassificationReady(){
  // We consider it "ready" when we have rc-rows AND at least one row
  // has a .rc-decision with either a known class OR a non-empty data-tip.
  const rows = document.querySelectorAll('.rc-row[data-read-code]');
  if (!rows.length) return false;
  for (const row of rows){
    const dec = row.querySelector('.rc-decision');
    if (!dec) continue;
    const hasKnownClass =
      dec.classList.contains('badge--create') ||
      dec.classList.contains('badge--loose')  ||
      dec.classList.contains('badge--apimap') ||
      dec.classList.contains('badge--manual') ||
      dec.classList.contains('badge--miss');
    const hasTip = !!(dec.getAttribute('data-tip') || '').trim();
    if (hasKnownClass || hasTip) return true;
  }
  return false;
}

function whenReadyToClassify(cb, timeoutMs=10000, pollEvery=200){
  const start = performance.now();
  (function tick(){
    if (isClassificationReady()) { cb(); return; }
    if ((performance.now() - start) >= timeoutMs) { cb(); return; } // give up gracefully
    setTimeout(tick, pollEvery);
  })();
}

// ===== observe dynamic changes (new rows or updated badges) ===================
function attachObserver(){
  const target = document.body;
  const mo = new MutationObserver(muts => {
    // If rows or their decision badges change, recompute.
    for (const m of muts){
      if (m.type === 'childList'){
        if (m.addedNodes.length || m.removedNodes.length){
          if (m.target && (m.target.closest?.('.rc-row') || m.target.id === 'readcode-list' || m.target.id === 'diarycode-list')){
            recompute();
            return;
          }
        }
      } else if (m.type === 'attributes'){
        if (m.target.matches('.rc-decision')){
          recompute();
          return;
        }
      }
    }
  });
  mo.observe(target, {
    subtree: true,
    childList: true,
    attributes: true,
    attributeFilter: ['class', 'data-tip']
  });
  return mo;
}

// ===== RUN ====================================================================
// Kick off once SnowFusion classifications are present (or after timeout).
whenReadyToClassify(() => {
  recompute();            // initial compute + render
  attachObserver();       // keep it up to date as the page changes
});

// Safety: also do a delayed one-shot in case everything was already present
setTimeout(recompute, 500);

  // Optionally auto-apply heat on load:
  // applyHeat(stats.ratio);

  // If your page content changes dynamically, you can observe and refresh:
  // const mo = new MutationObserver(() => {
  //   const s = collectCodes();
  //   renderPanel(s);
  //   // applyHeat(s.ratio);
  // });
  // mo.observe(document.body, { subtree:true, childList:true, attributes:true });
})();
</script>


<script src="{% static 'myapp/js/importTEXJs/formioExportButton.js' %}"></script>
<script src="{% static 'myapp/js/importTEXJs/openTextUIExportButton.js' %}"></script>
<script src="{% static 'myapp/js/importTEXJs/openTextExportButton.js' %}"></script>
{% endif %}
{% endblock %}