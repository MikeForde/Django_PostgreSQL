{# templates/import_tex.html #}
{% extends "base.html" %}
{% block content %}

<form method="post" enctype="multipart/form-data" style="display:flex; align-items:center;">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Render</button>
</form>

{% if controls %}
<h2>Preview</h2>
<form method="post" action="{% url 'submit_tex_form' %}">
  {% csrf_token %}
  <div style="display:flex; align-items:flex-start; gap:16px;">

  {# Canvas (left) #}
  <div
    style="position:relative; border:1px solid #ccc; width:{{ canvas.width }}px; height:{{ canvas.height }}px; font-family:sans-serif, 'MS Sans Serif', Tahoma, Arial; font-size:10.5px; line-height:1.2; background:#fff;">

    {% for c in controls %}
    {% if c.props.Visible != 'False' %}
    <div class="ctrl readcode-host"
         data-readcodes="{{ c.hover_codes|default:''|escapejs }}"
         style="position:absolute; left:{{ c.x }}px; top:{{ c.y }}px; width:{{ c.width|add:6 }}px; height:{{ c.height }}px; overflow:visible;">

      {# Labels #}
      {% if 'Label' in c.type %}
        <label style="display:block; width:{{ c.width|add:10 }}px;
                      {% if c.font_name %}font-family:{% if ' ' in c.font_name %}'{{ c.font_name }}'{% else %}{{ c.font_name }}{% endif %}, sans-serif;{% endif %}
                      {% if c.font_size_pt %}font-size:{{ c.font_size_pt }}pt;{% endif %}
                      {% if c.font_color %}color:{{ c.font_color }};{% endif %}
                      font-weight:{% if c.is_bold %}700{% else %}400{% endif %};">
          {{ c.caption|default:c.name }}
        </label>

      {# Buttons #}
      {% elif 'Button' in c.type %}
        <button type="button" name="{{ c.name }}" tabindex="{{ c.props.TabOrder|default:'0' }}" style="font-size: 9px;">
          {{ c.caption|default:c.name }}
        </button>

      {# Read lists (your existing branches) #}
      {% elif 'ReadList' in c.type %}
        <div class="rl-wrap" style="white-space:normal;">
          {% if c.caption %}
            <div style="font-weight:600; margin-bottom:-1px;">{{ c.caption }}</div>
          {% endif %}
          {% if c.rl_minimised and c.rl_multi %}
            <div class="ms" id="ms_{{ c.name }}" style="position:relative; display:inline-block; min-width:140px;">
              <button type="button" class="ms-btn" aria-haspopup="listbox" aria-expanded="false"
                      style="display:flex; align-items:center; justify-content:space-between; gap:8px; width:100%; min-width:140px; padding:0px 6px; border:1px solid #888; background:#fff; cursor:pointer; font-size: 10.5px;">
                <span class="ms-label">Select…</span><span aria-hidden="true">▾</span>
              </button>
              <div class="ms-panel"
                   style="position:absolute; top:100%; left:0; z-index:1000; display:none; border:1px solid #888; background:#fff; max-height:180px; overflow:auto; min-width:220px; padding:6px; box-shadow:0 2px 6px rgba(0,0,0,.15);">
                {% for opt in c.options %}
                  <label style="display:block; white-space:nowrap;">
                    <input type="checkbox" name="{{ c.name }}[]"
                           value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                    {{ opt.label }}
                  </label>
                {% endfor %}
              </div>
            </div>
          {% elif c.rl_minimised %}
            <select name="{{ c.name }}" id="{{ c.name }}" size="1" tabindex="{{ c.props.TabOrder|default:'0' }}" style="min-width:140px; font-size: 10.5px;">
              {% for opt in c.options %}
                <option value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                  {{ opt.label }}
                </option>
              {% endfor %}
            </select>
          {% else %}
            <select name="{{ c.name }}{% if c.rl_multi %}[]{% endif %}" id="{{ c.name }}" {% if c.rl_multi %}multiple{% endif %}
                    size="{{ c.rl_size|default:5 }}" tabindex="{{ c.props.TabOrder|default:'0' }}" style="min-width:120px; font-size: 10.5px;">
              {% for opt in c.options %}
                <option value="{% if opt.code and opt.code not in '01TrueFalse' %}{{ opt.code }}{% else %}{{ opt.label }}{% endif %}">
                  {{ opt.label }}
                </option>
              {% endfor %}
            </select>
          {% endif %}

          {% if c.rl_date_prompt %}
            <div style="margin-top:6px;">
              <label for="{{ c.name }}_date" style="margin-right:6px;">Date:</label>
              <input id="{{ c.name }}_date" name="{{ c.name }}_date" type="date" tabindex="{{ c.props.TabOrder|default:'0' }}">
            </div>
          {% endif %}
        </div>

      {# ReadCode: for TEmisReadCode and TEmisQuestionReadCode #}
      {% elif 'ReadCode' in c.type %}
      <div class="rc-row readcode-host"
        data-readcodes="{{ c.rc_code|default:'' }} — {{ c.rc_term|default:'' }}{% if c.rc_is_question and c.rc_has_negation %}\nNegation-{{ c.rc_code }} — Not - {{c.rc_term}}{% endif %}"
        style="white-space:nowrap;">


        {# Full prompt label #}
        <label for="{{ c.name }}_yes" style="display:inline; margin-right:4px;">
          {{ c.rc_prompt }}
        </label>

        {% if c.rc_is_question and c.rc_has_negation %}
          {# Yes checkbox (records original readcode) #}
          <label style="margin-left:0px; margin-right:0px;">
            <input id="{{ c.name }}_yes"
                  class="rc-yesno"
                  data-pair="{{ c.name }}_no"
                  name="{{ c.name }}_checked_yes"
                  type="checkbox"
                  value="{{ c.rc_code|default:'' }}"
                  tabindex="{{ c.props.TabOrder|default:'0' }}"
                  style="vertical-align:middle; margin-right:0px;">
          </label>

          {# No checkbox (records Negation-<readcode>) #}
          <label style="margin-right:0px;">
            no
            <input id="{{ c.name }}_no"
                  class="rc-yesno"
                  data-pair="{{ c.name }}_yes"
                  name="{{ c.name }}_checked_no"
                  type="checkbox"
                  value="{% if c.rc_code %}{{ c.rc_neg_prefix }}{{ c.rc_code }}{% endif %}"
                  tabindex="{{ c.props.TabOrder|default:'0' }}"
                  style="vertical-align:middle; margin-right:0px;">
          </label>

          {% if c.rc_has_text %}
            <input id="{{ c.name }}_text"
                  name="{{ c.name }}_text"
                  type="text"
                  {% if c.rc_required %}required{% endif %}
                  disabled
                  style="width:100px; vertical-align:middle;">
          {% endif %}

        {% else %}
          {# Simple ReadCode: single checkbox (unchanged) #}
          <input id="{{ c.name }}_chk"
            class="rc-chk"
            data-targets="{% if c.rc_has_text %}{{ c.name }}_text{% endif %}{% if c.rc_has_value %}{% if c.rc_has_text %},{% endif %}{{ c.name }}_val{% endif %}{% if c.rc_has_datepicker %}{% if c.rc_has_text or c.rc_has_value %},{% endif %}{{ c.name }}_date{% endif %}"
            name="{{ c.name }}_checked"
            type="checkbox"
            tabindex="{{ c.props.TabOrder|default:'0' }}"
            style="margin-right:8px; vertical-align:middle;">

          {% if c.rc_has_text %}
            <input id="{{ c.name }}_text"
                  name="{{ c.name }}_text"
                  type="text"
                  {% if c.rc_required %}required{% endif %}
                  disabled
                  style="width:100px; vertical-align:middle;">
          {% endif %}
        {% endif %}

        {% if c.rc_has_value %}
        <input id="{{ c.name }}_val"
              name="{{ c.name }}_val"
              type="text"
              inputmode="decimal"
              disabled
              style="width:20px; vertical-align:middle; margin-left:{% if c.rc_has_text %}4{% else %}0{% endif %}px;">
        {% if c.rc_value_unit %}<span style="margin-left:4px;">{{ c.rc_value_unit }}</span>{% endif %}
        {% endif %}

        {# Date picker (if applicable) #}
        {% if c.rc_has_datepicker %}
        <input id="{{ c.name }}_date"
              name="{{ c.name }}_date"
              type="date"
              disabled
              tabindex="{{ c.props.TabOrder|default:'0' }}"
              style="vertical-align:middle; margin-left:0px; width: 2px; font-size: 10.5px;">
        {% endif %}

        {# Hidden input to carry the readcode itself #}

        {% if c.rc_code %}
          <input type="hidden" name="{{ c.name }}_readcode" value="{{ c.rc_code }}">
        {% endif %}
      </div>



      {# DiaryEntry (unchanged) #}
      {% elif 'DiaryEntry' in c.type %}
        {# ... your existing DiaryEntry branch exactly as-is ... #}
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:nowrap; white-space:nowrap; width:100%;">
          <label for="{{ c.name }}_date" style="font-weight:600; margin-right:6px; white-space:nowrap;">
            {{ c.diary_prompt }}
          </label>
          <input id="{{ c.name }}_date" name="{{ c.name }}_date" type="date" tabindex="{{ c.props.TabOrder|default:'0' }}" style="vertical-align:middle; font-size: 10.5px;">
          {% if c.diary_editbox and not c.diary_prompt_below %}
            <input id="{{ c.name }}_text" name="{{ c.name }}_text" type="text" tabindex="{{ c.props.TabOrder|default:'0' }}"
                   {% if c.diary_editbox_chars %} style="width: {{ c.diary_editbox_chars }}ch;" {% else %} style="width: 24ch;" {% endif %}>
          {% endif %}
        </div>
        {% if c.diary_editbox and c.diary_prompt_below %}
          <div style="margin-top:4px;">
            <input id="{{ c.name }}_text" name="{{ c.name }}_text" type="text" tabindex="{{ c.props.TabOrder|default:'0' }}"
                   {% if c.diary_editbox_chars %} style="width: {{ c.diary_editbox_chars }}ch;" {% else %} style="width: 24ch;" {% endif %}>
          </div>
        {% endif %}
        {% if c.diary_readcode %}
          <input type="hidden" name="{{ c.name }}_readcode" value="{{ c.diary_readcode }}">
        {% endif %}

      {# TTplLastEntry: read-only date, no label, optional tooltip of its read code #}
      {% elif 'LastEntry' in c.type or c.is_lastentry %}
      <input
        type="date"
        class="tpl-lastentry readcode-host"
        {% if c.le_code or c.le_term %}
          data-readcodes="Last Entry for {{ c.le_code|default:'' }}{% if c.le_term %} — {{ c.le_term }}{% endif %}"
          title="{{ c.le_code|default:'' }}{% if c.le_term %} — {{ c.le_term }}{% endif %}"
        {% endif %}
        disabled
        style="width: 150px; font-size: 10.5px;">
      
      {% elif 'Panel' in c.type %}

      {% elif 'Bevel' in c.type %}

      {% elif 'FORM' in c.type %}

      {% elif 'Group' in c.type %}

      {% elif 'Btn' in c.type %}
        <button type="button" name="{{ c.name }}" tabindex="{{ c.props.TabOrder|default:'0' }}" style="font-size: 9px;">
          Prev Data
        </button>

      {# TTplAvgBP: fixed read-only average blood pressure #}
      {% elif 'AvgBP' in c.type %}
      <span class="tpl-avgbp" style="font-size: 10.5px;">
        125/85
      </span>

      {# --- TTplIdealWeight ---------------------------------------------------- #}
      {% elif 'IdealWeight' in c.type %}
      <div class="rc-row" style="white-space:nowrap;">
        <label for="{{ c.name }}_chk" style="margin-right:4px;">Ideal Weight</label>
        <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
              tabindex="{{ c.props.TabOrder|default:'0' }}"
              style="margin-right:0px; vertical-align:middle;">
        <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
              readonly style="width:20px; vertical-align:middle;">
        <span style="margin-left:2px;">kg</span>
      </div>

      {# --- TTplBMI ------------------------------------------------------------ #}
      {% elif 'BMI' in c.type %}
      <div class="rc-row" style="white-space:nowrap;">
        <label for="{{ c.name }}_chk" style="margin-right:4px;">BMI</label>
        <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
              tabindex="{{ c.props.TabOrder|default:'0' }}"
              style="margin-right:0px; vertical-align:middle;">
        <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
              readonly style="width:25px; vertical-align:middle;">
        <span style="margin-left:2px;">kg/m²</span>
      </div>

      {# --- TTplExpPeakFlow ---------------------------------------------------- #}
      {% elif 'ExpPeakFlow' in c.type %}
      <div class="rc-row" style="white-space:nowrap;">
        <label for="{{ c.name }}_chk" style="margin-right:6px;">Predicted PEFR</label>
        <input id="{{ c.name }}_chk" name="{{ c.name }}_checked" type="checkbox"
              tabindex="{{ c.props.TabOrder|default:'0' }}"
              style="margin-right:8px; vertical-align:middle;">
        <input id="{{ c.name }}_value" name="{{ c.name }}_value" type="text"
              readonly style="width:25px; vertical-align:middle;">
        <span style="margin-left:2px;">L/min</span>
      </div>
      

      {# Hyperlink #}
      {% elif 'HyperLink' in c.type %}
      <a href="{{ c.props.strURL|default:'#' }}" target="_blank" rel="noopener"
        style="display:inline-block; text-decoration:underline; cursor:pointer;">
        {{ c.props.strHyperLink|default:c.props.strNormal|default:c.name }}
      </a>

      {% else %}
      <div style="border:1px solid #000;">{{ c.type }}: {{ c.name }}</div>

      {% endif %}
    </div>
    {% endif %}
    {% endfor %}
  </div>

  {# Sidebar (right) #}
  <aside style="width:320px; max-height:{{ canvas.height }}px; overflow:auto; border:1px solid #ddd; padding:8px; background:#fafafa; font-size: 12px;">
    <h3 style="margin:0 0 8px;">Data Entry Read codes in form</h3>
    {% if all_read_codes %}
      <ul style="margin:0 0 12px; padding-left:18px;">
        {% for rc in all_read_codes %}
          <li><code>{{ rc.code }}</code> — {{ rc.label }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p style="margin:0 0 12px; color:#666;">None detected.</p>
    {% endif %}

    <h4 style="margin:0 0 8px;">Diary entry codes</h4>
    {% if diary_read_codes %}
      <ul style="margin:0; padding-left:18px;">
        {% for rc in diary_read_codes %}
          <li><code>{{ rc.code }}</code> — {{ rc.label }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p style="margin:0; color:#666;">None detected.</p>
    {% endif %}
  </aside>
</div>

</form>

<script>
  (function () {
    function toggleTargets(chk) {
      var ids = (chk.getAttribute('data-targets') || '').split(',').map(function (s) { return s.trim(); }).filter(Boolean);
      if (!ids.length) return;
      ids.forEach(function (id) {
        var el = document.getElementById(id);
        if (el) el.disabled = !chk.checked;
      });
      if (chk.checked) {
        var first = document.getElementById(ids[0]);
        if (first) { try { first.focus(); } catch (e) {} }
      }
    }
    document.querySelectorAll('.rc-chk').forEach(function (chk) {
      chk.addEventListener('change', function () { toggleTargets(chk); });
      toggleTargets(chk); // init
    });
  })();
</script>

<script>
  (function () {
    function setupMultiDropdown(ms) {
      var btn   = ms.querySelector('.ms-btn');
      var panel = ms.querySelector('.ms-panel');
      var label = ms.querySelector('.ms-label');

      function close() { panel.style.display = 'none'; btn.setAttribute('aria-expanded','false'); }
      function open()  { panel.style.display = 'block'; btn.setAttribute('aria-expanded','true'); }

      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        (panel.style.display === 'block') ? close() : open();
      });

      panel.addEventListener('click', function (e) { e.stopPropagation(); });
      document.addEventListener('click', close);

      function updateLabel() {
        var checked = panel.querySelectorAll('input[type=checkbox]:checked');
        if (checked.length === 0) label.textContent = 'Select…';
        else if (checked.length === 1) label.textContent = checked[0].closest('label').textContent.trim();
        else label.textContent = checked.length + ' selected';
      }

      panel.querySelectorAll('input[type=checkbox]').forEach(function (cb) {
        cb.addEventListener('change', updateLabel);
      });
      updateLabel();
    }

    document.querySelectorAll('.ms').forEach(setupMultiDropdown);
  })();

      // initialise TTplLastEntry dates to 1 year ago
    document.querySelectorAll('.tpl-lastentry').forEach(function (inp) {
      var d = new Date();
      d.setFullYear(d.getFullYear() - 1); // exactly one year back
      // format YYYY-MM-DD in local time
      var yyyy = d.getFullYear();
      var mm = String(d.getMonth() + 1).padStart(2, '0');
      var dd = String(d.getDate()).padStart(2, '0');
      inp.value = yyyy + '-' + mm + '-' + dd;
    });

</script>

<script>
  (function () {
    // --- Simple checkbox controls: enable/disable their text inputs
    function toggleTarget(chk) {
      var tgtId = chk.getAttribute('data-target');
      if (!tgtId) return;
      var input = document.getElementById(tgtId);
      if (!input) return;
      input.disabled = !chk.checked;
      if (chk.checked) { try { input.focus(); } catch (e) {} }
    }
    document.querySelectorAll('.rc-chk').forEach(function (chk) {
      chk.addEventListener('change', function () { toggleTarget(chk); });
      toggleTarget(chk); // init
    });

    // --- Yes/No pairs (QuestionReadCode): mutually exclusive; optional text enabled by YES
    function handleYesNoChange(el) {
      var pairId = el.getAttribute('data-pair');
      if (pairId) {
        var other = document.getElementById(pairId);
        if (other && el.checked) other.checked = false;
      }
      // if there is a sibling text input, enable only when YES is checked
      var row = el.closest('.rc-row');
      if (!row) return;
      var yes = row.querySelector('input.rc-yesno[id$="_yes"]');
      var text = row.querySelector('input[type="text"]');
      if (text) {
        text.disabled = !(yes && yes.checked);
      }
    }
    document.querySelectorAll('.rc-yesno').forEach(function (el) {
      el.addEventListener('change', function () { handleYesNoChange(el); });
      handleYesNoChange(el); // init
    });

    // --- Hover tooltip for readcode-host (decodes \u000A)
    var tip = document.createElement('div');
    Object.assign(tip.style, {
      position: 'fixed', zIndex: '2000', display: 'none', pointerEvents: 'none',
      background: 'rgba(0,0,0,0.8)', color: '#fff', padding: '6px 8px',
      borderRadius: '4px', font: '12px/1.3 Tahoma, Arial, sans-serif',
      maxWidth: '360px', whiteSpace: 'pre-wrap', boxShadow: '0 2px 8px rgba(0,0,0,.25)'
    });
    document.body.appendChild(tip);
    function decodeEscapes(s) {
      if (!s) return '';
      try { return JSON.parse('"' + s.replace(/"/g, '\\"') + '"'); }
      catch (e) { return s.replace(/\\u000A/gi, '\n').replace(/\\n/g, '\n'); }
    }
    function showTip(e, text) {
      if (!text) return;
      tip.textContent = decodeEscapes(text);
      tip.style.display = 'block';
      position(e);
    }
    function hideTip() { tip.style.display = 'none'; }
    function position(e) {
      var x = e.clientX + 12, y = e.clientY + 12;
      var rect = tip.getBoundingClientRect();
      if (x + rect.width > window.innerWidth - 8) x = window.innerWidth - rect.width - 8;
      if (y + rect.height > window.innerHeight - 8) y = window.innerHeight - rect.height - 8;
      tip.style.left = x + 'px'; tip.style.top = y + 'px';
    }
    document.querySelectorAll('.readcode-host').forEach(function (el) {
      var data = el.getAttribute('data-readcodes');
      if (!data) return;
      el.addEventListener('mouseenter', function (e) { showTip(e, data); });
      el.addEventListener('mousemove', position);
      el.addEventListener('mouseleave', hideTip);
      el.addEventListener('scroll', hideTip, true);
    });
  })();
</script>

<script>
(function () {
  function num(v){ var x=parseFloat(String(v||'').replace(/[^0-9.]/g,'')); return isNaN(x)?null:x; }
  function findValueByLabelContains(substr){
    substr = substr.toLowerCase();
    // Assume height/weight appear as ReadCode rows with a label then a value box
    var rows = Array.from(document.querySelectorAll('.rc-row'));
    for (var r of rows){
      var lab = r.querySelector('label');
      var val = r.querySelector('input[type="text"], input[type="number"]');
      if (lab && val && lab.textContent.toLowerCase().includes(substr)) return val;
    }
    return null;
  }
  function recalcDerived(){
    var hInput = findValueByLabelContains('height');
    var wInput = findValueByLabelContains('weight');
    var hcm = hInput ? num(hInput.value) : null;
    var wkg = wInput ? num(wInput.value) : null;
    var hm = (hcm!=null) ? (hcm/100) : null;
    var age = 30; // assumed (male)

    document.querySelectorAll('.rc-row').forEach(function(row){
      var lab = row.querySelector('label'); if(!lab) return;
      var out = row.querySelector('input[id$="_value"][name$="_value"]'); if(!out) return;
      var t = lab.textContent.trim().toLowerCase();
      if (t === 'ideal weight'){
        if (hm!=null){ out.value = Math.round(22 * hm * hm); }  // BMI 22 target
      } else if (t === 'bmi'){
        if (hm!=null && wkg!=null){ out.value = (wkg / (hm*hm)).toFixed(1); }
      } else if (t === 'predicted pefr' || t.includes('peak flow')){
        if (hm != null){
          var lmin = (((hm * 5.48) + 1.58) - (age * 0.041)) * 60;
          if (lmin < 0) lmin = 0;
          out.value = Math.round(lmin);
        }
      }
    });
  }
  ['input','change'].forEach(function(ev){
    document.addEventListener(ev, function(e){
      if (e.target && e.target.matches('.rc-row input[type="text"], .rc-row input[type="number"]')) {
        recalcDerived();
      }
    });
  });
  window.addEventListener('DOMContentLoaded', recalcDerived);
})();
</script>


{% endif %}
{% endblock %}